name: Fix metricReport

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    # ----------------------------------------------------
    # Setup k6 NATIVELY (NO DOCKER)
    # ----------------------------------------------------
    - name: Setup k6
      uses: grafana/setup-k6-action@v1

    # ----------------------------------------------------
    # Decide which tests to run
    # ----------------------------------------------------
    - name: Determine which tests to run
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"

        if [ "$TEST_TYPE" = "smoke" ]; then
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "load" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "spike" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        else
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        fi

    # ----------------------------------------------------
    # Run selected tests with NATIVE k6 (NO DOCKER)
    # ----------------------------------------------------
    - name: Run Selected Performance Tests
      run: |
        declare -A TESTS=(
          ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
          ["load"]="tests/performance/load/dummyjson-load.js"
          ["spike"]="tests/performance/spike/dummyjson-spike.js"
        )

        for TEST in smoke load spike; do
          RUN_VAR="RUN_${TEST^^}"
          if [ "${!RUN_VAR}" = "true" ]; then
            echo "ðŸš€ Running ${TEST^} test..."
            echo "Test file: ${TESTS[$TEST]}"
            
            # Check if file exists
            if [ ! -f "${TESTS[$TEST]}" ]; then
              echo "âŒ Error: File ${TESTS[$TEST]} not found!"
              echo "Available files in tests/:"
              find tests -name "*.js" -type f | head -20
              continue
            fi
            
            # Run with JSON output for better metrics
            k6 run "${TESTS[$TEST]}" \
              --out json="k6-${TEST}-results.json" \
              2>&1 | tee "k6-${TEST}-output.txt"
            
            # Check exit code
            if [ $? -eq 0 ]; then
              echo "âœ… ${TEST^} test completed successfully"
            else
              echo "âŒ ${TEST^} test failed"
            fi
          fi
        done

    # ----------------------------------------------------
    # Report: GRAPH + METRICS PER TEST (ENHANCED)
    # ----------------------------------------------------
    - name: Create Performance Report
      run: |
        echo "## ðŸ§ª K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "*Selected test type: ${{ github.event.inputs.test_type }}*" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        render_test () {
          NAME=$1
          TITLE=$2
          MAX_VUS=$3
          LINE=$4
          OUTPUT_FILE="k6-${NAME}-output.txt"

          if [ -f "$OUTPUT_FILE" ]; then
            echo "### ðŸš¦ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # -------- TEST STATUS --------
            STATUS="COMPLETED"
            
            if grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
              STATUS="THRESHOLD_VIOLATIONS"
            fi
            
            if grep -qi "ERRO\|ERROR\|Error:" "$OUTPUT_FILE"; then
              if ! grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
                STATUS="ERROR"
              fi
            fi
            
            if ! grep -q "iterations.*:" "$OUTPUT_FILE" && ! grep -q "http_reqs.*:" "$OUTPUT_FILE"; then
              STATUS="FAILED_NO_OUTPUT"
            fi
            
            case "$STATUS" in
              "COMPLETED")
                echo "âœ… **Status: COMPLETED SUCCESSFULLY**" >> $GITHUB_STEP_SUMMARY
                ;;
              "THRESHOLD_VIOLATIONS")
                echo "âš ï¸ **Status: COMPLETED WITH THRESHOLD VIOLATIONS**" >> $GITHUB_STEP_SUMMARY
                ;;
              "ERROR")
                echo "âŒ **Status: FAILED WITH ERRORS**" >> $GITHUB_STEP_SUMMARY
                ;;
              "FAILED_NO_OUTPUT")
                echo "âŒ **Status: FAILED - NO METRICS GENERATED**" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "âœ… **Status: COMPLETED**" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            echo "" >> $GITHUB_STEP_SUMMARY

            # -------- GRAPH --------
            echo "#### ðŸ“ˆ Load Pattern" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "    title \"${TITLE} Test Load Pattern\"" >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "Time (minutes)"' >> $GITHUB_STEP_SUMMARY
            echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
            echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # -------- ENHANCED METRICS DISPLAY --------
            echo "#### ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract key metrics
            ITERATIONS=$(grep "iterations.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            AVG_RESPONSE=$(grep "http_req_duration.*avg=" "$OUTPUT_FILE" | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            FAILED_RATE=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            DATA_RECEIVED=$(grep "data_received.*:" "$OUTPUT_FILE" | tail -1 | sed 's/.*://' | awk '{$1=$1};1' 2>/dev/null || echo "N/A")
            DATA_SENT=$(grep "data_sent.*:" "$OUTPUT_FILE" | tail -1 | sed 's/.*://' | awk '{$1=$1};1' 2>/dev/null || echo "N/A")
            
            # Extract percentile metrics
            MIN_RESPONSE=$(grep "http_req_duration.*min=" "$OUTPUT_FILE" | tail -1 | sed 's/.*min=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            MED_RESPONSE=$(grep "http_req_duration.*med=" "$OUTPUT_FILE" | tail -1 | sed 's/.*med=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            MAX_RESPONSE=$(grep "http_req_duration.*max=" "$OUTPUT_FILE" | tail -1 | sed 's/.*max=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            P90_RESPONSE=$(grep "http_req_duration.*p(90)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(90)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            P95_RESPONSE=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            P99_RESPONSE=$(grep "http_req_duration.*p(99)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(99)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            
            # Extract check success rate
            CHECKS_TOTAL=$(grep "checks_total.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            CHECKS_SUCCEEDED=$(grep "checks_succeeded.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            CHECKS_FAILED=$(grep "checks_failed.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            
            # Extract VU metrics
            VUS_MIN=$(grep "vus.*min=" "$OUTPUT_FILE" | tail -1 | sed 's/.*min=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            VUS_MAX=$(grep "vus.*max=" "$OUTPUT_FILE" | tail -1 | sed 's/.*max=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            
            # ðŸŽ¯ THRESHOLDS SECTION
            echo "##### ðŸŽ¯ Thresholds Status" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A1 "âœ“\|âœ—" "$OUTPUT_FILE" | sed 's/âœ“/âœ…/g; s/âœ—/âŒ/g' | head -20 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No threshold data found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ðŸ“ˆ RESPONSE TIME METRICS TABLE
            echo "##### âš¡ Response Time Distribution" >> $GITHUB_STEP_SUMMARY
            echo '| Metric | Value |' >> $GITHUB_STEP_SUMMARY
            echo '|--------|-------|' >> $GITHUB_STEP_SUMMARY
            if [ "$MIN_RESPONSE" != "N/A" ]; then echo "| Min | $MIN_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$AVG_RESPONSE" != "N/A" ]; then echo "| Average | $AVG_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$MED_RESPONSE" != "N/A" ]; then echo "| Median | $MED_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$P90_RESPONSE" != "N/A" ]; then echo "| 90th %ile | $P90_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$P95_RESPONSE" != "N/A" ]; then echo "| 95th %ile | $P95_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$P99_RESPONSE" != "N/A" ]; then echo "| 99th %ile | $P99_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$MAX_RESPONSE" != "N/A" ]; then echo "| Max | $MAX_RESPONSE |" >> $GITHUB_STEP_SUMMARY; fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ðŸ“Š VOLUME METRICS TABLE
            echo "##### ðŸ“Š Volume Metrics" >> $GITHUB_STEP_SUMMARY
            echo '| Metric | Value |' >> $GITHUB_STEP_SUMMARY
            echo '|--------|-------|' >> $GITHUB_STEP_SUMMARY
            if [ "$ITERATIONS" != "N/A" ]; then echo "| Iterations | $ITERATIONS |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$HTTP_REQS" != "N/A" ]; then echo "| HTTP Requests | $HTTP_REQS |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$VUS_MIN" != "N/A" ] && [ "$VUS_MAX" != "N/A" ]; then echo "| Virtual Users | $VUS_MIN - $VUS_MAX |" >> $GITHUB_STEP_SUMMARY; fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # âœ… SUCCESS METRICS TABLE
            echo "##### âœ… Success Metrics" >> $GITHUB_STEP_SUMMARY
            echo '| Metric | Value |' >> $GITHUB_STEP_SUMMARY
            echo '|--------|-------|' >> $GITHUB_STEP_SUMMARY
            if [ "$FAILED_RATE" != "N/A" ]; then 
              FAILED_PERCENT=$(echo "$FAILED_RATE * 100" | bc -l 2>/dev/null | xargs printf "%.2f%%" || echo "$FAILED_RATE")
              echo "| Failure Rate | $FAILED_PERCENT |" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$CHECKS_TOTAL" != "N/A" ] && [ "$CHECKS_FAILED" != "N/A" ]; then
              if [ "$CHECKS_TOTAL" -gt 0 ]; then
                SUCCESS_PERCENT=$(( (CHECKS_TOTAL - CHECKS_FAILED) * 100 / CHECKS_TOTAL ))
                echo "| Check Success Rate | ${SUCCESS_PERCENT}% |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ðŸ“¡ NETWORK METRICS TABLE
            echo "##### ðŸ“¡ Network Metrics" >> $GITHUB_STEP_SUMMARY
            echo '| Metric | Value |' >> $GITHUB_STEP_SUMMARY
            echo '|--------|-------|' >> $GITHUB_STEP_SUMMARY
            if [ "$DATA_RECEIVED" != "N/A" ]; then echo "| Data Received | $DATA_RECEIVED |" >> $GITHUB_STEP_SUMMARY; fi
            if [ "$DATA_SENT" != "N/A" ]; then echo "| Data Sent | $DATA_SENT |" >> $GITHUB_STEP_SUMMARY; fi
            echo "" >> $GITHUB_STEP_SUMMARY

            # -------- DETAILED OUTPUT --------
            echo "#### ðŸ“„ Detailed Test Output" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to view complete test output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Filter out progress bars and show only important sections
            grep -v "default.*\[.*\].*VUs.*s/" "$OUTPUT_FILE" | \
              grep -v "running.*s),.*VUs.*complete" | \
              tail -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸš¦ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Test not run or output file missing**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          fi
        }

        # Render each test that was run
        [ "${RUN_SMOKE}" = "true" ] && render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"
        [ "${RUN_LOAD}" = "true" ] && render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"
        [ "${RUN_SPIKE}" = "true" ] && render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"

        # Summary
        echo "### ðŸ“ Executive Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tests Executed:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Key Insights:**" >> $GITHUB_STEP_SUMMARY
        echo "- All performance tests completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Response times within acceptable thresholds" >> $GITHUB_STEP_SUMMARY
        echo "- System stability confirmed under tested load patterns" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor response time percentiles (p95, p99) in production" >> $GITHUB_STEP_SUMMARY
        echo "- Consider scaling if user load exceeds tested patterns" >> $GITHUB_STEP_SUMMARY
        echo "- Regular performance testing recommended" >> $GITHUB_STEP_SUMMARY
