name: Fix metricReport

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    # ----------------------------------------------------
    # Setup k6 NATIVELY (NO DOCKER)
    # ----------------------------------------------------
    - name: Setup k6
      uses: grafana/setup-k6-action@v1

    # ----------------------------------------------------
    # Decide which tests to run
    # ----------------------------------------------------
    - name: Determine which tests to run
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"

        if [ "$TEST_TYPE" = "smoke" ]; then
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "load" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "spike" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        else
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        fi

    # ----------------------------------------------------
    # Run selected tests with NATIVE k6 (NO DOCKER)
    # ----------------------------------------------------
    - name: Run Selected Performance Tests
      run: |
        declare -A TESTS=(
          ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
          ["load"]="tests/performance/load/dummyjson-load.js"
          ["spike"]="tests/performance/spike/dummyjson-spike.js"
        )

        for TEST in smoke load spike; do
          RUN_VAR="RUN_${TEST^^}"
          if [ "${!RUN_VAR}" = "true" ]; then
            echo "üöÄ Running ${TEST^} test..."
            echo "Test file: ${TESTS[$TEST]}"
            
            if [ ! -f "${TESTS[$TEST]}" ]; then
              echo "‚ùå Error: File ${TESTS[$TEST]} not found!"
              echo "Available files in tests/:"
              find tests -name "*.js" -type f | head -20
              continue
            fi
            
            k6 run "${TESTS[$TEST]}" \
              --out json="k6-${TEST}-results.json" \
              2>&1 | tee "k6-${TEST}-output.txt"
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ ${TEST^} test completed successfully"
            else
              echo "‚ùå ${TEST^} test failed"
            fi
          fi
        done

    # ----------------------------------------------------
    # Report: GRAPH + METRICS PER TEST (ENHANCED)
    # ----------------------------------------------------
    - name: Create Performance Report
      run: |
        echo "## üß™ K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Report generated at: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "Selected test type: ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Function to render each test
        render_test() {
          NAME=$1
          TITLE=$2
          MAX_VUS=$3
          LINE=$4
          OUTPUT_FILE="k6-${NAME}-output.txt"

          if [ -f "$OUTPUT_FILE" ]; then
            echo "### üö¶ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Test Status
            STATUS="COMPLETED"
            
            if grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
              STATUS="THRESHOLD_VIOLATIONS"
            fi
            
            if grep -qi "ERRO\|ERROR\|Error:" "$OUTPUT_FILE"; then
              if ! grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
                STATUS="ERROR"
              fi
            fi
            
            if ! grep -q "iterations.*:" "$OUTPUT_FILE" && ! grep -q "http_reqs.*:" "$OUTPUT_FILE"; then
              STATUS="FAILED_NO_OUTPUT"
            fi
            
            case "$STATUS" in
              "COMPLETED")
                echo "‚úÖ Status: COMPLETED SUCCESSFULLY" >> $GITHUB_STEP_SUMMARY
                ;;
              "THRESHOLD_VIOLATIONS")
                echo "‚ö†Ô∏è Status: COMPLETED WITH THRESHOLD VIOLATIONS" >> $GITHUB_STEP_SUMMARY
                ;;
              "ERROR")
                echo "‚ùå Status: FAILED WITH ERRORS" >> $GITHUB_STEP_SUMMARY
                ;;
              "FAILED_NO_OUTPUT")
                echo "‚ùå Status: FAILED - NO METRICS GENERATED" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "‚úÖ Status: COMPLETED" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
            echo "" >> $GITHUB_STEP_SUMMARY

            # Graph
            echo "#### üìà Load Pattern" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "    title \"${TITLE} Test Load Pattern\"" >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "Time (minutes)"' >> $GITHUB_STEP_SUMMARY
            echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
            echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Plain English Explanation
            echo "#### üßë‚Äçüíª Plain English Explanation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What this test means for the business:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract metrics
            FAILED_RATE=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' 2>/dev/null || echo "0")
            P95_RESPONSE=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            CHECKS_TOTAL=$(grep "checks_total.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
            CHECKS_FAILED=$(grep "checks_failed.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
            ITERATIONS=$(grep "iterations.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
            HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
            
            # Show metrics in simple language
            if [ "$FAILED_RATE" != "0" ] && [ "$FAILED_RATE" != "N/A" ]; then
              FAILED_PERCENT=$(echo "scale=1; $FAILED_RATE * 100" | bc 2>/dev/null || echo "$FAILED_RATE")
              echo "üî¥ Failed Requests: ${FAILED_PERCENT}% of requests had errors" >> $GITHUB_STEP_SUMMARY
              echo "   Technical metric: http_req_failed rate=${FAILED_RATE}" >> $GITHUB_STEP_SUMMARY
            else
              echo "üü¢ Failed Requests: Very low error rate" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$P95_RESPONSE" != "N/A" ]; then
              echo "‚ö° Response Speed: 95% of requests faster than ${P95_RESPONSE}ms" >> $GITHUB_STEP_SUMMARY
              echo "   Technical metric: http_req_duration p(95)=${P95_RESPONSE}ms" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$ITERATIONS" != "0" ] && [ "$ITERATIONS" != "N/A" ]; then
              echo "üìä Test Volume: ${ITERATIONS} user sessions simulated" >> $GITHUB_STEP_SUMMARY
              echo "   Technical metric: iterations=${ITERATIONS}" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$CHECKS_TOTAL" != "0" ] && [ "$CHECKS_TOTAL" != "N/A" ]; then
              if [ "$CHECKS_FAILED" != "N/A" ] && [ "$CHECKS_TOTAL" -gt 0 ]; then
                CHECKS_PASSED=$((CHECKS_TOTAL - CHECKS_FAILED))
                CHECKS_SUCCESS_RATE=$((CHECKS_PASSED * 100 / CHECKS_TOTAL))
                if [ "$CHECKS_SUCCESS_RATE" -lt 90 ]; then
                  echo "üî¥ Functionality Checks: Only ${CHECKS_SUCCESS_RATE}% passed" >> $GITHUB_STEP_SUMMARY
                  echo "   Technical metrics: checks_total=${CHECKS_TOTAL}, checks_failed=${CHECKS_FAILED}" >> $GITHUB_STEP_SUMMARY
                else
                  echo "üü¢ Functionality Checks: ${CHECKS_SUCCESS_RATE}% passed" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            fi
            
            # Threshold Analysis
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Threshold Analysis:**" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå 'rate>0.85'" "$OUTPUT_FILE"; then
              RATE=$(grep "‚ùå 'rate>0.85'" "$OUTPUT_FILE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              if [ -n "$RATE" ]; then
                echo "üî¥ User Experience: Only ${RATE}% of users had good experience (needs 85%+)" >> $GITHUB_STEP_SUMMARY
                echo "   Technical details: threshold 'rate>0.85' failed with rate=${RATE}%" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            if grep -q "‚ùå 'rate<0.10'" "$OUTPUT_FILE"; then
              RATE=$(grep "‚ùå 'rate<0.10'" "$OUTPUT_FILE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              if [ -n "$RATE" ]; then
                echo "üî¥ System Errors: ${RATE}% error rate (should be under 10%)" >> $GITHUB_STEP_SUMMARY
                echo "   Technical details: threshold 'rate<0.10' failed with rate=${RATE}%" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            if grep -q "‚úÖ 'p(95)<2000'" "$OUTPUT_FILE"; then
              P95=$(grep "‚úÖ 'p(95)<2000'" "$OUTPUT_FILE" | sed 's/.*p(95)=//; s/ms//' | tr -d ' ')
              if [ -n "$P95" ]; then
                echo "üü¢ Speed Test: 95% of requests faster than ${P95}ms (under 2000ms target)" >> $GITHUB_STEP_SUMMARY
                echo "   Technical details: threshold 'p(95)<2000' passed with p(95)=${P95}ms" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # Page load metrics
            if grep -q "‚ùå page loaded during spike" "$OUTPUT_FILE"; then
              PAGE_LOAD_LINE=$(grep -A1 "‚ùå page loaded during spike" "$OUTPUT_FILE" | tail -1)
              SUCCESS_COUNT=$(echo "$PAGE_LOAD_LINE" | grep -o "[0-9]\+ ‚Äî ‚úÖ" | grep -o "[0-9]\+" || echo "0")
              FAIL_COUNT=$(echo "$PAGE_LOAD_LINE" | grep -o "[0-9]\+ / ‚ùå" | grep -o "[0-9]\+" || echo "0")
              TOTAL=$((SUCCESS_COUNT + FAIL_COUNT))
              if [ "$TOTAL" -gt 0 ]; then
                SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL))
                echo "üî¥ Page Load During Spike: Only ${SUCCESS_RATE}% of pages loaded successfully" >> $GITHUB_STEP_SUMMARY
                echo "   Technical details: ${SUCCESS_COUNT} passed / ${FAIL_COUNT} failed" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY

            # Technical Metrics for Developers
            echo "#### üìä Technical Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Response times
            echo "**Response Times:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "http_req_duration.*=" "$OUTPUT_FILE" | tail -5 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No response time data" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Thresholds
            echo "**Threshold Results:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A1 "‚úì\|‚úó" "$OUTPUT_FILE" | head -10 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No threshold data" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Raw output (collapsed)
            echo "#### üìÑ Detailed Output" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to view complete test output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          else
            echo "### üö¶ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Test not run or output file missing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          fi
        }

        # Render tests
        if [ "${RUN_SMOKE}" = "true" ]; then
          render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"
        fi
        
        if [ "${RUN_LOAD}" = "true" ]; then
          render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"
        fi
        
        if [ "${RUN_SPIKE}" = "true" ]; then
          render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"
        fi

        # Executive Summary
        echo "### üìù Executive Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Collect spike test metrics
        if [ -f "k6-spike-output.txt" ]; then
          # Check for critical failures
          if grep -q "‚ùå 'rate<0.10'" "k6-spike-output.txt"; then
            RATE=$(grep "‚ùå 'rate<0.10'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
            echo "### üö® CRITICAL ISSUE DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Problem:** System has ${RATE}% error rate during traffic spikes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What this means:**" >> $GITHUB_STEP_SUMMARY
            echo "- During busy times, ${RATE}% of users get errors" >> $GITHUB_STEP_SUMMARY
            echo "- Website becomes mostly unusable under load" >> $GITHUB_STEP_SUMMARY
            echo "- Urgent fixes needed before promotions or events" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif grep -q "‚ùå 'rate>0.85'" "k6-spike-output.txt"; then
            RATE=$(grep "‚ùå 'rate>0.85'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
            echo "### ‚ö†Ô∏è WARNING: User Experience Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Problem:** Only ${RATE}% of users had good experience during spike" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "**Overall Status:**" >> $GITHUB_STEP_SUMMARY
        if [ -f "k6-spike-output.txt" ] && grep -q "‚ùå" "k6-spike-output.txt"; then
          if grep -q "‚ùå 'rate<0.10'" "k6-spike-output.txt"; then
            echo "üî¥ CRITICAL FAILURE" >> $GITHUB_STEP_SUMMARY
          else
            echo "üü° WARNING" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "üü¢ PASS" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "k6-spike-output.txt" ] && grep -q "‚ùå 'rate<0.10'" "k6-spike-output.txt"; then
          RATE=$(grep "‚ùå 'rate<0.10'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
          echo "1. üö® IMMEDIATE ACTION: Fix error rate (current: ${RATE}%, target: <10%)" >> $GITHUB_STEP_SUMMARY
          echo "2. Investigate: Check server logs and database connections" >> $GITHUB_STEP_SUMMARY
          echo "3. Do not deploy until spike tests pass" >> $GITHUB_STEP_SUMMARY
        elif [ -f "k6-spike-output.txt" ] && grep -q "‚ùå 'rate>0.85'" "k6-spike-output.txt"; then
          RATE=$(grep "‚ùå 'rate>0.85'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
          echo "1. Address soon: Improve user experience (current: ${RATE}%, target: >85%)" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor response times in production" >> $GITHUB_STEP_SUMMARY
          echo "3. Consider scaling for traffic spikes" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. Performance is good under tested conditions" >> $GITHUB_STEP_SUMMARY
          echo "2. Continue regular performance testing" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor production metrics" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**What to tell stakeholders:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "k6-spike-output.txt" ] && grep -q "‚ùå 'rate<0.10'" "k6-spike-output.txt"; then
          RATE=$(grep "‚ùå 'rate<0.10'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
          echo "> 'The website crashes during busy periods with ${RATE}% error rate. We need to fix this urgently.'" >> $GITHUB_STEP_SUMMARY
        elif [ -f "k6-spike-output.txt" ] && grep -q "‚ùå 'rate>0.85'" "k6-spike-output.txt"; then
          RATE=$(grep "‚ùå 'rate>0.85'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
          echo "> 'The website works but only ${RATE}% of users have good experience during peak times.'" >> $GITHUB_STEP_SUMMARY
        else
          echo "> 'Performance is good under normal conditions. The site is stable for typical usage.'" >> $GITHUB_STEP_SUMMARY
        fi
