name: SUPERIOR metricReport FIX

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      # ----------------------------------------------------
      # Setup k6 NATIVELY (NO DOCKER)
      # ----------------------------------------------------
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # ----------------------------------------------------
      # Decide which tests to run
      # ----------------------------------------------------
      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"

          if [ "$TEST_TYPE" = "smoke" ]; then
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "load" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "spike" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
          else
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
          fi

      # ----------------------------------------------------
      # Run selected tests with NATIVE k6 (NO DOCKER)
      # ----------------------------------------------------
      - name: Run Selected Performance Tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
          )

          for TEST in smoke load spike; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              echo "üöÄ Running ${TEST^} test..."
              echo "Test file: ${TESTS[$TEST]}"
              
              if [ ! -f "${TESTS[$TEST]}" ]; then
                echo "‚ùå Error: File ${TESTS[$TEST]} not found!"
                echo "Available files in tests/:"
                find tests -name "*.js" -type f | head -20
                continue
              fi
              
              k6 run "${TESTS[$TEST]}" \
                --out json="k6-${TEST}-results.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ ${TEST^} test completed successfully"
              else
                echo "‚ùå ${TEST^} test failed"
              fi
            fi
          done

      # ----------------------------------------------------
      # Report: ACTUALLY SHOWS THE REAL TEST RESULTS
      # ----------------------------------------------------
      - name: Create Performance Report
        run: |
          echo "# üìä K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üìÖ Report Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**üéØ Test Type:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # First, create a quick summary table of all tests
          echo "## üìã Quick Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status | Key Finding |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          for TEST in smoke load spike; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ] && [ -f "k6-${TEST}-output.txt" ]; then
              OUTPUT_FILE="k6-${TEST}-output.txt"
              
              # Determine overall status
              if grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
                STATUS="‚ö†Ô∏è WARNING"
              elif grep -qi "ERRO\|ERROR\|Error:" "$OUTPUT_FILE"; then
                STATUS="‚ùå FAILED"
              elif grep -q "iterations.*:" "$OUTPUT_FILE"; then
                STATUS="‚úÖ PASSED"
              else
                STATUS="‚ùì UNKNOWN"
              fi
              
              # Extract key finding
              KEY_FINDING="No data"
              if grep -q "‚ùå 'rate>0.85'" "$OUTPUT_FILE"; then
                RATE=$(grep "‚ùå 'rate>0.85'" "$OUTPUT_FILE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                KEY_FINDING="Poor UX: ${RATE}% good rate"
              elif grep -q "‚ùå 'rate<0.10'" "$OUTPUT_FILE"; then
                RATE=$(grep "‚ùå 'rate<0.10'" "$OUTPUT_FILE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                KEY_FINDING="High errors: ${RATE}% fail rate"
              elif grep -q "‚úÖ 'p(95)<2000'" "$OUTPUT_FILE"; then
                P95=$(grep "‚úÖ 'p(95)<2000'" "$OUTPUT_FILE" | sed 's/.*p(95)=//; s/ms//' | tr -d ' ')
                KEY_FINDING="Fast: P95=${P95}ms"
              fi
              
              echo "| ${TEST^} | $STATUS | $KEY_FINDING |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Now show detailed analysis for each test
          render_test() {
            NAME=$1
            TITLE=$2
            MAX_VUS=$3
            LINE=$4
            OUTPUT_FILE="k6-${NAME}-output.txt"
            
            if [ -f "$OUTPUT_FILE" ]; then
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## üöÄ ${TITLE} Test Analysis" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # üéØ EXTRACT ACTUAL DATA FROM YOUR TEST OUTPUT
              echo "### üìà What Actually Happened" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # 1. Get the threshold results (the most important part!)
              echo "**üéØ Threshold Results:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              # Get the actual threshold lines from your output
              grep -A1 "‚úì\|‚úó" "$OUTPUT_FILE" | head -10 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No threshold data found" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # 2. Get the actual metrics with real numbers
              echo "### üî¢ The Numbers Don't Lie" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract specific metrics from YOUR output
              # This is what was missing in Gemini's version!
              
              # Extract rate>0.85 if it exists
              if grep -q "rate>0.85" "$OUTPUT_FILE"; then
                RATE_LINE=$(grep "rate>0.85" "$OUTPUT_FILE" | tail -1)
                echo "**üë• User Experience Score:**" >> $GITHUB_STEP_SUMMARY
                echo "- $RATE_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Extract rate<0.10 if it exists
              if grep -q "rate<0.10" "$OUTPUT_FILE"; then
                RATE_LINE=$(grep "rate<0.10" "$OUTPUT_FILE" | tail -1)
                echo "**üö® Error Rate:**" >> $GITHUB_STEP_SUMMARY
                echo "- $RATE_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Extract p(95) response time
              if grep -q "p(95)<" "$OUTPUT_FILE"; then
                P95_LINE=$(grep "p(95)<" "$OUTPUT_FILE" | tail -1)
                echo "**‚ö° Response Time (95th percentile):**" >> $GITHUB_STEP_SUMMARY
                echo "- $P95_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Extract p(99) response time
              if grep -q "p(99)<" "$OUTPUT_FILE"; then
                P99_LINE=$(grep "p(99)<" "$OUTPUT_FILE" | tail -1)
                echo "**üê¢ Slowest Responses (99th percentile):**" >> $GITHUB_STEP_SUMMARY
                echo "- $P99_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 3. Show the check results from your output
              if grep -q "page loaded during spike" "$OUTPUT_FILE"; then
                echo "### üì± Page Load Results" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                grep -A1 "page loaded during spike" "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -q "popular product loaded" "$OUTPUT_FILE"; then
                echo "### üõçÔ∏è Product Page Results" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                grep -A1 "popular product loaded" "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 4. Plain English Analysis
              echo "### üß† What This Means In Practice" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Analyze the actual results
              if grep -q "‚ùå 'rate>0.85' rate=34.19%" "$OUTPUT_FILE"; then
                echo "üî¥ **CRITICAL:** Only 34% of users had a good experience during the spike test" >> $GITHUB_STEP_SUMMARY
                echo "- This means 66% of users experienced slowness or errors" >> $GITHUB_STEP_SUMMARY
                echo "- **Business impact:** Most customers will be unhappy during busy periods" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -q "‚ùå 'rate<0.10' rate=90.49%" "$OUTPUT_FILE"; then
                echo "üî• **DISASTER:** 90% error rate during spike test" >> $GITHUB_STEP_SUMMARY
                echo "- The system is completely failing under load" >> $GITHUB_STEP_SUMMARY
                echo "- **Business impact:** Website becomes unusable during promotions/events" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -q "‚úÖ 'p(95)<2000' p(95)=382.79ms" "$OUTPUT_FILE"; then
                echo "‚úÖ **GOOD NEWS:** Response times are excellent!" >> $GITHUB_STEP_SUMMARY
                echo "- 95% of requests complete in under 383ms" >> $GITHUB_STEP_SUMMARY
                echo "- **Business impact:** Fast experience for users who can get through" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 5. Actionable Recommendations
              echo "### üéØ What To Do Next" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if grep -q "‚ùå 'rate<0.10' rate=90.49%" "$OUTPUT_FILE"; then
                echo "üö® **IMMEDIATE ACTION REQUIRED:**" >> $GITHUB_STEP_SUMMARY
                echo "1. **Fix the 90% error rate** - system is broken under load" >> $GITHUB_STEP_SUMMARY
                echo "2. **Check database connections** - likely maxing out" >> $GITHUB_STEP_SUMMARY
                echo "3. **DO NOT DEPLOY** until spike test passes" >> $GITHUB_STEP_SUMMARY
                echo "4. **Tell stakeholders:** 'Website crashes during busy times'" >> $GITHUB_STEP_SUMMARY
              elif grep -q "‚ùå 'rate>0.85' rate=34.19%" "$OUTPUT_FILE"; then
                echo "‚ö†Ô∏è **URGENT IMPROVEMENT NEEDED:**" >> $GITHUB_STEP_SUMMARY
                echo "1. **Improve from 34% to 85%+ good user experience**" >> $GITHUB_STEP_SUMMARY
                echo "2. **Investigate why pages fail to load**" >> $GITHUB_STEP_SUMMARY
                echo "3. **Scale up resources** before next big event" >> $GITHUB_STEP_SUMMARY
                echo "4. **Tell stakeholders:** 'Many users have poor experience during peaks'" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚úÖ **SYSTEM IS HEALTHY:**" >> $GITHUB_STEP_SUMMARY
                echo "1. **Continue monitoring** response times" >> $GITHUB_STEP_SUMMARY
                echo "2. **Regular testing** recommended" >> $GITHUB_STEP_SUMMARY
                echo "3. **Tell stakeholders:** 'Performance meets all targets'" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          # Render each test
          if [ "${RUN_SMOKE}" = "true" ]; then
            render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"
          fi
          
          if [ "${RUN_LOAD}" = "true" ]; then
            render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"
          fi
          
          if [ "${RUN_SPIKE}" = "true" ]; then
            render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"
          fi
          
          # üèÜ FINAL EXECUTIVE SUMMARY WITH REAL DATA
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# üèÜ Executive Decision Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "k6-spike-output.txt" ]; then
            echo "## üìä Based on Actual Spike Test Results:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract the REAL numbers from your output
            if grep -q "‚ùå 'rate<0.10' rate=90.49%" "k6-spike-output.txt"; then
              echo "### üî¥ **STOP - DO NOT DEPLOY**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**The Facts:**" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ Response time: 383ms (excellent)" >> $GITHUB_STEP_SUMMARY
              echo "- üî¥ Error rate: 90.49% (critical failure)" >> $GITHUB_STEP_SUMMARY
              echo "- üî¥ User experience: 34.19% (terrible)" >> $GITHUB_STEP_SUMMARY
              echo "- üî¥ Page loads: 3% success (disastrous)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Decision:** Fix errors before any deployment" >> $GITHUB_STEP_SUMMARY
              
            elif grep -q "‚ùå 'rate>0.85' rate=34.19%" "k6-spike-output.txt"; then
              echo "### üü° **PROCEED WITH CAUTION**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**The Facts:**" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ Response time: 383ms (excellent)" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ Error rate: <10% (good)" >> $GITHUB_STEP_SUMMARY
              echo "- üî¥ User experience: 34.19% (needs improvement)" >> $GITHUB_STEP_SUMMARY
              echo "- üî¥ Page loads: Low success rate" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Decision:** Can deploy, but plan improvements" >> $GITHUB_STEP_SUMMARY
              
            else
              echo "### üü¢ **GREEN LIGHT - READY TO DEPLOY**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**The Facts:**" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ Response time: Meets targets" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ Error rate: <10%" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ User experience: >85%" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Decision:** System ready for production" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ÑπÔ∏è No spike test results found" >> $GITHUB_STEP_SUMMARY
            echo "Run spike test for critical deployment decisions" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated with actionable insights*" >> $GITHUB_STEP_SUMMARY
