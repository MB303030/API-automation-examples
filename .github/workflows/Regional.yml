name: Regional API Tests

on:
  workflow_dispatch: # Run it manually
    inputs:
      test_type:
        description: 'Which existing test to run in all regions?'
        required: true
        default: 'load'
        type: choice
        options:
        - smoke
        - load
        - spike
        - stress

jobs:
  test-regions:
    strategy:
      matrix:
        runner: [ubuntu-latest, windows-latest]
        include:
          - runner: ubuntu-latest
            region_label: "US (West)"
          - runner: windows-latest
            region_label: "EU (Netherlands)"
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run ${{ github.event.inputs.test_type }} test from ${{ matrix.region_label }}
        run: |
          # This line uses your EXISTING test files based on the user's selection
          TEST_PATH="tests/performance/${{ github.event.inputs.test_type }}/dummyjson-${{ github.event.inputs.test_type }}.js"
          echo "Running test: $TEST_PATH"
          
          k6 run "$TEST_PATH" \
            --out json=results-${{ matrix.region_label }}.json \
            --summary-export=summary-${{ matrix.region_label }}.json 2>&1 | tee output-${{ matrix.region_label }}.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.region_label }}-${{ github.event.inputs.test_type }}
          path: |
            results-${{ matrix.region_label }}.json
            summary-${{ matrix.region_label }}.json

  combine-report:
    runs-on: ubuntu-latest
    needs: test-regions

    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Create regional report
        run: |
          echo "# ðŸŒ Regional Test: ${{ github.event.inputs.test_type }}" > REPORT.md
          echo "**Comparison of the same test run from different GitHub runners.**" >> REPORT.md
          echo "" >> REPORT.md
          echo "| Region | Avg Response Time | 95th Percentile (p95) | Error Rate |" >> REPORT.md
          echo "|--------|-------------------|------------------------|------------|" >> REPORT.md
          
          # Simple text processing to extract data. For a real report, you'd use jq.
          for file in all-results/results-*/summary-*.json; do
            REGION=$(echo "$file" | grep -o "results-[^/]*" | cut -d'-' -f2-)
            echo "| $REGION | (Data from JSON) | (Data from JSON) | (Data from JSON) |" >> REPORT.md
          done
          
          cat REPORT.md

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: regional-${{ github.event.inputs.test_type }}-report
          path: |
            REPORT.md
            all-results/
