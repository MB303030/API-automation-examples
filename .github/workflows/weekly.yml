name: API CI weekly

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Job 1: Functional API tests with Playwright
  functional-tests:
    runs-on: ubuntu-latest
    name: Functional Tests
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright
      run: npx playwright install chromium

    - name: ðŸ”§ Setup API environment variables
      run: |
        echo "API_KEY=test-key-${{ github.run_id }}" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://template.postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: ðŸ§ª Run Playwright API tests
      run: npx playwright test

    - name: ðŸ“¤ Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # Job 2: Performance tests (K6) - On schedule, manual trigger, OR push to main
  performance-tests:
    runs-on: ubuntu-latest
    name: Performance Tests
    # CHANGED: Now runs on push to main too
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Docker and K6 Setup Check
      id: setup
      run: |
        echo "ðŸ” Checking Docker installation..."
        docker --version
        echo "âœ… Docker is available"
        
        echo "ðŸ” Checking if K6 tests exist..."
        if [ ! -f "tests/performance/smoke/dummyjson-smoke.js" ]; then
          echo "âŒ K6 test file not found: tests/performance/smoke/dummyjson-smoke.js"
          echo "create_k6_test=false" >> $GITHUB_OUTPUT
          exit 0  # Exit successfully but mark as no test
        else
          echo "âœ… K6 test file found"
          echo "create_k6_test=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸš€ Run K6 Smoke Test
      if: steps.setup.outputs.create_k6_test == 'true'
      id: k6-test
      run: |
        echo "ðŸš€ Running K6 smoke test..."
        
        # Create results directory
        mkdir -p test-results
        
        # Run K6 with output capture
        docker run --rm \
          -v "$(pwd)/tests/performance:/scripts" \
          grafana/k6:latest \
          run /scripts/smoke/dummyjson-smoke.js \
          --out json=test-results/k6-results.json \
          --summary-export=test-results/k6-summary.json \
          --quiet | tee test-results/k6-output.txt
        
        # Capture exit code
        echo "exit_code=$?" >> $GITHUB_OUTPUT
        
    - name: ðŸ“Š Generate K6 Test Report
      if: always()
      run: |
        echo "## ðŸ“ˆ K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.setup.outputs.create_k6_test }}" = "true" ]; then
          echo "**Test:** DummyJSON Smoke Test" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** 2 VUs for 30s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.k6-test.outputs.exit_code }}" = "0" ]; then
            echo "### âœ… Test Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Test Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show basic metrics if summary exists
          if [ -f "test-results/k6-summary.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Metrics:" >> $GITHUB_STEP_SUMMARY
            
            # Extract metrics (simplified version)
            if command -v jq >/dev/null 2>&1; then
              echo "- **Total Requests:** $(jq '.metrics.http_reqs.count' test-results/k6-summary.json)" >> $GITHUB_STEP_SUMMARY
              echo "- **Failed Requests:** $(jq '.metrics.http_req_failed.count' test-results/k6-summary.json)" >> $GITHUB_STEP_SUMMARY
              echo "- **95th Percentile Response Time:** $(jq '.metrics.http_req_duration."p(95)" | round' test-results/k6-summary.json)ms" >> $GITHUB_STEP_SUMMARY
              echo "- **Request Rate:** $(jq '.metrics.http_reqs.rate | round' test-results/k6-summary.json) reqs/s" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Results saved:** test-results/k6-summary.json" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Show output if test failed
          if [ "${{ steps.k6-test.outputs.exit_code }}" != "0" ] && [ -f "test-results/k6-output.txt" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Test Output:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -20 test-results/k6-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**Status:** No K6 tests configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To add K6 tests:" >> $GITHUB_STEP_SUMMARY
          echo "1. Create test files in \`tests/performance/\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Push to GitHub" >> $GITHUB_STEP_SUMMARY
          echo "3. Trigger workflow manually or wait for schedule" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“¤ Upload K6 Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-performance-results
        path: |
          test-results/
        retention-days: 30
