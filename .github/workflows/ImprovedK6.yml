name: ALL K6 Performance Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # --------------------------------------------------
    # Decide which tests to run
    # --------------------------------------------------
    - name: Determine which tests to run
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"

        case "$TEST_TYPE" in
          smoke)
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            ;;
          load)
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            ;;
          spike)
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
            ;;
          all)
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
            ;;
        esac

    # --------------------------------------------------
    # Run selected k6 tests
    # --------------------------------------------------
    - name: Run Selected Performance Tests
      run: |
        declare -A TESTS=(
          ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
          ["load"]="tests/performance/load/dummyjson-load.js"
          ["spike"]="tests/performance/spike/dummyjson-spike.js"
        )

        for TEST in smoke load spike; do
          RUN_VAR="RUN_${TEST^^}"

          if [ "${!RUN_VAR}" = "true" ]; then
            echo "ðŸš€ Running ${TEST^} test..."
            docker run --rm \
              -v $PWD:/scripts \
              -w /scripts \
              grafana/k6 run "${TESTS[$TEST]}" \
              2>&1 | tee "k6-${TEST}-output.txt"
            echo "âœ… ${TEST^} test completed"
          fi
        done

    # --------------------------------------------------
    # Unified Dynamic Report (ALL tests)
    # --------------------------------------------------
    - name: Create Performance Report
      run: |
        echo "## ðŸ§ª K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        TESTS=("smoke" "load" "spike")

        for TEST in "${TESTS[@]}"; do
          RUN_VAR="RUN_${TEST^^}"
          OUTPUT_FILE="k6-${TEST}-output.txt"

          if [ "${!RUN_VAR}" = "true" ] && [ -f "$OUTPUT_FILE" ]; then
            echo "### ðŸš¦ ${TEST^} Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Chart
            echo "#### ðŸ“ˆ Load Pattern" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "    title \"${TEST^} Test Load Pattern\"" >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "Time"' >> $GITHUB_STEP_SUMMARY
            echo '    y-axis "Virtual Users" 0 --> 400' >> $GITHUB_STEP_SUMMARY
            echo '    line [0, 50, 150, 300, 150, 50, 0]' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Metrics
            echo "#### ðŸ“Š Key Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            ITERATIONS=$(grep "iterations.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "N/A")
            HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "N/A")
            AVG=$(grep "http_req_duration.*avg=" "$OUTPUT_FILE" | tail -1 | sed 's/.*avg=//' | awk '{print $1}' || echo "N/A")
            P95=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' || echo "N/A")
            FAIL_RATE=$(grep "http_req_failed" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' || echo "N/A")

            echo "Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
            echo "HTTP Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
            echo "Avg Response Time: $AVG" >> $GITHUB_STEP_SUMMARY
            echo "p95 Response Time: $P95" >> $GITHUB_STEP_SUMMARY
            echo "HTTP Failure Rate: $FAIL_RATE" >> $GITHUB_STEP_SUMMARY

            echo '```' >> $GITHUB_STEP_SUMMARY

            echo "<details><summary>View raw ${TEST^} output</summary>" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
          fi
        done

        echo "*Generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "*Selected test type: ${{ github.event.inputs.test_type }}*" >> $GITHUB_STEP_SUMMARY
