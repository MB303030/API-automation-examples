name: All K6  Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set Test Configuration
      id: test-config
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"
        
        case $TEST_TYPE in
          "load")
            echo "TEST_FILE=tests/performance/load/dummyjson-load.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Load Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Load Test: Business Hours Simulation" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[0m, 2m, 4m, 6m, 9m, 11m, 12m]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[0, 20, 50, 80, 100, 40, 10]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=120" >> $GITHUB_OUTPUT
            ;;
          "spike")
            echo "TEST_FILE=tests/performance/spike/dummyjson-spike.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Spike Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Spike Test: Sudden Traffic Burst" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[0s, 30s, 90s, 120s, 180s, 210s]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[10, 10, 200, 200, 50, 10]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=250" >> $GITHUB_OUTPUT
            ;;
          "all")
            echo "TEST_FILE=all" >> $GITHUB_OUTPUT
            echo "TEST_NAME=All Performance Tests" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=All Performance Tests" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=100" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "Selected: $TEST_TYPE"
        echo "Test File: ${{ steps.test-config.outputs.TEST_FILE }}"
        echo "Test Name: ${{ steps.test-config.outputs.TEST_NAME }}"
    
    - name: Run Load Test (for "all" or "load")
      if: github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'all'
      id: run-load
      run: |
        echo "üöÄ Running Load Test..."
        docker run --rm -i grafana/k6 run - < tests/performance/load/dummyjson-load.js 2>&1 | tee k6-load-output.txt
        echo "Load test completed!"
    
    - name: Run Spike Test (for "all" or "spike")
      if: github.event.inputs.test_type == 'spike' || github.event.inputs.test_type == 'all'
      id: run-spike
      run: |
        echo "üöÄ Running Spike Test..."
        docker run --rm -i grafana/k6 run - < tests/performance/spike/dummyjson-spike.js 2>&1 | tee k6-spike-output.txt
        echo "Spike test completed!"
    
    - name: Create Dynamic Report with Chart
      run: |
        echo "# üß™ Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üìã Executive Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Type:** ${{ steps.test-config.outputs.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ‚úÖ All tests completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Handle "all" case - show both tests in separate sections
        if [ "${{ github.event.inputs.test_type }}" = "all" ]; then
          echo "## üìä Test Suite Overview" >> $GITHUB_STEP_SUMMARY
          echo "Running both performance tests to validate system under different load conditions." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Load Test Section with dropdown
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><strong>üîÑ Load Test - Business Hours Simulation</strong></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Load Pattern" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo '    title "Business Hours Simulation (12 minutes)"' >> $GITHUB_STEP_SUMMARY
          echo '    x-axis "[0m, 2m, 4m, 6m, 9m, 11m, 12m]"' >> $GITHUB_STEP_SUMMARY
          echo '    y-axis "Virtual Users" 0 --> 120' >> $GITHUB_STEP_SUMMARY
          echo '    line [0, 20, 50, 80, 100, 40, 10]' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ‚öôÔ∏è Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Morning Ramp-up | 0-2m | 0 ‚Üí 20 | Business opening |" >> $GITHUB_STEP_SUMMARY
          echo "| Mid-morning | 2-4m | 20 ‚Üí 50 | Increasing traffic |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-lunch Peak | 4-6m | 50 ‚Üí 80 | High activity |" >> $GITHUB_STEP_SUMMARY
          echo "| Lunch Peak | 6-9m | 80 ‚Üí 100 | Maximum load |" >> $GITHUB_STEP_SUMMARY
          echo "| Afternoon Decline | 9-11m | 100 ‚Üí 40 | Post-lunch dip |" >> $GITHUB_STEP_SUMMARY
          echo "| Evening Wind-down | 11-12m | 40 ‚Üí 10 | Business closing |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Data Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- DummyJSON Products API endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Mixed scenarios: Browsing (60%), Product Details (25%), Search (10%), Category (5%)" >> $GITHUB_STEP_SUMMARY
          echo "- Realistic think times: 2-5 seconds between actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Performance Requirements:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Response Time: p(95) < 300ms" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Success Rate: > 99.9%" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Throughput: > 100 req/sec" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Load Test Results
          if [ -f "k6-load-output.txt" ]; then
            echo "### üìä Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract metrics
            echo "**Summary Statistics:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Iterations
            if grep -q "iterations.*:" k6-load-output.txt; then
              ITERATIONS=$(grep "iterations.*:" k6-load-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Requests
            if grep -q "http_reqs.*:" k6-load-output.txt; then
              HTTP_REQS=$(grep "http_reqs.*:" k6-load-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Avg response time
            if grep -q "http_req_duration.*avg=" k6-load-output.txt; then
              AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-load-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # p95 response time
            if grep -q "http_req_duration.*p\\(95\\)=" k6-load-output.txt; then
              P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" k6-load-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Success rate
            if grep -q "checks_succeeded" k6-load-output.txt; then
              SUCCESS_RATE=$(grep "checks_succeeded" k6-load-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Threshold violations
            if grep -q "thresholds on metrics.*have been crossed" k6-load-output.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Detailed output dropdown
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìÑ View Raw Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -40 k6-load-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Spike Test Section with dropdown
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><strong>‚ö° Spike Test - Sudden Traffic Burst</strong></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Load Pattern" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo '    title "Sudden Traffic Burst (3.5 minutes)"' >> $GITHUB_STEP_SUMMARY
          echo '    x-axis "[0s, 30s, 90s, 120s, 180s, 210s]"' >> $GITHUB_STEP_SUMMARY
          echo '    y-axis "Virtual Users" 0 --> 250' >> $GITHUB_STEP_SUMMARY
          echo '    line [10, 10, 200, 200, 50, 10]' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ‚öôÔ∏è Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Normal Traffic | 0-30s | 10 | Baseline activity |" >> $GITHUB_STEP_SUMMARY
          echo "| Spike Start | 30-90s | 10 ‚Üí 200 | Sudden traffic burst |" >> $GITHUB_STEP_SUMMARY
          echo "| Peak Spike | 90-120s | 200 | Maximum burst load |" >> $GITHUB_STEP_SUMMARY
          echo "| Recovery | 120-180s | 200 ‚Üí 50 | Gradual recovery |" >> $GITHUB_STEP_SUMMARY
          echo "| Back to Normal | 180-210s | 50 ‚Üí 10 | Return to baseline |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Data Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- DummyJSON Products API endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Flash sale simulation with multiple refreshes" >> $GITHUB_STEP_SUMMARY
          echo "- Popular products only (IDs 1-5)" >> $GITHUB_STEP_SUMMARY
          echo "- Trending search terms" >> $GITHUB_STEP_SUMMARY
          echo "- Very short think times (0.1-0.6 seconds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Spike Test Goals:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Test system recovery from traffic bursts" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Measure response time degradation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Verify auto-scaling (if applicable)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Allow temporary performance degradation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Spike Test Results
          if [ -f "k6-spike-output.txt" ]; then
            echo "### üìä Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract metrics
            echo "**Summary Statistics:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Iterations
            if grep -q "iterations.*:" k6-spike-output.txt; then
              ITERATIONS=$(grep "iterations.*:" k6-spike-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Requests
            if grep -q "http_reqs.*:" k6-spike-output.txt; then
              HTTP_REQS=$(grep "http_reqs.*:" k6-spike-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Avg response time
            if grep -q "http_req_duration.*avg=" k6-spike-output.txt; then
              AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-spike-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # p95 response time
            if grep -q "http_req_duration.*p\\(95\\)=" k6-spike-output.txt; then
              P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" k6-spike-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Success rate
            if grep -q "checks_succeeded" k6-spike-output.txt; then
              SUCCESS_RATE=$(grep "checks_succeeded" k6-spike-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Threshold violations
            if grep -q "thresholds on metrics.*have been crossed" k6-spike-output.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Detailed output dropdown
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìÑ View Raw Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -40 k6-spike-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
        # Handle individual test cases
        else
          # Single test report with dropdown sections
          echo "## üìä ${{ steps.test-config.outputs.TEST_NAME }} Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Overview dropdown
          echo "<details open>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><strong>üìà Load Pattern</strong></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo "    title \"${{ steps.test-config.outputs.CHART_TITLE }}\"" >> $GITHUB_STEP_SUMMARY
          echo "    x-axis ${{ steps.test-config.outputs.CHART_X_AXIS }}" >> $GITHUB_STEP_SUMMARY
          echo "    y-axis \"Virtual Users\" 0 --> ${{ steps.test-config.outputs.CHART_MAX }}" >> $GITHUB_STEP_SUMMARY
          echo "    line ${{ steps.test-config.outputs.CHART_DATA }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Configuration dropdown
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><strong>‚öôÔ∏è Test Configuration & Data</strong></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.test_type }}" = "load" ]; then
            echo "**Load Test Configuration:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Morning Ramp-up | 0-2m | 0 ‚Üí 20 | Business opening |" >> $GITHUB_STEP_SUMMARY
            echo "| Mid-morning | 2-4m | 20 ‚Üí 50 | Increasing traffic |" >> $GITHUB_STEP_SUMMARY
            echo "| Pre-lunch Peak | 4-6m | 50 ‚Üí 80 | High activity |" >> $GITHUB_STEP_SUMMARY
            echo "| Lunch Peak | 6-9m | 80 ‚Üí 100 | Maximum load |" >> $GITHUB_STEP_SUMMARY
            echo "| Afternoon Decline | 9-11m | 100 ‚Üí 40 | Post-lunch dip |" >> $GITHUB_STEP_SUMMARY
            echo "| Evening Wind-down | 11-12m | 40 ‚Üí 10 | Business closing |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Test Data Used:**" >> $GITHUB_STEP_SUMMARY
            echo "- DummyJSON Products API endpoints" >> $GITHUB_STEP_SUMMARY
            echo "- Mixed scenarios: Browsing (60%), Product Details (25%), Search (10%), Category (5%)" >> $GITHUB_STEP_SUMMARY
            echo "- Realistic think times: 2-5 seconds between actions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Performance Requirements:**" >> $GITHUB_STEP_SUMMARY
            echo "- Response Time: p(95) < 300ms" >> $GITHUB_STEP_SUMMARY
            echo "- Success Rate: > 99.9%" >> $GITHUB_STEP_SUMMARY
            echo "- Throughput: > 100 req/sec" >> $GITHUB_STEP_SUMMARY
            
          elif [ "${{ github.event.inputs.test_type }}" = "spike" ]; then
            echo "**Spike Test Configuration:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Normal Traffic | 0-30s | 10 | Baseline activity |" >> $GITHUB_STEP_SUMMARY
            echo "| Spike Start | 30-90s | 10 ‚Üí 200 | Sudden traffic burst |" >> $GITHUB_STEP_SUMMARY
            echo "| Peak Spike | 90-120s | 200 | Maximum burst load |" >> $GITHUB_STEP_SUMMARY
            echo "| Recovery | 120-180s | 200 ‚Üí 50 | Gradual recovery |" >> $GITHUB_STEP_SUMMARY
            echo "| Back to Normal | 180-210s | 50 ‚Üí 10 | Return to baseline |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Test Data Used:**" >> $GITHUB_STEP_SUMMARY
            echo "- DummyJSON Products API endpoints" >> $GITHUB_STEP_SUMMARY
            echo "- Flash sale simulation with multiple refreshes" >> $GITHUB_STEP_SUMMARY
            echo "- Popular products only (IDs 1-5)" >> $GITHUB_STEP_SUMMARY
            echo "- Trending search terms" >> $GITHUB_STEP_SUMMARY
            echo "- Very short think times (0.1-0.6 seconds)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Spike Test Goals:**" >> $GITHUB_STEP_SUMMARY
            echo "- Test system recovery from traffic bursts" >> $GITHUB_STEP_SUMMARY
            echo "- Measure response time degradation" >> $GITHUB_STEP_SUMMARY
            echo "- Verify auto-scaling (if applicable)" >> $GITHUB_STEP_SUMMARY
            echo "- Allow temporary performance degradation" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Results dropdown
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary><strong>üìä Performance Metrics</strong></summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "k6-output.txt" ]; then
            echo "‚úÖ ${{ steps.test-config.outputs.TEST_NAME }} completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**Summary Statistics:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Get total iterations
            ITERATIONS=$(grep "iterations.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
            
            # Get HTTP metrics
            HTTP_REQS=$(grep "http_reqs.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
            
            # Get response time
            AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
            
            # Get p95 response time
            if grep -q "http_req_duration.*p\\(95\\)=" k6-output.txt; then
              P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" k6-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Get success rate
            if grep -q "checks_succeeded" k6-output.txt; then
              SUCCESS_RATE=$(grep "checks_succeeded" k6-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null)
              echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check thresholds
            if grep -q "thresholds on metrics.*have been crossed" k6-output.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Raw output dropdown
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìÑ View Raw Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -40 k6-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "‚ùå No test output found. Test may have failed to run." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "### üìù Report Information" >> $GITHUB_STEP_SUMMARY
        echo "- Generated at: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- Test Type: ${{ steps.test-config.outputs.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- Workflow Run: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
