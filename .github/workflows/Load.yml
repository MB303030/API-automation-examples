name: K6 Load Test

on: workflow_dispatch

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Run K6 Load Test
      run: |
        docker run --rm -i grafana/k6 run - < tests/performance/load/dummyjson-load.js 2>&1 | tee k6-output.txt
        
    - name: Create Load Test Report
      run: |
        echo "## ðŸš€ K6 LOAD TEST Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Load Pattern Chart (10-minute test)
        echo "### ðŸ“ˆ Load Pattern (10-minute Business Simulation)" >> $GITHUB_STEP_SUMMARY
        echo '```mermaid' >> $GITHUB_STEP_SUMMARY
        echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
        echo '    title "Business Hours Load Simulation"' >> $GITHUB_STEP_SUMMARY
        echo '    x-axis [0m, 2m, 4m, 6m, 9m, 11m, 12m]' >> $GITHUB_STEP_SUMMARY
        echo '    y-axis "Virtual Users" 0 --> 120' >> $GITHUB_STEP_SUMMARY
        echo '    line [0, 20, 50, 80, 100, 40, 10]' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Load Test Configuration Table
        echo "### âš™ï¸ Load Test Configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Morning Ramp-up | 0-2m | 0 â†’ 20 | Business opening |" >> $GITHUB_STEP_SUMMARY
        echo "| Mid-morning | 2-4m | 20 â†’ 50 | Increasing traffic |" >> $GITHUB_STEP_SUMMARY
        echo "| Pre-lunch Peak | 4-6m | 50 â†’ 80 | High activity |" >> $GITHUB_STEP_SUMMARY
        echo "| Lunch Peak | 6-9m | 80 â†’ 100 | Maximum load |" >> $GITHUB_STEP_SUMMARY
        echo "| Afternoon Decline | 9-11m | 100 â†’ 40 | Post-lunch dip |" >> $GITHUB_STEP_SUMMARY
        echo "| Evening Wind-down | 11-12m | 40 â†’ 10 | Business closing |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Performance Requirements
        echo "### ðŸŽ¯ Performance Requirements" >> $GITHUB_STEP_SUMMARY
        echo "- **Response Time:** 95% of requests < 300ms" >> $GITHUB_STEP_SUMMARY
        echo "- **Success Rate:** > 99.9% (failure rate < 0.1%)" >> $GITHUB_STEP_SUMMARY
        echo "- **Throughput:** > 100 requests/second" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Duration:** 12 minutes" >> $GITHUB_STEP_SUMMARY
        echo "- **Max Concurrent Users:** 100" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add Results
        echo "### ðŸ“Š Load Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f "k6-output.txt" ]; then
          echo "âœ… Load test completed!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Show the summary section from K6 output
          echo "=== LOAD TEST SUMMARY ===" >> $GITHUB_STEP_SUMMARY
          grep -A30 "â–ˆ TOTAL RESULTS" k6-output.txt | head -40 >> $GITHUB_STEP_SUMMARY || echo "No detailed results found" >> $GITHUB_STEP_SUMMARY
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Threshold Check
          echo "### âœ… Threshold Results" >> $GITHUB_STEP_SUMMARY
          if grep -q "thresholds on metrics.*have been crossed" k6-output.txt; then
            echo "âŒ **SOME THRESHOLDS FAILED**" >> $GITHUB_STEP_SUMMARY
            grep -B2 -A2 "thresholds on metrics.*have been crossed" k6-output.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **ALL THRESHOLDS PASSED**" >> $GITHUB_STEP_SUMMARY
          fi
          
        else
          echo "âŒ No test output found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload Full Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-load-test-results
        path: k6-output.txt
        retention-days: 30
