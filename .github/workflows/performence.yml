name: API CI and Performence

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Job 1: Functional API tests with Playwright
  functional-tests:
    runs-on: ubuntu-latest
    name: Functional Tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ­ Install Playwright
      run: npx playwright install chromium

    - name: ğŸ”§ Setup API environment variables
      run: |
        echo "API_KEY=test-key-${{ github.run_id }}" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://template.postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: ğŸ§ª Run Playwright API tests
      run: npx playwright test

    - name: ğŸ“¤ Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # Job 2: Performance tests (K6) - Only on schedule or manual trigger
  performance-tests:
    runs-on: ubuntu-latest
    name: Performance Tests
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Check Docker availability
      run: |
        echo "ğŸ” Checking Docker for K6 tests..."
        docker --version
        echo "âœ… Docker available"
        
    - name: ğŸ” Validate K6 test files
      run: |
        echo "ğŸ“‹ Validating K6 test files..."
        if [ ! -d "tests/performance" ]; then
          echo "âš ï¸ No performance tests directory found"
          exit 0  # Exit successfully, just skip
        fi
        
        # Check for smoke test
        if [ -f "tests/performance/smoke/dummyjson-smoke.js" ]; then
          echo "âœ… Found smoke test: tests/performance/smoke/dummyjson-smoke.js"
          
          # Run smoke test
          echo "ğŸš€ Running K6 smoke test..."
          docker run --rm -i grafana/k6 run - < tests/performance/smoke/dummyjson-smoke.js
        else
          echo "â„¹ï¸ No smoke test found"
        fi
        
        # Check for load test
        if [ -f "tests/performance/load/dummyjson-load.js" ]; then
          echo "âœ… Found load test: tests/performance/load/dummyjson-load.js"
        else
          echo "â„¹ï¸ No load test found"
        fi
        
    - name: ğŸ“Š Generate performance summary
      if: always()
      run: |
        echo "## ğŸš€ Performance Tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Configured and ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Available Tests:" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "tests/performance" ]; then
          find tests/performance -name "*.js" -type f | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "No performance tests found in \`tests/performance/\`" >> $GITHUB_STEP_SUMMARY
        fi
