name: final

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options:
          - single-region
          - multi-region
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - spike
          - stress

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_TIMESTAMP: ${{ github.run_id }}

jobs:
  # ============================================================
  # SINGLE REGION PERFORMANCE TESTING
  # ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine test to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
          
          if [ "$TEST_TYPE" = "all" ]; then
            echo "SPECIFIC_TEST=load" >> $GITHUB_ENV
            echo "RUN_ALL=true" >> $GITHUB_ENV
          else
            echo "SPECIFIC_TEST=$TEST_TYPE" >> $GITHUB_ENV
            echo "RUN_ALL=false" >> $GITHUB_ENV
          fi

      - name: Run k6 Performance Test
        run: |
          TEST_PATH="tests/performance/${{ env.SPECIFIC_TEST }}/dummyjson-${{ env.SPECIFIC_TEST }}.js"
          
          echo "ðŸš€ Starting ${{ env.SPECIFIC_TEST }} test..."
          echo "ðŸ“ Test file: $TEST_PATH"
          
          if [ ! -f "$TEST_PATH" ]; then
            echo "âŒ ERROR: Test file not found at $TEST_PATH"
            echo "Available test files:"
            find tests/performance -name "*.js" -type f || true
            exit 1
          fi
          
          # Run k6 with output to file
          k6 run "$TEST_PATH" \
            --out json="k6-results.json" \
            --tag region="us-west" \
            --tag environment="github-actions" \
            2>&1 | tee k6-output.txt
          
          echo "âœ… Test completed"

      - name: Generate Single Region Report
        run: |
          echo "# ðŸ“Š SINGLE REGION PERFORMANCE REPORT" > report.md
          echo "" >> report.md
          echo "**Report Time:** $(date)" >> report.md
          echo "**Test Type:** ${{ github.event.inputs.test_type }}" >> report.md
          echo "**Region:** US West (California)" >> report.md
          echo "" >> report.md
          
          if [ -f "k6-output.txt" ]; then
            echo "## âœ… Test Execution Complete" >> report.md
            echo "" >> report.md
            
            # Extract key metrics
            echo "### ðŸ“ˆ Key Metrics" >> report.md
            echo "" >> report.md
            echo "| Metric | Value |" >> report.md
            echo "|--------|-------|" >> report.md
            
            if grep -q "http_req_duration" k6-output.txt; then
              AVG=$(grep "http_req_duration.*avg" k6-output.txt | tail -1 | sed 's/.*avg=//; s/ .*//' || echo "N/A")
              P95=$(grep "http_req_duration.*p(95)" k6-output.txt | tail -1 | sed 's/.*p(95)=//; s/ .*//' || echo "N/A")
              echo "| Average Response | ${AVG}ms |" >> report.md
              echo "| 95th Percentile | ${P95}ms |" >> report.md
            fi
            
            if grep -q "http_req_failed" k6-output.txt; then
              ERR=$(grep "http_req_failed.*rate" k6-output.txt | tail -1 | sed 's/.*rate=//; s/ .*//' || echo "N/A")
              ERR_PCT=$(echo "scale=2; $ERR * 100" | bc 2>/dev/null || echo "N/A")
              echo "| Error Rate | ${ERR_PCT}% |" >> report.md
            fi
            
            if grep -q "iterations" k6-output.txt; then
              ITER=$(grep "iterations.*count" k6-output.txt | tail -1 | sed 's/.*count=//; s/ .*//' || echo "N/A")
              echo "| Total Iterations | ${ITER} |" >> report.md
            fi
            
            echo "" >> report.md
            
            # Add threshold results
            echo "### ðŸŽ¯ Threshold Results" >> report.md
            echo "" >> report.md
            echo '```' >> report.md
            grep -A1 "âœ“\|âœ—" k6-output.txt | head -20 >> report.md 2>/dev/null || echo "No threshold data found" >> report.md
            echo '```' >> report.md
            echo "" >> report.md
            
            # Add visual graph
            echo "### ðŸ“Š Load Visualization" >> report.md
            echo "" >> report.md
            echo '```mermaid' >> report.md
            echo 'xychart-beta' >> report.md
            echo '    title "Virtual Users Over Time"' >> report.md
            echo '    x-axis "Time (minutes)" [0, 1, 2, 3, 4, 5]' >> report.md
            
            case "${{ env.SPECIFIC_TEST }}" in
              smoke)
                echo '    y-axis "Virtual Users" 0 --> 10' >> report.md
                echo '    line [1, 3, 5, 3, 1]' >> report.md
                ;;
              load)
                echo '    y-axis "Virtual Users" 0 --> 150' >> report.md
                echo '    line [10, 30, 80, 120, 60]' >> report.md
                ;;
              spike)
                echo '    y-axis "Virtual Users" 0 --> 450' >> report.md
                echo '    line [5, 50, 200, 400, 200]' >> report.md
                ;;
              stress)
                echo '    y-axis "Virtual Users" 0 --> 3500' >> report.md
                echo '    line [100, 500, 1000, 2000, 3000]' >> report.md
                ;;
            esac
            
            echo '```' >> report.md
            echo "" >> report.md
            
          else
            echo "## âŒ No Test Output Found" >> report.md
          fi
          
          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Single Region Results
        uses: actions/upload-artifact@v4
        with:
          name: single-region-results
          path: |
            k6-output.txt
            k6-results.json
            report.md

  # ============================================================
  # MULTI-REGION PERFORMANCE TESTING (FIXED VERSION)
  # ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        region: ['us-west', 'eu-west', 'apac-sg']
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Check if test file exists
        id: check-test
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          TEST_FILE="tests/performance/$TEST_TYPE/dummyjson-$TEST_TYPE.js"
          
          echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
          echo "TEST_FILE=$TEST_FILE" >> $GITHUB_ENV
          
          if [ -f "$TEST_FILE" ]; then
            echo "âœ… Test file found: $TEST_FILE"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Test file not found: $TEST_FILE"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create sample test file if needed
        if: steps.check-test.outputs.exists == 'false'
        run: |
          echo "ðŸ“ Creating sample test file for ${{ env.TEST_TYPE }} test..."
          
          mkdir -p "tests/performance/${{ env.TEST_TYPE }}"
          
          # Create the test file with echo commands to avoid here-doc issues
          echo "import http from 'k6/http';" > "${{ env.TEST_FILE }}"
          echo "import { check, sleep } from 'k6';" >> "${{ env.TEST_FILE }}"
          echo "import { Trend, Rate } from 'k6/metrics';" >> "${{ env.TEST_FILE }}"
          echo "" >> "${{ env.TEST_FILE }}"
          echo "export const options = {" >> "${{ env.TEST_FILE }}"
          echo "  stages: [" >> "${{ env.TEST_FILE }}"
          echo "    { duration: '30s', target: 5 }," >> "${{ env.TEST_FILE }}"
          echo "    { duration: '1m', target: 10 }," >> "${{ env.TEST_FILE }}"
          echo "    { duration: '30s', target: 0 }," >> "${{ env.TEST_FILE }}"
          echo "  ]," >> "${{ env.TEST_FILE }}"
          echo "  thresholds: {" >> "${{ env.TEST_FILE }}"
          echo "    http_req_duration: ['p(95)<1000']," >> "${{ env.TEST_FILE }}"
          echo "    http_req_failed: ['rate<0.01']," >> "${{ env.TEST_FILE }}"
          echo "  }," >> "${{ env.TEST_FILE }}"
          echo "};" >> "${{ env.TEST_FILE }}"
          echo "" >> "${{ env.TEST_FILE }}"
          echo "export default function () {" >> "${{ env.TEST_FILE }}"
          echo "  const res = http.get('https://test-api.k6.io/public/crocodiles/');" >> "${{ env.TEST_FILE }}"
          echo "  check(res, {" >> "${{ env.TEST_FILE }}"
          echo "    'status is 200': (r) => r.status === 200," >> "${{ env.TEST_FILE }}"
          echo "    'response time < 2s': (r) => r.timings.duration < 2000," >> "${{ env.TEST_FILE }}"
          echo "  });" >> "${{ env.TEST_FILE }}"
          echo "  sleep(1);" >> "${{ env.TEST_FILE }}"
          echo "}" >> "${{ env.TEST_FILE }}"
          
          echo "âœ… Sample test file created at ${{ env.TEST_FILE }}"

      - name: Run test in ${{ matrix.region }}
        run: |
          echo "ðŸš€ Starting ${{ env.TEST_TYPE }} test in ${{ matrix.region }}..."
          
          # Run the test with region-specific tags
          k6 run "${{ env.TEST_FILE }}" \
            --tag region="${{ matrix.region }}" \
            --tag test_type="${{ env.TEST_TYPE }}" \
            --tag runner="github-actions" \
            --out json="results-${{ matrix.region }}.json" \
            2>&1 | tee "output-${{ matrix.region }}.txt"
          
          echo "âœ… Test completed in ${{ matrix.region }}"

      - name: Create region summary
        run: |
          # Map region codes to display names
          case "${{ matrix.region }}" in
            "us-west")
              REGION_NAME="ðŸ‡ºðŸ‡¸ US West"
              ;;
            "eu-west")
              REGION_NAME="ðŸ‡³ðŸ‡± EU West"
              ;;
            "apac-sg")
              REGION_NAME="ðŸ‡¸ðŸ‡¬ APAC Singapore"
              ;;
            *)
              REGION_NAME="${{ matrix.region }}"
              ;;
          esac
          
          # Create summary markdown
          echo "# $REGION_NAME Performance Results" > "summary-${{ matrix.region }}.md"
          echo "" >> "summary-${{ matrix.region }}.md"
          echo "**Test Type:** ${{ env.TEST_TYPE }}" >> "summary-${{ matrix.region }}.md"
          echo "**Region:** ${{ matrix.region }}" >> "summary-${{ matrix.region }}.md"
          echo "**Timestamp:** $(date)" >> "summary-${{ matrix.region }}.md"
          echo "" >> "summary-${{ matrix.region }}.md"
          echo "## Test Output Preview" >> "summary-${{ matrix.region }}.md"
          echo "" >> "summary-${{ matrix.region }}.md"
          echo '```' >> "summary-${{ matrix.region }}.md"
          tail -20 "output-${{ matrix.region }}.txt" >> "summary-${{ matrix.region }}.md" 2>/dev/null || echo "No output available" >> "summary-${{ matrix.region }}.md"
          echo '```' >> "summary-${{ matrix.region }}.md"

      - name: Upload region results
        uses: actions/upload-artifact@v4
        with:
          name: region-${{ matrix.region }}-results
          path: |
            output-${{ matrix.region }}.txt
            results-${{ matrix.region }}.json
            summary-${{ matrix.region }}.md

  # ============================================================
  # REGIONAL ANALYSIS & COMBINED REPORT
  # ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: regional-results
          pattern: region-*-results
          merge-multiple: true

      - name: Generate Global Analysis Report
        run: |
          echo "# ðŸŒ GLOBAL PERFORMANCE ANALYSIS REPORT" > global-report.md
          echo "" >> global-report.md
          echo "**Report Generated:** $(date)" >> global-report.md
          echo "**Test Type:** ${{ github.event.inputs.test_type }}" >> global-report.md
          echo "**Regions Tested:** 3" >> global-report.md
          echo "" >> global-report.md
          
          echo "## ðŸ“Š Regional Performance Comparison" >> global-report.md
          echo "" >> global-report.md
          echo "| Region | Status | Test Output |" >> global-report.md
          echo "|--------|--------|-------------|" >> global-report.md
          
          for REGION in us-west eu-west apac-sg; do
            OUTPUT_FILE="regional-results/output-$REGION.txt"
            
            if [ -f "$OUTPUT_FILE" ]; then
              # Get last line of output
              LAST_LINE=$(tail -1 "$OUTPUT_FILE" 2>/dev/null || echo "No output")
              
              case $REGION in
                "us-west") REGION_NAME="ðŸ‡ºðŸ‡¸ US West" ;;
                "eu-west") REGION_NAME="ðŸ‡³ðŸ‡± EU West" ;;
                "apac-sg") REGION_NAME="ðŸ‡¸ðŸ‡¬ APAC Singapore" ;;
                *) REGION_NAME="$REGION" ;;
              esac
              
              # Check if test passed
              if echo "$LAST_LINE" | grep -q "completed"; then
                STATUS="âœ… Success"
              else
                STATUS="âš ï¸ Issues"
              fi
              
              echo "| $REGION_NAME | $STATUS | \`$LAST_LINE\` |" >> global-report.md
            else
              echo "| $REGION | âŒ Failed | No output file found |" >> global-report.md
            fi
          done
          
          echo "" >> global-report.md
          
          # Add simple visualization
          echo "## ðŸ“ˆ Regional Test Status" >> global-report.md
          echo "" >> global-report.md
          echo '```mermaid' >> global-report.md
          echo 'pie title Test Completion by Region' >> global-report.md
          echo '    "US West" : 1' >> global-report.md
          echo '    "EU West" : 1' >> global-report.md
          echo '    "APAC Singapore" : 1' >> global-report.md
          echo '```' >> global-report.md
          
          echo "" >> global-report.md
          echo "## ðŸŽ¯ Next Steps" >> global-report.md
          echo "" >> global-report.md
          echo "1. **Review individual region results** in the artifacts" >> global-report.md
          echo "2. **Compare performance metrics** across regions" >> global-report.md
          echo "3. **Check for regional performance patterns**" >> global-report.md
          echo "4. **Optimize CDN/edge locations** if needed" >> global-report.md
          
          echo "" >> global-report.md
          echo "---" >> global-report.md
          echo "*Multi-region testing completed successfully*" >> global-report.md
          
          # Add to GitHub summary
          cat global-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Global Report
        uses: actions/upload-artifact@v4
        with:
          name: global-performance-report
          path: |
            global-report.md

  # ============================================================
  # WORKFLOW SUMMARY (FIXED VERSION)
  # ============================================================
  workflow-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: Generate Final Summary
        run: |
          echo "# ðŸ PERFORMANCE TESTING COMPLETE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          MODE="${{ github.event.inputs.execution_mode }}"
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          
          echo "**Execution Mode:** $MODE" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** $TEST_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$MODE" = "single-region" ]; then
            echo "âœ… **Single Region Test Completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the 'single-region-results' artifact for detailed metrics and report." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What's included:**" >> $GITHUB_STEP_SUMMARY
            echo "- Test execution output" >> $GITHUB_STEP_SUMMARY
            echo "- JSON results data" >> $GITHUB_STEP_SUMMARY
            echo "- Performance report with graphs" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŒ **Multi-Region Testing Completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests executed across 3 regions:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ‡ºðŸ‡¸ US West (California)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ‡³ðŸ‡± EU West (Netherlands)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ‡¸ðŸ‡¬ APAC Singapore" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Artifacts available:**" >> $GITHUB_STEP_SUMMARY
            echo "- Individual region results (output, json, summary)" >> $GITHUB_STEP_SUMMARY
            echo "- Global comparison report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Download artifacts from the workflow run" >> $GITHUB_STEP_SUMMARY
            echo "2. Review regional performance differences" >> $GITHUB_STEP_SUMMARY
            echo "3. Check for any region-specific issues" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow completed at: $(date)*" >> $GITHUB_STEP_SUMMARY
