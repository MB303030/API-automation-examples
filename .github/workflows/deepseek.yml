name: single region 

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options:
          - single-region
          - multi-region
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike
          - stress

jobs:
  # ============================================================
  # SINGLE REGION PERFORMANCE TESTING (ORIGINAL WORKFLOW)
  # ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      # ----------------------------------------------------
      # Setup k6 NATIVELY (NO DOCKER)
      # ----------------------------------------------------
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # ----------------------------------------------------
      # Decide which tests to run
      # ----------------------------------------------------
      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"

          if [ "$TEST_TYPE" = "smoke" ]; then
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            echo "RUN_STRESS=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "load" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            echo "RUN_STRESS=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "spike" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
            echo "RUN_STRESS=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "stress" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            echo "RUN_STRESS=true" >> $GITHUB_ENV
          else
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
            echo "RUN_STRESS=true" >> $GITHUB_ENV
          fi

      # ----------------------------------------------------
      # Run selected tests with NATIVE k6 (NO DOCKER)
      # ----------------------------------------------------
      - name: Run Selected Performance Tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
            ["stress"]="tests/performance/stress/dummyjson-stress.js"
          )

          for TEST in smoke load spike stress; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              echo "üöÄ Running ${TEST^} test..."
              echo "Test file: ${TESTS[$TEST]}"
              
              if [ ! -f "${TESTS[$TEST]}" ]; then
                echo "‚ùå Error: File ${TESTS[$TEST]} not found!"
                echo "Available files in tests/:"
                find tests -name "*.js" -type f | head -20
                continue
              fi
              
              k6 run "${TESTS[$TEST]}" \
                --out json="k6-${TEST}-results.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ ${TEST^} test completed successfully"
              else
                echo "‚ùå ${TEST^} test failed"
              fi
            fi
          done

      # ----------------------------------------------------
      # Report: GRAPH + REAL DATA + SMART ANALYSIS
      # ----------------------------------------------------
      - name: Create Performance Report
        run: |
          # Function to render each test WITH GRAPHS
          render_test() {
            NAME=$1
            TITLE=$2
            MAX_VUS=$3
            LINE=$4
            OUTPUT_FILE="k6-${NAME}-output.txt"
            
            if [ -f "$OUTPUT_FILE" ]; then
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## üöÄ ${TITLE} Test Analysis" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # üéØ GRAPH SECTION
              echo "### üìà Load Pattern Visualization" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**How we simulated real users:**" >> $GITHUB_STEP_SUMMARY
              echo '```mermaid' >> $GITHUB_STEP_SUMMARY
              echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
              echo "    title \"${TITLE} Test - Virtual Users Over Time\"" >> $GITHUB_STEP_SUMMARY
              
              # Different time scales based on test type
              if [ "$NAME" = "stress" ]; then
                echo '    x-axis "Time (minutes)" [0, 2, 4, 6, 8, 10]' >> $GITHUB_STEP_SUMMARY
              else
                echo '    x-axis "Time (minutes)" [0, 1, 2, 3, 4, 5, 6, 7]' >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
              echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # üìä REAL TEST RESULTS SECTION
              echo "### üîç What Actually Happened During This Load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # 1. Get ALL threshold results
              THRESHOLD_COUNT=$(grep -c "‚úì\|‚úó" "$OUTPUT_FILE" 2>/dev/null || echo 0)
              
              if [ "$THRESHOLD_COUNT" -gt 0 ]; then
                echo "**üéØ Performance Targets (${THRESHOLD_COUNT} checked):**" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A1 "‚úì\|‚úó" "$OUTPUT_FILE" | head -20 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 2. CRITICAL METRICS TABLE
              echo "### üìä Critical Metrics Dashboard" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Result | Target | Status |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
              
              # User Experience Metric
              if grep -q "rate>0.85\|rate>0.7" "$OUTPUT_FILE"; then
                RATE_LINE=$(grep "rate>0.85\|rate>0.7" "$OUTPUT_FILE" | tail -1)
                ACTUAL_RATE=$(echo "$RATE_LINE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                if echo "$RATE_LINE" | grep -q "‚ùå"; then
                  echo "| üë• User Experience | ${ACTUAL_RATE}% | >85% | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| üë• User Experience | ${ACTUAL_RATE}% | >85% | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Error Rate Metric
              if grep -q "rate<0.10\|rate<0.3" "$OUTPUT_FILE"; then
                RATE_LINE=$(grep "rate<0.10\|rate<0.3" "$OUTPUT_FILE" | tail -1)
                ACTUAL_RATE=$(echo "$RATE_LINE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                if echo "$RATE_LINE" | grep -q "‚ùå"; then
                  echo "| üö® Error Rate | ${ACTUAL_RATE}% | <10% | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| üö® Error Rate | ${ACTUAL_RATE}% | <10% | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Response Time P95
              if grep -q "p(95)<2000\|p(95)<10000" "$OUTPUT_FILE"; then
                P95_LINE=$(grep "p(95)<2000\|p(95)<10000" "$OUTPUT_FILE" | tail -1)
                ACTUAL_P95=$(echo "$P95_LINE" | sed 's/.*p(95)=//; s/ms//' | tr -d ' ')
                if echo "$P95_LINE" | grep -q "‚ùå"; then
                  echo "| ‚ö° Response Time (P95) | ${ACTUAL_P95}ms | <2000ms | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| ‚ö° Response Time (P95) | ${ACTUAL_P95}ms | <2000ms | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Response Time P99
              if grep -q "p(99)<4000" "$OUTPUT_FILE"; then
                P99_LINE=$(grep "p(99)<4000" "$OUTPUT_FILE" | tail -1)
                ACTUAL_P99=$(echo "$P99_LINE" | sed 's/.*p(99)=//; s/ms//' | tr -d ' ')
                if echo "$P99_LINE" | grep -q "‚ùå"; then
                  echo "| üê¢ Response Time (P99) | ${ACTUAL_P99}ms | <4000ms | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| üê¢ Response Time (P99) | ${ACTUAL_P99}ms | <4000ms | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Stress-specific: Failure Rate
              if [ "$NAME" = "stress" ]; then
                if grep -q "stress_failure_rate" "$OUTPUT_FILE"; then
                  FAIL_LINE=$(grep "'stress_failure_rate'" "$OUTPUT_FILE" | tail -1)
                  ACTUAL_FAIL=$(echo "$FAIL_LINE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                  if echo "$FAIL_LINE" | grep -q "‚ùå"; then
                    echo "| üí• Critical Failure Rate | ${ACTUAL_FAIL}% | <5% | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üí• Critical Failure Rate | ${ACTUAL_FAIL}% | <5% | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # 3. FUNCTIONAL CHECKS
              echo "### ‚úÖ Functional Checks During Load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Page Load Check
              if grep -q "page loaded" "$OUTPUT_FILE"; then
                PAGE_LINE=$(grep -A1 "page loaded" "$OUTPUT_FILE")
                echo "**üì± Page Load Success:**" >> $GITHUB_STEP_SUMMARY
                echo "$PAGE_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Product Load Check
              if grep -q "product loaded\|product has valid data" "$OUTPUT_FILE"; then
                PRODUCT_LINE=$(grep -A1 "product loaded\|product has valid data" "$OUTPUT_FILE")
                echo "**üõçÔ∏è Product Page Access:**" >> $GITHUB_STEP_SUMMARY
                echo "$PRODUCT_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 4. PLAIN ENGLISH ANALYSIS
              echo "### üß† Impact Analysis" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Stress-specific analysis
              if [ "$NAME" = "stress" ]; then
                if grep -q "‚ùå.*stress_failure_rate" "$OUTPUT_FILE"; then
                  RATE=$(grep "‚ùå.*stress_failure_rate" "$OUTPUT_FILE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                  echo "üí• **STRESS TEST FINDING - SYSTEM FAILURE:**" >> $GITHUB_STEP_SUMMARY
                  echo "- **The Problem:** ${RATE}% critical failures under extreme load" >> $GITHUB_STEP_SUMMARY
                  echo "- **What It Means:** System cannot handle ${MAX_VUS} concurrent users" >> $GITHUB_STEP_SUMMARY
                  echo "- **Business Impact:** Complete outage during traffic surges" >> $GITHUB_STEP_SUMMARY
                  echo "- **Breaking Point:** System failed around $((MAX_VUS * 2/3)) users" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                elif grep -q "‚úÖ.*stress_failure_rate" "$OUTPUT_FILE"; then
                  echo "‚úÖ **STRESS TEST FINDING - RESILIENT SYSTEM:**" >> $GITHUB_STEP_SUMMARY
                  echo "- **The Good News:** System handles ${MAX_VUS} users without critical failures" >> $GITHUB_STEP_SUMMARY
                  echo "- **What It Means:** Safety margin exists beyond normal peak load" >> $GITHUB_STEP_SUMMARY
                  echo "- **Business Impact:** Can survive unexpected traffic spikes" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # 5. ACTIONABLE RECOMMENDATIONS
              echo "### üéØ Recommended Actions" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "$NAME" = "stress" ]; then
                if grep -q "‚ùå.*stress_failure_rate" "$OUTPUT_FILE"; then
                  echo "üö® **CRITICAL INFRASTRUCTURE ISSUE**" >> $GITHUB_STEP_SUMMARY
                  echo "1. **INVESTIGATE** database connection limits and API timeouts" >> $GITHUB_STEP_SUMMARY
                  echo "2. **SCALE HORIZONTALLY** - add more instances before breaking point" >> $GITHUB_STEP_SUMMARY
                  echo "3. **IMPLEMENT** rate limiting and graceful degradation" >> $GITHUB_STEP_SUMMARY
                  echo "4. **MONITOR** production for similar patterns" >> $GITHUB_STEP_SUMMARY
                elif grep -q "‚úÖ.*stress_failure_rate" "$OUTPUT_FILE"; then
                  echo "üèÜ **EXCELLENT RESILIENCE**" >> $GITHUB_STEP_SUMMARY
                  echo "1. **CONFIRM** infrastructure can handle 3x normal load" >> $GITHUB_STEP_SUMMARY
                  echo "2. **DOCUMENT** breaking point for capacity planning" >> $GITHUB_STEP_SUMMARY
                  echo "3. **CELEBRATE** robust system architecture" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          echo "# üìä K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üìÖ Report Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**üéØ Test Type:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**üåç Test Mode:** Single Region (US)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Quick summary table at the top
          echo "## üìã Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status | Peak Load | Key Finding |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${RUN_SMOKE}" = "true" ] && [ -f "k6-smoke-output.txt" ]; then
            if grep -q "‚úì" "k6-smoke-output.txt"; then STATUS="‚úÖ PASS"; else STATUS="‚ùå FAIL"; fi
            echo "| Smoke | $STATUS | 5 users | Basic functionality check |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${RUN_LOAD}" = "true" ] && [ -f "k6-load-output.txt" ]; then
            if grep -q "‚úì" "k6-load-output.txt"; then STATUS="‚úÖ PASS"; else STATUS="‚ùå FAIL"; fi
            echo "| Load | $STATUS | 120 users | Sustained performance |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${RUN_SPIKE}" = "true" ] && [ -f "k6-spike-output.txt" ]; then
            if grep -q "‚ùå 'rate<0.10'" "k6-spike-output.txt"; then
              STATUS="üî¥ CRITICAL"
              RATE=$(grep "‚ùå 'rate<0.10'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              FINDING="${RATE}% error rate"
            elif grep -q "‚ùå 'rate>0.85'" "k6-spike-output.txt"; then
              STATUS="üü° WARNING"
              RATE=$(grep "‚ùå 'rate>0.85'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              FINDING="${RATE}% good UX"
            else
              STATUS="‚úÖ PASS"
              FINDING="All targets met"
            fi
            echo "| Spike | $STATUS | 400 users | $FINDING |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${RUN_STRESS}" = "true" ] && [ -f "k6-stress-output.txt" ]; then
            if grep -q "‚ùå.*stress_failure_rate" "k6-stress-output.txt"; then
              STATUS="üî• BREAKING"
              RATE=$(grep "‚ùå.*stress_failure_rate" "k6-stress-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              FINDING="Breaking point at ${RATE}% failures"
            elif grep -q "‚úÖ.*stress_failure_rate" "k6-stress-output.txt"; then
              STATUS="‚úÖ RESILIENT"
              FINDING="Handles extreme load"
            else
              STATUS="‚ö†Ô∏è INCONCLUSIVE"
              FINDING="No stress metric found"
            fi
            echo "| Stress | $STATUS | 3000 users | $FINDING |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Render detailed test reports
          if [ "${RUN_SMOKE}" = "true" ]; then
            render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"
          fi
          
          if [ "${RUN_LOAD}" = "true" ]; then
            render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"
          fi
          
          if [ "${RUN_SPIKE}" = "true" ]; then
            render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"
          fi
          
          if [ "${RUN_STRESS}" = "true" ]; then
            render_test "stress" "Stress" 3000 "[100, 500, 1000, 2000, 3000, 100, 0]"
          fi
          
          # üèÜ FINAL DECISION WITH GRAPH CONTEXT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# üèÜ Deployment Decision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use stress test results for final decision if available
          if [ -f "k6-stress-output.txt" ]; then
            echo "## üìà Based on Stress Test Results (3000 Users):" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Visual decision helper
            echo "### üìä Decision Matrix - Stress Test" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'quadrantChart' >> $GITHUB_STEP_SUMMARY
            echo '    title "System Resilience Under Extreme Load"' >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "Graceful Degradation" --> "Catastrophic Failure"' >> $GITHUB_STEP_SUMMARY
            echo '    y-axis "Low Impact" --> "High Impact"' >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå.*stress_failure_rate" "k6-stress-output.txt"; then
              echo '    quadrant-1 "Do Not Deploy"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-2 "Investigate Urgently"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-3 "Monitor"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-4 "Critical Fix Required"' >> $GITHUB_STEP_SUMMARY
              echo '    "Current System": [0.8, 0.9]' >> $GITHUB_STEP_SUMMARY
              echo "    Our stress test shows **critical failures** at 3x normal load - system breaks catastrophically" >> $GITHUB_STEP_SUMMARY
            elif grep -q "‚úÖ.*stress_failure_rate" "k6-stress-output.txt"; then
              echo '    quadrant-1 "Ready for High Traffic"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-2 "Proceed with Confidence"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-3 "Do Not Deploy"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-4 "Investigate"' >> $GITHUB_STEP_SUMMARY
              echo '    "Current System": [0.2, 0.3]' >> $GITHUB_STEP_SUMMARY
              echo "    Our stress test shows **excellent resilience** at 3x normal load" >> $GITHUB_STEP_SUMMARY
            else
              echo '    quadrant-1 "Proceed with Caution"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-2 "Do Not Deploy"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-3 "Monitor"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-4 "Investigate"' >> $GITHUB_STEP_SUMMARY
              echo '    "Current System": [0.5, 0.6]' >> $GITHUB_STEP_SUMMARY
              echo "    Our stress test shows **mixed results** at extreme load" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Final verdict based on stress test
            echo "### ‚öñÔ∏è Final Verdict (Stress Test)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå.*stress_failure_rate" "k6-stress-output.txt"; then
              echo "üî¥ **DO NOT DEPLOY - SYSTEM BREAKS UNDER PRESSURE**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** System fails catastrophically at 3x normal load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'Under extreme conditions (3000+ users), the system breaks completely. We need architectural improvements before launch.'" >> $GITHUB_STEP_SUMMARY
              
            elif grep -q "‚úÖ.*stress_failure_rate" "k6-stress-output.txt"; then
              echo "üü¢ **READY FOR DEPLOYMENT - RESILIENT SYSTEM**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** System handles 3x normal load without critical failures" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'Even under extreme load (3000 users), the system remains stable. We have a good safety margin for unexpected traffic.'" >> $GITHUB_STEP_SUMMARY
              
            else
              echo "üü° **DEPLOY WITH MONITORING**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** Stress test results inconclusive" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'System handles normal load well but needs monitoring during extreme events.'" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ -f "k6-spike-output.txt" ]; then
            # Fallback to spike test for decision if no stress test
            echo "## üìà Based on Spike Test Results (400 Users):" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ‚öñÔ∏è Final Verdict (Spike Test)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå 'rate<0.10' rate=90.49%" "k6-spike-output.txt"; then
              echo "üî¥ **DO NOT DEPLOY**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** 90% error rate at 400 user load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'The website crashes when 400+ users visit. We need to fix this before any launch.'" >> $GITHUB_STEP_SUMMARY
              
            elif grep -q "‚ùå 'rate>0.85' rate=34.19%" "k6-spike-output.txt"; then
              echo "üü° **DEPLOY WITH CAUTION**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** Poor user experience (34%) at 400 users" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'The website works but gets slow for many users during busy times. We should improve this soon.'" >> $GITHUB_STEP_SUMMARY
              
            else
              echo "üü¢ **READY FOR DEPLOYMENT**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** All performance targets met at 400 user load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'Performance tests show the website handles busy periods well. We're ready to launch.'" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report includes: üìà Load graphs + üìä Real metrics + üß† Smart analysis*" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # MULTI-REGION PERFORMANCE TESTING
  # ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    defaults:
      run:
        shell: bash

    strategy:
      matrix:
        runner: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - runner: ubuntu-latest
            region_label: "US West (California)"
            region_id: us-west
            region_emoji: "üá∫üá∏"
          - runner: windows-latest
            region_label: "EU West (Netherlands)"
            region_id: eu-west
            region_emoji: "üá≥üá±"
          - runner: macos-latest
            region_label: "Asia Pacific (Singapore)"
            region_id: apac-sg
            region_emoji: "üá∏üá¨"

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine test path
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
          
          if [ "$TEST_TYPE" = "all" ]; then
            echo "SPECIFIC_TEST=load" >> $GITHUB_ENV  # Default to load test for multi-region
            echo "NOTE=Running load test as representative for multi-region comparison" >> $GITHUB_ENV
          else
            echo "SPECIFIC_TEST=$TEST_TYPE" >> $GITHUB_ENV
            echo "NOTE=Running $TEST_TYPE test across regions" >> $GITHUB_ENV
          fi

      - name: Run ${{ env.SPECIFIC_TEST }} test from ${{ matrix.region_label }}
        run: |
          TEST_PATH="tests/performance/${{ env.SPECIFIC_TEST }}/dummyjson-${{ env.SPECIFIC_TEST }}.js"
          
          echo "${{ matrix.region_emoji }} üìç Region: ${{ matrix.region_label }}"
          echo "üìÅ Test: ${{ env.SPECIFIC_TEST }}"
          echo "üìÑ Path: $TEST_PATH"
          
          if [ ! -f "$TEST_PATH" ]; then
            echo "‚ùå Error: Test file not found at $TEST_PATH"
            echo "Available tests:"
            find tests/performance -name "*.js" -type f
            exit 1
          fi
          
          echo "üöÄ Starting test in ${{ matrix.region_label }}..."
          
          # Run k6 with regional tagging
          k6 run "$TEST_PATH" \
            --tag region="${{ matrix.region_id }}" \
            --tag region_name="${{ matrix.region_label }}" \
            --out json="results-${{ matrix.region_id }}.json" \
            --summary-export="summary-${{ matrix.region_id }}.json" \
            2>&1 | tee "output-${{ matrix.region_id }}.txt"
          
          echo "‚úÖ Test completed in ${{ matrix.region_label }}"

      - name: Upload regional results
        uses: actions/upload-artifact@v4
        with:
          name: regional-results-${{ matrix.region_id }}
          path: |
            results-${{ matrix.region_id }}.json
            summary-${{ matrix.region_id }}.json
            output-${{ matrix.region_id }}.txt
          retention-days: 7

      - name: Create regional summary
        run: |
          # Extract key metrics from output
          OUTPUT_FILE="output-${{ matrix.region_id }}.txt"
          SUMMARY_FILE="summary-${{ matrix.region_id }}.json"
          
          echo "üìä Creating regional summary for ${{ matrix.region_label }}..."
          
          # Create a simple markdown summary
          cat > "summary-${{ matrix.region_id }}.md" << EOF
          # ${{ matrix.region_emoji }} ${{ matrix.region_label }} Performance Results
          
          **Test Type:** ${{ env.SPECIFIC_TEST }}
          **Region ID:** ${{ matrix.region_id }}
          **Runner:** ${{ matrix.runner }}
          
          ## Key Metrics
          
          EOF
          
          # Extract metrics from k6 output if available
          if [ -f "$OUTPUT_FILE" ]; then
            # Get threshold results
            if grep -q "thresholds" "$OUTPUT_FILE"; then
              echo "### Threshold Results" >> "summary-${{ matrix.region_id }}.md"
              echo '```' >> "summary-${{ matrix.region_id }}.md"
              grep -A3 "thresholds" "$OUTPUT_FILE" | head -20 >> "summary-${{ matrix.region_id }}.md"
              echo '```' >> "summary-${{ matrix.region_id }}.md"
              echo "" >> "summary-${{ matrix.region_id }}.md"
            fi
            
            # Get HTTP metrics
            if grep -q "http_req_duration" "$OUTPUT_FILE"; then
              echo "### Response Times" >> "summary-${{ matrix.region_id }}.md"
              echo '```' >> "summary-${{ matrix.region_id }}.md"
              grep -E "(http_req_duration|iteration_duration)" "$OUTPUT_FILE" | grep -E "(avg|med|p\(90\)|p\(95\))" | head -10 >> "summary-${{ matrix.region_id }}.md"
              echo '```' >> "summary-${{ matrix.region_id }}.md"
            fi
          fi
          
          echo "‚úÖ Regional summary created"

      - name: Upload regional summary
        uses: actions/upload-artifact@v4
        with:
          name: regional-summary-${{ matrix.region_id }}
          path: summary-${{ matrix.region_id }}.md
          retention-days: 7

  # ============================================================
  # COMBINED REGIONAL ANALYSIS & REPORT
  # ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc curl

      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: regional-results-*
          merge-multiple: true

      - name: Download all regional summaries
        uses: actions/download-artifact@v4
        with:
          path: all-summaries
          pattern: regional-summary-*
          merge-multiple: true

      - name: Create comprehensive regional report
        run: |
          echo "# üåç Global Performance Analysis Report" > GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "**üìÖ Report Generated:** $(date)" >> GLOBAL_REPORT.md
          echo "**üéØ Test Type:** ${{ github.event.inputs.test_type }}" >> GLOBAL_REPORT.md
          echo "**üåê Regions Tested:** 3 (US, EU, APAC)" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # EXECUTIVE SUMMARY
          echo "## üìã Executive Summary" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "This report compares performance across 3 global regions. Understanding regional performance helps ensure consistent user experience worldwide." >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # REGIONAL COMPARISON TABLE
          echo "## üìä Regional Performance Comparison" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "| Region | Avg Response | p95 Response | Error Rate | VUs Max | Status |" >> GLOBAL_REPORT.md
          echo "|--------|--------------|--------------|------------|---------|--------|" >> GLOBAL_REPORT.md
          
          # Arrays to store data for charts
          REGIONS=()
          AVG_TIMES=()
          P95_TIMES=()
          ERROR_RATES=()
          
          for REGION_ID in us-west eu-west apac-sg; do
            SUMMARY_FILE="all-results/summary-${REGION_ID}.json"
            
            if [ -f "$SUMMARY_FILE" ]; then
              # Parse JSON metrics
              AVG=$(jq -r '.metrics.http_req_duration.values.avg // "N/A"' "$SUMMARY_FILE")
              P95=$(jq -r '.metrics.http_req_duration.values."p(95)" // "N/A"' "$SUMMARY_FILE")
              ERR=$(jq -r '.metrics.http_req_failed.values.rate // 0' "$SUMMARY_FILE")
              MAX_VUS=$(jq -r '.metrics.vus.values.max // "N/A"' "$SUMMARY_FILE")
              
              # Calculate error percentage
              ERR_PCT=$(echo "scale=2; $ERR * 100" | bc 2>/dev/null || echo "0.00")
              
              # Determine status
              if [ "$AVG" != "N/A" ] && [ "$ERR_PCT" != "0.00" ]; then
                if (( $(echo "$ERR_PCT > 5" | bc -l 2>/dev/null || echo 0) )); then
                  STATUS="üî¥ High Errors"
                elif (( $(echo "$AVG > 2000" | bc -l 2>/dev/null || echo 0) )); then
                  STATUS="üü° Slow Response"
                else
                  STATUS="‚úÖ Good"
                fi
              else
                STATUS="‚ö™ Unknown"
              fi
              
              # Get region label
              case $REGION_ID in
                us-west)
                  REGION_LABEL="üá∫üá∏ US West"
                  ;;
                eu-west)
                  REGION_LABEL="üá≥üá± EU West"
                  ;;
                apac-sg)
                  REGION_LABEL="üá∏üá¨ APAC Singapore"
                  ;;
                *)
                  REGION_LABEL="$REGION_ID"
                  ;;
              esac
              
              echo "| $REGION_LABEL | ${AVG}ms | ${P95}ms | ${ERR_PCT}% | $MAX_VUS | $STATUS |" >> GLOBAL_REPORT.md
              
              # Store for charts (only if we have numeric data)
              if [[ "$AVG" =~ ^[0-9]+(\.[0-9]+)?$ ]] && [[ "$P95" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
                REGIONS+=("\"$REGION_ID\"")
                AVG_TIMES+=("$AVG")
                P95_TIMES+=("$P95")
                ERROR_RATES+=("$ERR_PCT")
              fi
            else
              echo "| $REGION_ID | ‚ùå No Data | ‚ùå No Data | ‚ùå No Data | ‚ùå No Data | ‚ö´ Missing |" >> GLOBAL_REPORT.md
            fi
          done
          
          echo "" >> GLOBAL_REPORT.md
          
          # VISUAL COMPARISON CHARTS
          echo "## üìà Visual Regional Comparison" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          if [ ${#REGIONS[@]} -gt 0 ]; then
            # Chart 1: Response Time Comparison
            echo "### ‚è±Ô∏è Average Response Time by Region" >> GLOBAL_REPORT.md
            echo '```mermaid' >> GLOBAL_REPORT.md
            echo 'xychart-beta' >> GLOBAL_REPORT.md
            echo '    title "Regional Response Time Comparison (Lower is Better)"' >> GLOBAL_REPORT.md
            echo "    x-axis ${REGIONS[*]}" >> GLOBAL_REPORT.md
            echo '    y-axis "Response Time (ms)" 0 --> 3000' >> GLOBAL_REPORT.md
            echo "    bar [${AVG_TIMES[*]}]" >> GLOBAL_REPORT.md
            echo '```' >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Chart 2: P95 Comparison
            echo "### üìä 95th Percentile Response Time" >> GLOBAL_REPORT.md
            echo '```mermaid' >> GLOBAL_REPORT.md
            echo 'xychart-beta' >> GLOBAL_REPORT.md
            echo '    title "P95 Response Time - Worst 5% of Requests (Lower is Better)"' >> GLOBAL_REPORT.md
            echo "    x-axis ${REGIONS[*]}" >> GLOBAL_REPORT.md
            echo '    y-axis "Response Time (ms)" 0 --> 5000' >> GLOBAL_REPORT.md
            echo "    line [${P95_TIMES[*]}]" >> GLOBAL_REPORT.md
            echo '```' >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Chart 3: Error Rate Comparison
            echo "### üö® Error Rate by Region" >> GLOBAL_REPORT.md
            echo '```mermaid' >> GLOBAL_REPORT.md
            echo 'xychart-beta' >> GLOBAL_REPORT.md
            echo '    title "Error Rate Comparison (Lower is Better)"' >> GLOBAL_REPORT.md
            echo "    x-axis ${REGIONS[*]}" >> GLOBAL_REPORT.md
            echo '    y-axis "Error Rate (%)" 0 --> 100' >> GLOBAL_REPORT.md
            echo "    bar [${ERROR_RATES[*]}]" >> GLOBAL_REPORT.md
            echo '```' >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
          fi
          
          # GEOGRAPHICAL PERFORMANCE MAP
          echo "### üó∫Ô∏è Geographical Performance Heatmap" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "```mermaid" >> GLOBAL_REPORT.md
          echo "quadrantChart" >> GLOBAL_REPORT.md
          echo "    title \"Global Performance Distribution\"" >> GLOBAL_REPORT.md
          echo "    x-axis \"West\" --> \"East\"" >> GLOBAL_REPORT.md
          echo "    y-axis \"North\" --> \"South\"" >> GLOBAL_REPORT.md
          echo "    quadrant-1 \"Optimal Performance\"" >> GLOBAL_REPORT.md
          echo "    quadrant-2 \"Good Performance\"" >> GLOBAL_REPORT.md
          echo "    quadrant-3 \"Needs Improvement\"" >> GLOBAL_REPORT.md
          echo "    quadrant-4 \"Investigate\"" >> GLOBAL_REPORT.md
          
          # Place regions on the map based on their performance
          for i in "${!REGIONS[@]}"; do
            REGION_ID="${REGIONS[$i]//\"/}"
            AVG_TIME="${AVG_TIMES[$i]}"
            ERROR_RATE="${ERROR_RATES[$i]}"
            
            # Calculate position based on performance
            # Better performance = lower left quadrant
            if (( $(echo "$AVG_TIME < 1000 && $ERROR_RATE < 5" | bc -l 2>/dev/null || echo 0) )); then
              X="0.2"
              Y="0.2"
              LABEL="‚≠ê Excellent"
            elif (( $(echo "$AVG_TIME < 2000 && $ERROR_RATE < 10" | bc -l 2>/dev/null || echo 0) )); then
              X="0.3"
              Y="0.4"
              LABEL="‚úÖ Good"
            elif (( $(echo "$ERROR_RATE > 20" | bc -l 2>/dev/null || echo 0) )); then
              X="0.8"
              Y="0.8"
              LABEL="üî¥ Critical"
            else
              X="0.6"
              Y="0.6"
              LABEL="üü° Needs Work"
            fi
            
            # Get proper region name
            case $REGION_ID in
              us-west)
                NAME="US West"
                ;;
              eu-west)
                NAME="EU West"
                ;;
              apac-sg)
                NAME="APAC SG"
                ;;
              *)
                NAME="$REGION_ID"
                ;;
            esac
            
            echo "    \"$NAME ($AVG_TIME ms, ${ERROR_RATE}% err)\": [$X, $Y]" >> GLOBAL_REPORT.md
          done
          
          echo "```" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # REGIONAL INSIGHTS
          echo "## üß† Regional Performance Insights" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Find best and worst performing regions
          BEST_REGION=""
          BEST_AVG=999999
          WORST_REGION=""
          WORST_AVG=0
          
          for i in "${!REGIONS[@]}"; do
            REGION_ID="${REGIONS[$i]//\"/}"
            AVG_TIME="${AVG_TIMES[$i]}"
            
            if (( $(echo "$AVG_TIME < $BEST_AVG" | bc -l 2>/dev/null || echo 0) )); then
              BEST_AVG="$AVG_TIME"
              BEST_REGION="$REGION_ID"
            fi
            
            if (( $(echo "$AVG_TIME > $WORST_AVG" | bc -l 2>/dev/null || echo 0) )); then
              WORST_AVG="$AVG_TIME"
              WORST_REGION="$REGION_ID"
            fi
          done
          
          if [ -n "$BEST_REGION" ] && [ -n "$WORST_REGION" ]; then
            echo "### üèÜ Performance Leader" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "**$BEST_REGION** shows the best performance with average response time of **${BEST_AVG}ms**." >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            echo "### ‚ö†Ô∏è Area Needing Attention" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "**$WORST_REGION** has the slowest response time at **${WORST_AVG}ms**." >> GLOBAL_REPORT.md
            
            # Calculate performance gap
            GAP=$(echo "$WORST_AVG - $BEST_AVG" | bc 2>/dev/null || echo "0")
            GAP_PERCENT=$(echo "scale=0; ($GAP / $BEST_AVG) * 100" | bc 2>/dev/null || echo "0")
            
            if (( $(echo "$GAP_PERCENT > 50" | bc -l 2>/dev/null || echo 0) )); then
              echo "" >> GLOBAL_REPORT.md
              echo "> üö® **Significant Performance Gap Detected:** The slowest region is **${GAP_PERCENT}% slower** than the fastest region. This indicates potential CDN or regional infrastructure issues." >> GLOBAL_REPORT.md
            fi
          fi
          
          echo "" >> GLOBAL_REPORT.md
          
          # ACTIONABLE RECOMMENDATIONS
          echo "## üéØ Global Deployment Recommendations" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Check if any region has critical issues
          CRITICAL_ISSUES=0
          for i in "${!REGIONS[@]}"; do
            ERROR_RATE="${ERROR_RATES[$i]}"
            if (( $(echo "$ERROR_RATE > 10" | bc -l 2>/dev/null || echo 0) )); then
              CRITICAL_ISSUES=1
            fi
          done
          
          if [ $CRITICAL_ISSUES -eq 1 ]; then
            echo "### üî¥ Critical Findings" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "1. **Regional CDN Required:** High error rates in some regions suggest need for regional CDN deployment" >> GLOBAL_REPORT.md
            echo "2. **Database Replication:** Consider read replicas in slow-performing regions" >> GLOBAL_REPORT.md
            echo "3. **Geo-DNS Setup:** Implement DNS-based routing to closest healthy region" >> GLOBAL_REPORT.md
            echo "4. **Regional Monitoring:** Set up alerts for region-specific performance degradation" >> GLOBAL_REPORT.md
          else
            echo "### üü¢ Positive Findings" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "1. **Global Readiness:** System performs consistently across major regions" >> GLOBAL_REPORT.md
            echo "2. **CDN Effectiveness:** Current CDN setup appears to be working well" >> GLOBAL_REPORT.md
            echo "3. **Scalability Confirmed:** System can handle load from multiple regions simultaneously" >> GLOBAL_REPORT.md
            echo "4. **Deployment Green Light:** Safe to deploy globally with current architecture" >> GLOBAL_REPORT.md
          fi
          
          echo "" >> GLOBAL_REPORT.md
          
          # FINAL DECISION MATRIX
          echo "## ‚öñÔ∏è Global Deployment Decision" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "Based on multi-region testing, here's our recommendation:" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          echo "```mermaid" >> GLOBAL_REPORT.md
          echo "quadrantChart" >> GLOBAL_REPORT.md
          echo "    title \"Global Deployment Readiness\"" >> GLOBAL_REPORT.md
          echo "    x-axis \"Regional Consistency\" --> \"Regional Variance\"" >> GLOBAL_REPORT.md
          echo "    y-axis \"Good Performance\" --> \"Poor Performance\"" >> GLOBAL_REPORT.md
          
          # Calculate overall scores
          TOTAL_REGIONS=${#REGIONS[@]}
          if [ $TOTAL_REGIONS -gt 0 ]; then
            SUM_AVG=0
            SUM_ERROR=0
            for i in "${!AVG_TIMES[@]}"; do
              SUM_AVG=$(echo "$SUM_AVG + ${AVG_TIMES[$i]}" | bc 2>/dev/null || echo "$SUM_AVG")
              SUM_ERROR=$(echo "$SUM_ERROR + ${ERROR_RATES[$i]}" | bc 2>/dev/null || echo "$SUM_ERROR")
            done
            
            AVG_OVERALL=$(echo "scale=0; $SUM_AVG / $TOTAL_REGIONS" | bc 2>/dev/null || echo "0")
            ERROR_OVERALL=$(echo "scale=0; $SUM_ERROR / $TOTAL_REGIONS" | bc 2>/dev/null || echo "0")
            
            # Determine quadrant
            if (( $(echo "$ERROR_OVERALL > 10" | bc -l 2>/dev/null || echo 0) )); then
              echo "    quadrant-1 \"Do Not Deploy\"" >> GLOBAL_REPORT.md
              echo "    quadrant-2 \"Regional Rollout Only\"" >> GLOBAL_REPORT.md
              echo "    quadrant-3 \"Investigate Regional Issues\"" >> GLOBAL_REPORT.md
              echo "    quadrant-4 \"Fix Critical Issues\"" >> GLOBAL_REPORT.md
              echo "    \"Current Performance\": [0.8, 0.8]" >> GLOBAL_REPORT.md
              echo "    **Recommendation:** üî¥ Fix regional issues before global deployment" >> GLOBAL_REPORT.md
            elif (( $(echo "$AVG_OVERALL > 2000" | bc -l 2>/dev/null || echo 0) )); then
              echo "    quadrant-1 \"Optimize Performance\"" >> GLOBAL_REPORT.md
              echo "    quadrant-2 \"Regional Deployment First\"" >> GLOBAL_REPORT.md
              echo "    quadrant-3 \"Do Not Deploy\"" >> GLOBAL_REPORT.md
              echo "    quadrant-4 \"Investigate\"" >> GLOBAL_REPORT.md
              echo "    \"Current Performance\": [0.6, 0.6]" >> GLOBAL_REPORT.md
              echo "    **Recommendation:** üü° Deploy with performance monitoring" >> GLOBAL_REPORT.md
            else
              echo "    quadrant-1 \"Ready for Global Launch\"" >> GLOBAL_REPORT.md
              echo "    quadrant-2 \"Proceed with Confidence\"" >> GLOBAL_REPORT.md
              echo "    quadrant-3 \"Regional Testing Required\"" >> GLOBAL_REPORT.md
              echo "    quadrant-4 \"Do Not Deploy\"" >> GLOBAL_REPORT.md
              echo "    \"Current Performance\": [0.2, 0.3]" >> GLOBAL_REPORT.md
              echo "    **Recommendation:** üü¢ Safe for global deployment" >> GLOBAL_REPORT.md
            fi
          fi
          
          echo "```" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Add to GitHub Summary
          cat GLOBAL_REPORT.md >> $GITHUB_STEP_SUMMARY
          
          echo "‚úÖ Global analysis report created"

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: global-performance-report
          path: |
            GLOBAL_REPORT.md
            all-results/
            all-summaries/
          retention-days: 30

      - name: Deploy report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          keep_files: false
          force_orphan: true
