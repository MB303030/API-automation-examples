name: Debug K6 Performance Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Determine which tests to run
      id: test-selection
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"
        
        if [ "$TEST_TYPE" = "smoke" ]; then
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "load" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "spike" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        else  # "all"
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        fi
        
        echo "Selected test type: $TEST_TYPE"
        echo "Run Smoke: ${{ env.RUN_SMOKE }}"
        echo "Run Load: ${{ env.RUN_LOAD }}"
        echo "Run Spike: ${{ env.RUN_SPIKE }}"
    
    - name: Run Smoke Test (if selected)
      if: env.RUN_SMOKE == 'true'
      run: |
        echo "ðŸš€ Running Smoke Test..."
        docker run --rm -v $(pwd):/scripts -w /scripts grafana/k6 run tests/performance/smoke/dummyjson-smoke.js 2>&1 | tee k6-smoke-output.txt
        echo "âœ… Smoke test completed!"
    
    - name: Run Load Test (if selected)
      if: env.RUN_LOAD == 'true'
      run: |
        echo "ðŸš€ Running Load Test..."
        docker run --rm -v $(pwd):/scripts -w /scripts grafana/k6 run tests/performance/load/dummyjson-load.js 2>&1 | tee k6-load-output.txt
        echo "âœ… Load test completed!"
    
    - name: Run Spike Test (if selected)
      if: env.RUN_SPIKE == 'true'
      run: |
        echo "ðŸš€ Running Spike Test..."
        docker run --rm -v $(pwd):/scripts -w /scripts grafana/k6 run tests/performance/spike/dummyjson-spike.js 2>&1 | tee k6-spike-output.txt
        echo "âœ… Spike test completed!"
    
    - name: Check for Test Errors
      if: always()
      run: |
        echo "=== Checking for errors in test outputs ==="
        for test in smoke load spike; do
          output_file="k6-${test}-output.txt"
          if [ -f "$output_file" ]; then
            echo "--- $test test output (first 100 lines) ---"
            head -100 "$output_file"
            echo "--- End of $test test output ---"
          else
            echo "No output file for $test test."
          fi
        done
    
    - name: Create Dynamic Report with Chart
      run: |
        echo "## ðŸ§ª Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Smoke Test Section
        if [ "${{ env.RUN_SMOKE }}" = "true" ] && [ -f "k6-smoke-output.txt" ]; then
          echo "### ðŸš¦ Smoke Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Chart for Smoke Test
          echo "#### ðŸ“ˆ Load Pattern: Quick Health Check" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo '    title "Smoke Test: Quick Health Check (2 minutes)"' >> $GITHUB_STEP_SUMMARY
          echo '    x-axis "[0s, 15s, 45s, 90s, 110s]"' >> $GITHUB_STEP_SUMMARY
          echo '    y-axis "Virtual Users" 0 --> 10' >> $GITHUB_STEP_SUMMARY
          echo '    line [0, 1, 3, 5, 0]' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration Table for Smoke Test
          echo "#### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Warm-up | 0-15s | 0 â†’ 1 | Initial ramp-up |" >> $GITHUB_STEP_SUMMARY
          echo "| Steady Load | 15-45s | 1 â†’ 3 | Gradual increase |" >> $GITHUB_STEP_SUMMARY
          echo "| Peak | 45-90s | 3 â†’ 5 | Maximum load |" >> $GITHUB_STEP_SUMMARY
          echo "| Cool-down | 90-110s | 5 â†’ 0 | Gradual shutdown |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Endpoints Tested:**" >> $GITHUB_STEP_SUMMARY
          echo "1. **GET /products** - Product listing with pagination" >> $GITHUB_STEP_SUMMARY
          echo "2. **GET /products/{id}** - Single product details" >> $GITHUB_STEP_SUMMARY
          echo "3. **GET /products/search** - Product search functionality" >> $GITHUB_STEP_SUMMARY
          echo "4. **GET /products/categories** - All product categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Smoke Test Goals:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Verify API is responding (status 200)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validate JSON response structure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Check response times are acceptable" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ensure no critical errors occur" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Results for Smoke Test
          echo "#### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Smoke Test completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Performance Indicators:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Extract metrics from k6-smoke-output.txt
          ITERATIONS=$(grep "iterations.*:" k6-smoke-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
          
          HTTP_REQS=$(grep "http_reqs.*:" k6-smoke-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
          
          AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-smoke-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "http_req_duration.*p\\(95\\)=" k6-smoke-output.txt; then
            P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" k6-smoke-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "checks_succeeded" k6-smoke-output.txt; then
            SUCCESS_RATE=$(grep "checks_succeeded" k6-smoke-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null)
            echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "thresholds on metrics.*have been crossed" k6-smoke-output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detailed output for Smoke Test
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view full Smoke Test output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 k6-smoke-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Load Test Section
        if [ "${{ env.RUN_LOAD }}" = "true" ] && [ -f "k6-load-output.txt" ]; then
          echo "### ðŸ”„ Load Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Chart for Load Test
          echo "#### ðŸ“ˆ Load Pattern: Business Hours Simulation" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo '    title "Load Test: Business Hours Simulation (15 minutes)"' >> $GITHUB_STEP_SUMMARY
          echo '    x-axis "[0m, 2m, 4m, 8m, 11m, 13m, 15m]"' >> $GITHUB_STEP_SUMMARY
          echo '    y-axis "Virtual Users" 0 --> 140' >> $GITHUB_STEP_SUMMARY
          echo '    line [10, 10, 30, 80, 120, 60, 20]' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration Table for Load Test
          echo "#### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Early Morning | 0-2m | 0 â†’ 10 | Business opening |" >> $GITHUB_STEP_SUMMARY
          echo "| Morning Ramp-up | 2-4m | 10 â†’ 30 | Increasing traffic |" >> $GITHUB_STEP_SUMMARY
          echo "| Lunch Hour Peak | 4-8m | 30 â†’ 80 | High activity |" >> $GITHUB_STEP_SUMMARY
          echo "| Afternoon Peak | 8-11m | 80 â†’ 120 | Maximum load |" >> $GITHUB_STEP_SUMMARY
          echo "| Evening Decline | 11-13m | 120 â†’ 60 | Post-lunch dip |" >> $GITHUB_STEP_SUMMARY
          echo "| Late Night | 13-15m | 60 â†’ 20 | Business closing |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Performance Requirements:**" >> $GITHUB_STEP_SUMMARY
          echo "- Response Time: p(95) < 500ms" >> $GITHUB_STEP_SUMMARY
          echo "- Success Rate: > 99%" >> $GITHUB_STEP_SUMMARY
          echo "- Failure Rate: < 1%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Results for Load Test
          echo "#### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Load Test completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Performance Indicators:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Extract metrics from k6-load-output.txt
          ITERATIONS=$(grep "iterations.*:" k6-load-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
          
          HTTP_REQS=$(grep "http_reqs.*:" k6-load-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
          
          AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-load-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "http_req_duration.*p\\(95\\)=" k6-load-output.txt; then
            P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" k6-load-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "checks_succeeded" k6-load-output.txt; then
            SUCCESS_RATE=$(grep "checks_succeeded" k6-load-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null)
            echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "thresholds on metrics.*have been crossed" k6-load-output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detailed output for Load Test
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view full Load Test output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 k6-load-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Spike Test Section
        if [ "${{ env.RUN_SPIKE }}" = "true" ] && [ -f "k6-spike-output.txt" ]; then
          echo "### âš¡ Spike Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Chart for Spike Test
          echo "#### ðŸ“ˆ Load Pattern: Sudden Traffic Burst" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo '    title "Spike Test: Sudden Traffic Burst (3.5 minutes)"' >> $GITHUB_STEP_SUMMARY
          echo '    x-axis "[0s, 15s, 30s, 60s, 90s, 120s, 150s, 180s, 210s]"' >> $GITHUB_STEP_SUMMARY
          echo '    y-axis "Virtual Users" 0 --> 450' >> $GITHUB_STEP_SUMMARY
          echo '    line [5, 5, 50, 200, 400, 400, 200, 50, 10]' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration Table for Spike Test
          echo "#### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Normal Traffic | 0-15s | 5 | Baseline activity |" >> $GITHUB_STEP_SUMMARY
          echo "| Initial Spike | 15-30s | 5 â†’ 50 | Sudden traffic burst |" >> $GITHUB_STEP_SUMMARY
          echo "| Rapid Growth | 30-60s | 50 â†’ 200 | Exponential growth |" >> $GITHUB_STEP_SUMMARY
          echo "| Peak Traffic | 60-90s | 200 â†’ 400 | Maximum burst load |" >> $GITHUB_STEP_SUMMARY
          echo "| Sustained Peak | 90-120s | 400 | Continued high load |" >> $GITHUB_STEP_SUMMARY
          echo "| Initial Decline | 120-150s | 400 â†’ 200 | Gradual recovery |" >> $GITHUB_STEP_SUMMARY
          echo "| Recovery | 150-180s | 200 â†’ 50 | Continued recovery |" >> $GITHUB_STEP_SUMMARY
          echo "| Back to Normal | 180-210s | 50 â†’ 10 | Return to baseline |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Spike Test Goals:**" >> $GITHUB_STEP_SUMMARY
          echo "- Test system recovery from traffic bursts" >> $GITHUB_STEP_SUMMARY
          echo "- Measure response time degradation" >> $GITHUB_STEP_SUMMARY
          echo "- Verify auto-scaling (if applicable)" >> $GITHUB_STEP_SUMMARY
          echo "- Allow temporary performance degradation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Results for Spike Test
          echo "#### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Spike Test completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Performance Indicators:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Extract metrics from k6-spike-output.txt
          ITERATIONS=$(grep "iterations.*:" k6-spike-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
          
          HTTP_REQS=$(grep "http_reqs.*:" k6-spike-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
          
          AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-spike-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "http_req_duration.*p\\(95\\)=" k6-spike-output.txt; then
            P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" k6-spike-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "checks_succeeded" k6-spike-output.txt; then
            SUCCESS_RATE=$(grep "checks_succeeded" k6-spike-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null)
            echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -q "thresholds on metrics.*have been crossed" k6-spike-output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detailed output for Spike Test
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view full Spike Test output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 k6-spike-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "*Test Type: ${{ github.event.inputs.test_type }}*" >> $GITHUB_STEP_SUMMARY
