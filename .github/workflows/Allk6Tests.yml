name: All K6 Performance Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'spike'
        type: choice
        options:
          - spike
          - smoke
          - load

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set Test Configuration
      id: test-config
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"
        
        case $TEST_TYPE in
          "smoke")
            echo "TEST_FILE=tests/performance/smoke/dummyjson-smoke.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Smoke Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Smoke Test: Quick Health Check" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[0s, 30s, 60s]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[5, 10, 0]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=15" >> $GITHUB_OUTPUT
            ;;
          "load")
            echo "TEST_FILE=tests/performance/load/dummyjson-load.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Load Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Load Test: Business Day Simulation" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[0m, 2m, 5m, 7m, 10m, 12m]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[20, 50, 100, 50, 20, 0]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=120" >> $GITHUB_OUTPUT
            ;;
          "spike")
            # Using your actual spike test file location
            echo "TEST_FILE=tests/performance/dummyjson-spike.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Spike Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Spike Test: Sudden Traffic Burst" >> $GITHUB_OUTPUT
            # From your trafficPatterns.json: [30s, 1m, 1.5m, 2m, 2.5m]
            echo "CHART_X_AXIS=[0s, 30s, 90s, 120s, 180s, 210s]" >> $GITHUB_OUTPUT
            # Stages: 10 â†’ 200 â†’ 200 â†’ 50 â†’ 10
            echo "CHART_DATA=[10, 10, 200, 200, 50, 10]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=250" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "Selected: $TEST_TYPE"
        echo "Test File: ${{ steps.test-config.outputs.TEST_FILE }}"
        echo "Test Name: ${{ steps.test-config.outputs.TEST_NAME }}"
      
    - name: Run K6 Test
      run: |
        echo "ðŸš€ Running ${{ steps.test-config.outputs.TEST_NAME }}..."
        
        # Mount volumes for your file structure
        docker run --rm -i \
          -v $(pwd)/test-data:/scripts/test-data \
          -v $(pwd)/tests:/scripts/tests \
          -v $(pwd)/utils:/scripts/utils \
          grafana/k6 run /scripts/${{ steps.test-config.outputs.TEST_FILE }} 2>&1 | tee k6-output.txt
        
    - name: Create Dynamic Report with Chart
      run: |
        echo "## ðŸ§ª ${{ steps.test-config.outputs.TEST_NAME }} Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Dynamic Mermaid Chart based on test type
        echo "### ðŸ“ˆ Load Pattern: ${{ steps.test-config.outputs.CHART_TITLE }}" >> $GITHUB_STEP_SUMMARY
        echo '```mermaid' >> $GITHUB_STEP_SUMMARY
        echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
        echo "    title \"${{ steps.test-config.outputs.CHART_TITLE }}\"" >> $GITHUB_STEP_SUMMARY
        echo "    x-axis ${{ steps.test-config.outputs.CHART_X_AXIS }}" >> $GITHUB_STEP_SUMMARY
        echo "    y-axis \"Virtual Users\" 0 --> ${{ steps.test-config.outputs.CHART_MAX }}" >> $GITHUB_STEP_SUMMARY
        echo "    line ${{ steps.test-config.outputs.CHART_DATA }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Dynamic Phase Table based on test type
        echo "### âš™ï¸ Test Configuration: ${{ steps.test-config.outputs.TEST_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.test_type }}" = "smoke" ]; then
          echo "| Parameter | Value | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Smoke Test | Basic health check |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | 60 seconds | Quick verification |" >> $GITHUB_STEP_SUMMARY
          echo "| Virtual Users | 5 â†’ 10 | Minimal load |" >> $GITHUB_STEP_SUMMARY
          echo "| Purpose | Verify API is working | Not performance testing |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | p(95) < 500ms | Quick response required |" >> $GITHUB_STEP_SUMMARY
          
        elif [ "${{ github.event.inputs.test_type }}" = "load" ]; then
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Morning Ramp-up | 0-2m | 20 â†’ 50 | Business opening |" >> $GITHUB_STEP_SUMMARY
          echo "| Mid-morning | 2-5m | 50 â†’ 100 | Peak business hours |" >> $GITHUB_STEP_SUMMARY
          echo "| Sustained Load | 5-7m | 100 | Maximum load |" >> $GITHUB_STEP_SUMMARY
          echo "| Afternoon Decline | 7-10m | 100 â†’ 20 | Post-lunch dip |" >> $GITHUB_STEP_SUMMARY
          echo "| Evening Wind-down | 10-12m | 20 â†’ 0 | Business closing |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Performance Requirements:**" >> $GITHUB_STEP_SUMMARY
          echo "- Response Time: p(95) < 300ms" >> $GITHUB_STEP_SUMMARY
          echo "- Success Rate: > 99.5%" >> $GITHUB_STEP_SUMMARY
          echo "- Throughput: > 50 req/sec" >> $GITHUB_STEP_SUMMARY
          
        elif [ "${{ github.event.inputs.test_type }}" = "spike" ]; then
          echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Normal Traffic | 0-30s | 10 | Baseline activity |" >> $GITHUB_STEP_SUMMARY
          echo "| Spike Start | 30-90s | 10 â†’ 200 | Sudden traffic burst |" >> $GITHUB_STEP_SUMMARY
          echo "| Peak Spike | 90-120s | 200 | Maximum burst load |" >> $GITHUB_STEP_SUMMARY
          echo "| Recovery | 120-180s | 200 â†’ 50 | Gradual recovery |" >> $GITHUB_STEP_SUMMARY
          echo "| Back to Normal | 180-210s | 50 â†’ 10 | Return to baseline |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Spike Test Goals:**" >> $GITHUB_STEP_SUMMARY
          echo "- Test system recovery from traffic bursts" >> $GITHUB_STEP_SUMMARY
          echo "- Measure response time degradation" >> $GITHUB_STEP_SUMMARY
          echo "- Verify auto-scaling (if applicable)" >> $GITHUB_STEP_SUMMARY
          echo "- Allow temporary performance degradation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Acceptable During Spike:**" >> $GITHUB_STEP_SUMMARY
          echo "- Response Time: p(95) < 1000ms" >> $GITHUB_STEP_SUMMARY
          echo "- Success Rate: > 90%" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add Results Section
        echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f "k6-output.txt" ]; then
          echo "âœ… ${{ steps.test-config.outputs.TEST_NAME }} completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract and display key metrics
          echo "**Key Performance Indicators:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Get total iterations
          ITERATIONS=$(grep "iterations.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
          
          # Get HTTP metrics
          HTTP_REQS=$(grep "http_reqs.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
          
          # Get response time
          AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          P95_RESPONSE=$(grep "http_req_duration.*p\(95\)=" k6-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "P95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
          
          # Get success rate
          if grep -q "checks" k6-output.txt; then
            CHECKS_TOTAL=$(grep "checks.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
            CHECKS_PASSED=$(grep "checks.*:" k6-output.txt | tail -1 | awk '{print $4}' | tr -d ',' 2>/dev/null || echo "0")
            if [ "$CHECKS_TOTAL" != "0" ] && [ "$CHECKS_TOTAL" != "N/A" ]; then
              SUCCESS_RATE=$(echo "scale=2; $CHECKS_PASSED * 100 / $CHECKS_TOTAL" | bc)
              echo "Success Rate: ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Get failure rate
          FAILURE_RATE=$(grep "http_req_failed" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Failure Rate: $FAILURE_RATE" >> $GITHUB_STEP_SUMMARY
          
          # Get throughput
          THROUGHPUT=$(grep "http_reqs.*rate=" k6-output.txt | tail -1 | sed 's/.*rate=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          echo "Throughput: $THROUGHPUT reqs/sec" >> $GITHUB_STEP_SUMMARY
          
          # Check thresholds
          if grep -q "thresholds on metrics.*have been crossed" k6-output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show full summary
          echo "**Detailed Summary:**" >> $GITHUB_STEP_SUMMARY
          echo '<details>' >> $GITHUB_STEP_SUMMARY
          echo '<summary>Click to view full test output</summary>' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 k6-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '</details>' >> $GITHUB_STEP_SUMMARY
          
        else
          echo "âŒ No test output found. Test may have failed to run." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "*Test Type: ${{ steps.test-config.outputs.TEST_NAME }}*" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: k6-test-results-${{ github.event.inputs.test_type }}
        path: |
          k6-output.txt
        retention-days: 30
