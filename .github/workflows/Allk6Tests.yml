name: ALL Performance Tests Suite

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - load
          - spike

jobs:
  performance-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Determine Tests to Run
      id: test-selection
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"
        
        if [ "$TEST_TYPE" = "all" ]; then
          echo "TEST_FILES=tests/performance/load/dummyjson-load.js tests/performance/spike/dummyjson-spike.js" >> $GITHUB_OUTPUT
          echo "TEST_NAMES=Load Test, Spike Test" >> $GITHUB_OUTPUT
          echo "RUN_ALL=true" >> $GITHUB_OUTPUT
        elif [ "$TEST_TYPE" = "load" ]; then
          echo "TEST_FILES=tests/performance/load/dummyjson-load.js" >> $GITHUB_OUTPUT
          echo "TEST_NAMES=Load Test" >> $GITHUB_OUTPUT
          echo "RUN_ALL=false" >> $GITHUB_OUTPUT
        elif [ "$TEST_TYPE" = "spike" ]; then
          echo "TEST_FILES=tests/performance/spike/dummyjson-spike.js" >> $GITHUB_OUTPUT
          echo "TEST_NAMES=Spike Test" >> $GITHUB_OUTPUT
          echo "RUN_ALL=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Selected: $TEST_TYPE"
        echo "Test Files: ${{ steps.test-selection.outputs.TEST_FILES }}"
    
    - name: Run Performance Tests
      id: run-tests
      run: |
        IFS=' ' read -ra TEST_FILES <<< "${{ steps.test-selection.outputs.TEST_FILES }}"
        IFS=',' read -ra TEST_NAMES <<< "${{ steps.test-selection.outputs.TEST_NAMES }}"
        
        for i in "${!TEST_FILES[@]}"; do
          TEST_FILE="${TEST_FILES[$i]}"
          TEST_NAME="${TEST_NAMES[$i]}"
          OUTPUT_FILE="k6-output-$(basename "$TEST_FILE" .js).txt"
          
          echo "ðŸš€ Running $TEST_NAME ($TEST_FILE)..."
          echo "--- Starting $TEST_NAME ---" > "$OUTPUT_FILE"
          
          # Run the K6 test
          if docker run --rm -i grafana/k6 run - < "$TEST_FILE" 2>&1 | tee -a "$OUTPUT_FILE"; then
            echo "âœ… $TEST_NAME completed successfully"
            echo "TEST_${i}_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ $TEST_NAME failed"
            echo "TEST_${i}_STATUS=failed" >> $GITHUB_ENV
          fi
          
          # Separate test outputs
          echo -e "\n\n" >> "$OUTPUT_FILE"
        done
    
    - name: Generate Performance Reports
      run: |
        echo "# ðŸ§ª Performance Test Suite Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        IFS=' ' read -ra TEST_FILES <<< "${{ steps.test-selection.outputs.TEST_FILES }}"
        IFS=',' read -ra TEST_NAMES <<< "${{ steps.test-selection.outputs.TEST_NAMES }}"
        
        for i in "${!TEST_FILES[@]}"; do
          TEST_FILE="${TEST_FILES[$i]}"
          TEST_NAME="${TEST_NAMES[$i]}"
          OUTPUT_FILE="k6-output-$(basename "$TEST_FILE" .js).txt"
          TEST_BASE_NAME="$(basename "$TEST_FILE" .js)"
          
          echo "## ðŸ“Š $TEST_NAME Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add test-specific chart based on test type
          if [[ "$TEST_NAME" == *"Load"* ]]; then
            echo "### ðŸ“ˆ Load Pattern: Business Hours Simulation" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo '    title "Load Test: Business Hours Simulation"' >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "[0m, 2m, 4m, 6m, 9m, 11m, 12m]"' >> $GITHUB_STEP_SUMMARY
            echo '    y-axis "Virtual Users" 0 --> 120' >> $GITHUB_STEP_SUMMARY
            echo '    line [0, 20, 50, 80, 100, 40, 10]' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Morning Ramp-up | 0-2m | 0 â†’ 20 | Business opening |" >> $GITHUB_STEP_SUMMARY
            echo "| Mid-morning | 2-4m | 20 â†’ 50 | Increasing traffic |" >> $GITHUB_STEP_SUMMARY
            echo "| Pre-lunch Peak | 4-6m | 50 â†’ 80 | High activity |" >> $GITHUB_STEP_SUMMARY
            echo "| Lunch Peak | 6-9m | 80 â†’ 100 | Maximum load |" >> $GITHUB_STEP_SUMMARY
            echo "| Afternoon Decline | 9-11m | 100 â†’ 40 | Post-lunch dip |" >> $GITHUB_STEP_SUMMARY
            echo "| Evening Wind-down | 11-12m | 40 â†’ 10 | Business closing |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Performance Requirements:**" >> $GITHUB_STEP_SUMMARY
            echo "- Response Time: p(95) < 300ms" >> $GITHUB_STEP_SUMMARY
            echo "- Success Rate: > 99.9%" >> $GITHUB_STEP_SUMMARY
            echo "- Throughput: > 100 req/sec" >> $GITHUB_STEP_SUMMARY
            
          elif [[ "$TEST_NAME" == *"Spike"* ]]; then
            echo "### ðŸ“ˆ Load Pattern: Sudden Traffic Burst" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo '    title "Spike Test: Sudden Traffic Burst"' >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "[0s, 30s, 90s, 120s, 180s, 210s]"' >> $GITHUB_STEP_SUMMARY
            echo '    y-axis "Virtual Users" 0 --> 250' >> $GITHUB_STEP_SUMMARY
            echo '    line [10, 10, 200, 200, 50, 10]' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Normal Traffic | 0-30s | 10 | Baseline activity |" >> $GITHUB_STEP_SUMMARY
            echo "| Spike Start | 30-90s | 10 â†’ 200 | Sudden traffic burst |" >> $GITHUB_STEP_SUMMARY
            echo "| Peak Spike | 90-120s | 200 | Maximum burst load |" >> $GITHUB_STEP_SUMMARY
            echo "| Recovery | 120-180s | 200 â†’ 50 | Gradual recovery |" >> $GITHUB_STEP_SUMMARY
            echo "| Back to Normal | 180-210s | 50 â†’ 10 | Return to baseline |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Spike Test Goals:**" >> $GITHUB_STEP_SUMMARY
            echo "- Test system recovery from traffic bursts" >> $GITHUB_STEP_SUMMARY
            echo "- Measure response time degradation" >> $GITHUB_STEP_SUMMARY
            echo "- Verify auto-scaling (if applicable)" >> $GITHUB_STEP_SUMMARY
            echo "- Allow temporary performance degradation" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Test Results" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$OUTPUT_FILE" ]; then
            echo "**Key Performance Indicators:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Extract metrics from the output file
            # Total iterations
            ITERATIONS=$(grep "iterations.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
            
            # HTTP requests
            HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
            echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
            
            # Average response time
            AVG_RESPONSE=$(grep "http_req_duration.*avg=" "$OUTPUT_FILE" | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
            
            # p95 response time
            P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
            echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
            
            # Success rate
            if grep -q "checks_succeeded" "$OUTPUT_FILE"; then
              SUCCESS_RATE=$(grep "checks_succeeded" "$OUTPUT_FILE" | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
              echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for threshold violations
            if grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Detailed output with expandable section
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to view detailed test output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Show last 40 lines of the test output
            tail -40 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âŒ No output file found for $TEST_NAME." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "## ðŸ“ˆ Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Performance test suite completed**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tests executed:**" >> $GITHUB_STEP_SUMMARY
        IFS=',' read -ra TEST_NAMES <<< "${{ steps.test-selection.outputs.TEST_NAMES }}"
        for name in "${TEST_NAMES[@]}"; do
          echo "- $name" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
