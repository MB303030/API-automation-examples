name: All K6 Performance Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'load'
        type: choice
        options:
          - load
          - spike
          - all

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set Test Configuration
      id: test-config
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"
        
        case $TEST_TYPE in
          "all")
            echo "RUN_ALL=true" >> $GITHUB_OUTPUT
            echo "TEST_NAME=All Tests (Load + Spike)" >> $GITHUB_OUTPUT
            ;;
          "load")
            echo "RUN_ALL=false" >> $GITHUB_OUTPUT
            echo "TEST_FILE=tests/performance/load/dummyjson-load.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Load Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Load Test: Business Hours Simulation" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[0m, 2m, 4m, 6m, 9m, 11m, 12m]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[0, 20, 50, 80, 100, 40, 10]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=120" >> $GITHUB_OUTPUT
            ;;
          "spike")
            echo "RUN_ALL=false" >> $GITHUB_OUTPUT
            echo "TEST_FILE=tests/performance/spike/dummyjson-spike.js" >> $GITHUB_OUTPUT
            echo "TEST_NAME=Spike Test" >> $GITHUB_OUTPUT
            echo "CHART_TITLE=Spike Test: Sudden Traffic Burst" >> $GITHUB_OUTPUT
            echo "CHART_X_AXIS=[0s, 30s, 90s, 120s, 180s, 210s]" >> $GITHUB_OUTPUT
            echo "CHART_DATA=[10, 10, 200, 200, 50, 10]" >> $GITHUB_OUTPUT
            echo "CHART_MAX=250" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "Selected: $TEST_TYPE"
        echo "Test Name: ${{ steps.test-config.outputs.TEST_NAME }}"
    
    - name: Run Single Test
      if: steps.test-config.outputs.RUN_ALL == 'false'
      run: |
        echo "ðŸš€ Running ${{ steps.test-config.outputs.TEST_NAME }}..."
        docker run --rm -i grafana/k6 run - < ${{ steps.test-config.outputs.TEST_FILE }} 2>&1 | tee k6-output.txt
    
    - name: Run All Tests
      if: steps.test-config.outputs.RUN_ALL == 'true'
      run: |
        echo "ðŸš€ Running ALL Tests..."
        echo "======================"
        
        # Create combined output
        echo "# Combined Test Results" > k6-output.txt
        echo "======================" >> k6-output.txt
        
        # Run Load Test
        if [ -f "tests/performance/load/dummyjson-load.js" ]; then
          echo "" >> k6-output.txt
          echo "=== LOAD TEST ===" >> k6-output.txt
          echo "" >> k6-output.txt
          
          echo "ðŸ§ª Running Load Test..."
          # Use volume mount for file access
          docker run --rm \
            -v $(pwd):/scripts \
            -w /scripts \
            grafana/k6 run "tests/performance/load/dummyjson-load.js" 2>&1 >> k6-output.txt
          echo "âœ… Load Test done"
        fi
        
        # Run Spike Test
        if [ -f "tests/performance/spike/dummyjson-spike.js" ]; then
          echo "" >> k6-output.txt
          echo "=== SPIKE TEST ===" >> k6-output.txt
          echo "" >> k6-output.txt
          
          echo "ðŸ§ª Running Spike Test..."
          # Use volume mount for file access
          docker run --rm \
            -v $(pwd):/scripts \
            -w /scripts \
            grafana/k6 run "tests/performance/spike/dummyjson-spike.js" 2>&1 >> k6-output.txt
          echo "âœ… Spike Test done"
        fi
        
        echo "" >> k6-output.txt
        echo "======================" >> k6-output.txt
        echo "ALL TESTS COMPLETED" >> k6-output.txt
    
    # KEEP THE REST EXACTLY THE SAME AS BEFORE â†“
    - name: Create Dynamic Report with Chart
      run: |
        echo "## ðŸ§ª ${{ steps.test-config.outputs.TEST_NAME }} Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.test-config.outputs.RUN_ALL }}" = "true" ]; then
          echo "### ðŸ“Š All Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tests Run:**" >> $GITHUB_STEP_SUMMARY
          echo "- Load Test" >> $GITHUB_STEP_SUMMARY
          echo "- Spike Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“ˆ Load Pattern: ${{ steps.test-config.outputs.CHART_TITLE }}" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo "    title \"${{ steps.test-config.outputs.CHART_TITLE }}\"" >> $GITHUB_STEP_SUMMARY
          echo "    x-axis ${{ steps.test-config.outputs.CHART_X_AXIS }}" >> $GITHUB_STEP_SUMMARY
          echo "    y-axis \"Virtual Users\" 0 --> ${{ steps.test-config.outputs.CHART_MAX }}" >> $GITHUB_STEP_SUMMARY
          echo "    line ${{ steps.test-config.outputs.CHART_DATA }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.test_type }}" = "load" ]; then
            echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Ramp-up | 0-2m | 0 â†’ 20 | Gradual increase |" >> $GITHUB_STEP_SUMMARY
            echo "| Mid-load | 2-4m | 20 â†’ 50 | Steady traffic |" >> $GITHUB_STEP_SUMMARY
            echo "| Peak | 4-6m | 50 â†’ 80 | High load |" >> $GITHUB_STEP_SUMMARY
            echo "| Sustained | 6-9m | 80 â†’ 100 | Maximum load |" >> $GITHUB_STEP_SUMMARY
            echo "| Ramp-down | 9-11m | 100 â†’ 40 | Gradual decrease |" >> $GITHUB_STEP_SUMMARY
            echo "| End | 11-12m | 40 â†’ 10 | Back to baseline |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.test_type }}" = "spike" ]; then
            echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| Normal | 0-30s | 10 | Baseline |" >> $GITHUB_STEP_SUMMARY
            echo "| Spike | 30-90s | 10 â†’ 200 | Sudden burst |" >> $GITHUB_STEP_SUMMARY
            echo "| Peak | 90-120s | 200 | Maximum spike |" >> $GITHUB_STEP_SUMMARY
            echo "| Recovery | 120-180s | 200 â†’ 50 | Gradual recovery |" >> $GITHUB_STEP_SUMMARY
            echo "| Back | 180-210s | 50 â†’ 10 | Return to normal |" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "k6-output.txt" ]; then
          echo "âœ… Test completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Get total iterations
          ITERATIONS=$(grep "iterations.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
          
          # Get HTTP metrics
          HTTP_REQS=$(grep "http_reqs.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "N/A")
          echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
          
          # Get response time
          AVG_RESPONSE=$(grep "http_req_duration.*avg=" k6-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
          echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          
          # Get success rate
          if grep -q "checks_succeeded" k6-output.txt; then
            SUCCESS_RATE=$(grep "checks_succeeded" k6-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null)
            echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check thresholds
          if grep -q "thresholds on metrics.*have been crossed" k6-output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ THRESHOLD VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show full summary
          echo "**Detailed Summary:**" >> $GITHUB_STEP_SUMMARY
          echo '<details>' >> $GITHUB_STEP_SUMMARY
          echo '<summary>Click to view full test output</summary>' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 k6-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '</details>' >> $GITHUB_STEP_SUMMARY
          
        else
          echo "âŒ No test output found. Test may have failed to run." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "*Test Type: ${{ steps.test-config.outputs.TEST_NAME }}*" >> $GITHUB_STEP_SUMMARY
