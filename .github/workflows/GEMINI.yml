name: GEMINI Performance Intelligence

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, load, spike]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Performance Suite
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" )

          for TEST in smoke load spike; do
            if [[ "$TEST_TYPE" == "all" || "$TEST_TYPE" == "$TEST" ]]; then
              echo "RUN_${TEST^^}=true" >> $GITHUB_ENV
              echo "ðŸš€ Running ${TEST^} Test..."
              # Ensure output file is created even if k6 fails early
              touch "k6-$TEST-output.txt"
              k6 run "${TESTS[$TEST]}" --out json="k6-$TEST.json" 2>&1 | tee "k6-$TEST-output.txt"
            else
              echo "RUN_${TEST^^}=false" >> $GITHUB_ENV
            fi
          done

      - name: Create Comprehensive Performance Report
        if: always()
        run: |
          echo "# ðŸ“Š PERFORMANCE DIAGNOSTICS: $(date +'%d %b %Y')" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          render_test () {
            NAME=$1; TITLE=$2; MAX_VUS=$3; LINE=$4; OUTPUT_FILE="k6-${NAME}-output.txt"
            if [ ! -s "$OUTPUT_FILE" ]; then return; fi

            # --- 1. CLEAN DATA EXTRACTION (Fixes syntax errors) ---
            # Extract only numeric values for math
            RAW_P95=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' | sed 's/[^0-9.]//g')
            P95=${RAW_P95:-0}
            
            RAW_FAIL=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' | sed 's/[^0-9.]//g')
            FAIL_RATE=${RAW_FAIL:-0}
            
            CHECKS_TOTAL=$(grep "checks_total.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' | sed 's/[^0-9]//g' || echo "0")
            CHECKS_FAILED=$(grep "checks_failed.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' | sed 's/[^0-9]//g' || echo "0")
            [ -z "$CHECKS_TOTAL" ] && CHECKS_TOTAL=0
            [ -z "$CHECKS_FAILED" ] && CHECKS_FAILED=0

            # --- 2. INTELLIGENT STATUS ---
            STATUS="ðŸŸ¢ HEALTHY"
            # Compare failure rate (0.10 = 10%)
            if (( $(echo "$FAIL_RATE > 0.10" | bc -l) )); then STATUS="ðŸ”´ CRITICAL FAIL"; 
            elif (( $(echo "$P95 > 2000" | bc -l) )); then STATUS="âš ï¸ SLOW RESPONSE"; fi
            grep -q "thresholds on metrics.*crossed" "$OUTPUT_FILE" && STATUS="âš ï¸ THRESHOLD VIOLATION"

            # --- 3. REPORT RENDERING ---
            echo "## $TITLE Test Result: $STATUS" >> $GITHUB_STEP_SUMMARY
            
            echo "#### ðŸ“ˆ Load Pattern Profile" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "  title \"$TITLE Virtual Users Curve\"" >> $GITHUB_STEP_SUMMARY
            echo "  y-axis \"Virtual Users\" 0 --> $MAX_VUS" >> $GITHUB_STEP_SUMMARY
            echo "  line $LINE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ” Key Metrics Analysis" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **P95 Latency** | ${P95}ms | $( (( $(echo "$P95 < 2000" | bc -l) )) && echo "âœ… OK" || echo "âŒ SLOW" ) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Error Rate** | $(echo "$FAIL_RATE * 100" | bc -l | xargs printf "%.2f")% | $( (( $(echo "$FAIL_RATE < 0.10" | bc -l) )) && echo "âœ… STABLE" || echo "âŒ FAILING" ) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Checks Passed** | $((CHECKS_TOTAL - CHECKS_FAILED)) / $CHECKS_TOTAL | $( [[ $CHECKS_FAILED -eq 0 && $CHECKS_TOTAL -gt 0 ]] && echo "âœ… 100%" || echo "âš ï¸ Issues" ) |" >> $GITHUB_STEP_SUMMARY

            # --- 4. BUSINESS JOURNEY VERIFICATION ---
            echo "### ðŸ› ï¸ Diagnostic Insights" >> $GITHUB_STEP_SUMMARY
            
            # Check for specific business journeys from your original logs
            if grep -q "page loaded during spike" "$OUTPUT_FILE"; then
                PAGE_LINE=$(grep -A1 "page loaded during spike" "$OUTPUT_FILE" | tail -1)
                echo "- **User Journey:** Page Load Status: \`$PAGE_LINE\`" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$NAME" == "spike" ] && (( $(echo "$FAIL_RATE > 0.10" | bc -l) )); then
                echo "- ðŸ›‘ **Action Required:** The system failed the Spike test. This indicates the infrastructure cannot scale instantly. **Recommendation:** Check horizontal pod autoscaling (HPA) settings." >> $GITHUB_STEP_SUMMARY
            elif [ "$STATUS" == "ðŸŸ¢ HEALTHY" ]; then
                echo "- âœ… **System Readiness:** Performance is stable. No immediate action required." >> $GITHUB_STEP_SUMMARY
            fi

            echo "<details><summary>ðŸ“„ View Raw k6 Summary Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Filter out the progress bars to keep the summary clean
            grep -v "\[.*\]" "$OUTPUT_FILE" | tail -n 50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          }

          # Final Run Execution
          [ "$RUN_SMOKE" == "true" ] && render_test "smoke" "SMOKE" 5 "[1, 3, 5, 5, 0]"
          [ "$RUN_LOAD" == "true" ] && render_test "load" "LOAD" 120 "[10, 50, 100, 120, 80, 20]"
          [ "$RUN_SPIKE" == "true" ] && render_test "spike" "SPIKE" 400 "[0, 400, 400, 0]"
