name: Ultimate GEMINI

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, load, spike]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Performance Suite
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          
          # Map files to types
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" )

          for TEST in smoke load spike; do
            if [[ "$TEST_TYPE" == "all" || "$TEST_TYPE" == "$TEST" ]]; then
              echo "RUN_${TEST^^}=true" >> $GITHUB_ENV
              echo "üöÄ Running ${TEST^} Test..."
              k6 run "${TESTS[$TEST]}" --out json="k6-$TEST.json" 2>&1 | tee "k6-$TEST-output.txt"
            else
              echo "RUN_${TEST^^}=false" >> $GITHUB_ENV
            fi
          done

      - name: Create Comprehensive Performance Report
        if: always()
        run: |
          echo "# üìä PERFORMANCE DIAGNOSTICS: $(date +'%d %b %Y')" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          render_test () {
            NAME=$1; TITLE=$2; MAX_VUS=$3; LINE=$4; OUTPUT_FILE="k6-${NAME}-output.txt"
            if [ ! -f "$OUTPUT_FILE" ]; then return; fi

            # --- 1. EXTRACT RAW METRICS (RETORED FULL LOGIC) ---
            P95=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' || echo "N/A")
            FAIL_RATE=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' || echo "0")
            CHECKS_TOTAL=$(grep "checks_total.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "0")
            CHECKS_FAILED=$(grep "checks_failed.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "0")
            HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "0")

            # --- 2. STATUS CALCULATION ---
            STATUS="üü¢ HEALTHY"
            [ $(echo "$FAIL_RATE > 0.05" | bc -l) -eq 1 ] && STATUS="üî¥ CRITICAL FAIL"
            grep -q "thresholds on metrics.*crossed" "$OUTPUT_FILE" && STATUS="‚ö†Ô∏è THRESHOLD VIOLATION"

            # --- 3. REPORT RENDERING ---
            echo "## $TITLE Test Result: $STATUS" >> $GITHUB_STEP_SUMMARY
            
            # Mermaid Chart for Load Profile
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "  title \"$TITLE Load Distribution\"" >> $GITHUB_STEP_SUMMARY
            echo "  y-axis \"Virtual Users\" 0 --> $MAX_VUS" >> $GITHUB_STEP_SUMMARY
            echo "  line $LINE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            echo "### üîç Key Performance Indicators" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value | Interpretation |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **P95 Latency** | ${P95}ms | $( [[ $(echo "$P95 < 1000" | bc -l) -eq 1 ]] && echo "‚úÖ Within Specs" || echo "‚ùå Too Slow" ) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Error Rate** | $(echo "$FAIL_RATE * 100" | bc -l | xargs printf "%.2f")% | $( [[ $(echo "$FAIL_RATE < 0.02" | bc -l) -eq 1 ]] && echo "‚úÖ Stable" || echo "‚ùå Unstable" ) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Functional Checks** | $((CHECKS_TOTAL - CHECKS_FAILED))/$CHECKS_TOTAL | $( [[ $CHECKS_FAILED -eq 0 ]] && echo "‚úÖ 100% Pass" || echo "‚ùå Logic Failures" ) |" >> $GITHUB_STEP_SUMMARY

            # --- 4. DEEP DIAGNOSTICS (THE "CREATIVE" PART) ---
            echo "### üõ†Ô∏è Diagnostic Insights" >> $GITHUB_STEP_SUMMARY
            if [ "$NAME" == "spike" ] && [ "$STATUS" != "üü¢ HEALTHY" ]; then
                echo "- **Spike Analysis:** The system buckled under sudden load. This usually points to **Auto-scaling lag** or **Database connection throttling**." >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "‚ùå 'rate<0.10'" "$OUTPUT_FILE"; then
                echo "- üõë **High Error Density:** Errors exceeded 10%. Your API is likely hitting a rate limit or a 500-series crash under stress." >> $GITHUB_STEP_SUMMARY
            fi

            # --- 5. FUNCTIONAL ACCESS VERIFICATION ---
            if grep -q "page loaded during spike" "$OUTPUT_FILE"; then
                echo "#### ‚úÖ Critical Journey Status" >> $GITHUB_STEP_SUMMARY
                PAGE_SUCCESS=$(grep -A1 "page loaded during spike" "$OUTPUT_FILE" | tail -1 | grep -o "[0-9]\+ ‚Äî ‚úÖ" | grep -o "[0-9]\+" || echo "0")
                echo "- **Page Load Success:** ${PAGE_SUCCESS} users successfully reached the landing page during the peak." >> $GITHUB_STEP_SUMMARY
            fi

            echo "<details><summary>üìÇ View Full Technical Log</summary>" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          }

          # Execute for each test
          [[ "$RUN_SMOKE" == "true" ]] && render_test "smoke" "SMOKE" 5 "[1, 3, 5, 5, 0]"
          [[ "$RUN_LOAD" == "true" ]] && render_test "load" "LOAD" 120 "[10, 50, 100, 120, 80, 20]"
          [[ "$RUN_SPIKE" == "true" ]] && render_test "spike" "SPIKE" 400 "[0, 400, 400, 0]"
