name: Gemini

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, load, spike]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Performance Suite
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" )

          for TEST in smoke load spike; do
            if [[ "$TEST_TYPE" == "all" || "$TEST_TYPE" == "$TEST" ]]; then
              echo "RUN_${TEST^^}=true" >> $GITHUB_ENV
              k6 run "${TESTS[$TEST]}" --out json="k6-$TEST.json" 2>&1 | tee "k6-$TEST-output.txt" || true
            fi
          done

      - name: Create World-Class Performance Report
        if: always()
        run: |
          echo "# ðŸ“Š K6 PERFORMANCE INTELLIGENCE REPORT" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… Report Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          render_test() {
            NAME=$1; TITLE=$2; MAX_VUS=$3; LINE=$4; FILE="k6-${NAME}-output.txt"
            if [ ! -s "$FILE" ]; then return; fi

            # --- DYNAMIC DATA EXTRACTION (Smarter than hardcoded strings) ---
            P95=$(grep "http_req_duration" "$FILE" | grep -oE "p\(95\)=[0-9.]+" | cut -d'=' -f2 || echo "0")
            ERR_RATE=$(grep "http_req_failed" "$FILE" | grep -oE "rate=[0-9.]+" | cut -d'=' -f2 || echo "0")
            # Convert decimal rate to percentage for display (e.g., 0.10 -> 10%)
            ERR_PCT=$(echo "$ERR_RATE * 100" | bc -l | xargs printf "%.2f")

            echo "## ðŸš€ ${TITLE} Test Analysis" >> $GITHUB_STEP_SUMMARY
            
            # ðŸ“ˆ MERMAID GRAPH
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "    title \"${TITLE} - Virtual Users Over Time\"" >> $GITHUB_STEP_SUMMARY
            echo "    y-axis \"Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
            echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # ðŸ“Š METRICS DASHBOARD
            echo "### ðŸ“Š Critical Metrics Dashboard" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Result | Target | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| âš¡ P95 Latency | ${P95}ms | <2000ms | $( (( $(echo "$P95 < 2000" | bc -l) )) && echo "âœ… PASS" || echo "ðŸ”´ FAIL" ) |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš¨ Error Rate | ${ERR_PCT}% | <10% | $( (( $(echo "$ERR_RATE < 0.10" | bc -l) )) && echo "âœ… PASS" || echo "ðŸ”´ FAIL" ) |" >> $GITHUB_STEP_SUMMARY

            # ðŸ§  IMPACT ANALYSIS (Smarter Logic)
            echo "### ðŸ§  Impact Analysis" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$ERR_RATE > 0.50" | bc -l) )); then
              echo "ðŸ”¥ **SYSTEM FAILURE:** The system is collapsing under load. **Business Impact:** Total service outage for customers." >> $GITHUB_STEP_SUMMARY
            elif (( $(echo "$ERR_RATE > 0.10" | bc -l) )); then
              echo "âš ï¸ **DEGRADED EXPERIENCE:** High error rates detected. **Business Impact:** Users will see 'Internal Server Errors' during peaks." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **STABLE PERFORMANCE:** System handled the load gracefully." >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### ðŸŽ¯ Recommended Actions" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$ERR_RATE > 0.10" | bc -l) )); then
              echo "1. **INVESTIGATE** Logs for 5XX errors. 2. **SCALE** DB connections. 3. **DO NOT DEPLOY**." >> $GITHUB_STEP_SUMMARY
            else
              echo "1. **PROCEED** to next stage. 2. **MONITOR** production latency." >> $GITHUB_STEP_SUMMARY
            fi
            echo "---" >> $GITHUB_STEP_SUMMARY
          }

          # Execution
          [ "$RUN_SMOKE" == "true" ] && render_test "smoke" "Smoke" 5 "[1, 5, 5, 0]"
          [ "$RUN_LOAD" == "true" ] && render_test "load" "Load" 120 "[10, 50, 120, 80, 20]"
          [ "$RUN_SPIKE" == "true" ] && render_test "spike" "Spike" 400 "[0, 400, 400, 0]"

          # ðŸ† DEPLOYMENT DECISION MATRIX
          echo "# ðŸ† Final Deployment Decision" >> $GITHUB_STEP_SUMMARY
          if [ -f "k6-spike-output.txt" ] && grep -q "thresholds on metrics.*crossed" "k6-spike-output.txt"; then
             echo "## ðŸ”´ VERDICT: DO NOT DEPLOY" >> $GITHUB_STEP_SUMMARY
             echo "**Stakeholder Briefing:** 'The site crashes at 400 users. Launching now will result in a site outage.'" >> $GITHUB_STEP_SUMMARY
          else
             echo "## ðŸŸ¢ VERDICT: READY FOR LAUNCH" >> $GITHUB_STEP_SUMMARY
             echo "**Stakeholder Briefing:** 'The system passed all stress tests. We are clear for takeoff!'" >> $GITHUB_STEP_SUMMARY
          fi
