name: GEMINI

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          if [ "$TEST_TYPE" = "smoke" ]; then
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "load" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "spike" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
          else
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
          fi

      - name: Run Selected Performance Tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
          )

          for TEST in smoke load spike; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              echo "ðŸš€ Running ${TEST^} test..."
              if [ ! -f "${TESTS[$TEST]}" ]; then
                echo "âŒ Error: File ${TESTS[$TEST]} not found!"
                continue
              fi
              
              k6 run "${TESTS[$TEST]}" \
                --out json="k6-${TEST}-results.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
            fi
          done

      - name: Create Performance Report
        run: |
          echo "## ðŸ§ª K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
          echo "*Selected test type: ${{ github.event.inputs.test_type }}*" >> $GITHUB_STEP_SUMMARY

          render_test () {
            NAME=$1
            TITLE=$2
            MAX_VUS=$3
            LINE=$4
            OUTPUT_FILE="k6-${NAME}-output.txt"

            if [ -f "$OUTPUT_FILE" ]; then
              echo "### ðŸš¦ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
              
              # -------- TEST STATUS LOGIC --------
              STATUS="COMPLETED"
              if grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then STATUS="THRESHOLD_VIOLATIONS"; fi
              if grep -qi "ERRO\|ERROR\|Error:" "$OUTPUT_FILE" && ! grep -q "thresholds" "$OUTPUT_FILE"; then STATUS="ERROR"; fi
              
              case "$STATUS" in
                "COMPLETED") echo "âœ… **Status: COMPLETED SUCCESSFULLY**" >> $GITHUB_STEP_SUMMARY ;;
                "THRESHOLD_VIOLATIONS") echo "âš ï¸ **Status: COMPLETED WITH THRESHOLD VIOLATIONS**" >> $GITHUB_STEP_SUMMARY ;;
                *) echo "âŒ **Status: $STATUS**" >> $GITHUB_STEP_SUMMARY ;;
              esac

              # -------- GRAPH --------
              echo "#### ðŸ“ˆ Load Pattern" >> $GITHUB_STEP_SUMMARY
              echo '```mermaid' >> $GITHUB_STEP_SUMMARY
              echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
              echo "    title \"${TITLE} Test Load Pattern\"" >> $GITHUB_STEP_SUMMARY
              echo '    x-axis "Time (minutes)"' >> $GITHUB_STEP_SUMMARY
              echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
              echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY

              # -------- METRIC EXTRACTION --------
              FAILED_RATE=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' || echo "0")
              P95_RESPONSE=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' || echo "N/A")
              
              echo "#### ðŸ§‘â€ðŸ’» Plain English Explanation" >> $GITHUB_STEP_SUMMARY
              echo "âš¡ **Response Speed (P95):** ${P95_RESPONSE}ms" >> $GITHUB_STEP_SUMMARY
              
              # -------- THRESHOLDS TABLE --------
              echo "##### ðŸŽ¯ Thresholds Status" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A1 "âœ“\|âœ—" "$OUTPUT_FILE" | head -20 >> $GITHUB_STEP_SUMMARY || echo "No threshold data" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY

              # -------- DEVELOPER METRICS TABLE --------
              echo "##### ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
              echo '| Metric | Value |' >> $GITHUB_STEP_SUMMARY
              echo '|--------|-------|' >> $GITHUB_STEP_SUMMARY
              echo "| P95 Response | $P95_RESPONSE ms |" >> $GITHUB_STEP_SUMMARY
              echo "| Failure Rate | $FAILED_RATE |" >> $GITHUB_STEP_SUMMARY
              
              echo "<details><summary>View Raw Output</summary>" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -100 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          }

          # Execute the rendering logic
          if [ "${RUN_SMOKE}" = "true" ]; then render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"; fi
          if [ "${RUN_LOAD}" = "true" ]; then render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"; fi
          if [ "${RUN_SPIKE}" = "true" ]; then render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"; fi

          # Final Executive Summary
          echo "### ðŸ“ Executive Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "k6-spike-output.txt" ] && grep -q "âŒ" "k6-spike-output.txt"; then
            echo "ðŸ”´ **Overall Status: CRITICAL FAILURE**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŸ¢ **Overall Status: PASS**" >> $GITHUB_STEP_SUMMARY
          fi
