name: GEMINI metricReport

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      # ----------------------------------------------------
      # Setup k6 NATIVELY (NO DOCKER)
      # ----------------------------------------------------
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # ----------------------------------------------------
      # Decide which tests to run
      # ----------------------------------------------------
      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"

          if [ "$TEST_TYPE" = "smoke" ]; then
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "load" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "spike" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
          else
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
          fi

      # ----------------------------------------------------
      # Run selected tests with NATIVE k6 (NO DOCKER)
      # ----------------------------------------------------
      - name: Run Selected Performance Tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
          )

          for TEST in smoke load spike; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              echo "ðŸš€ Running ${TEST^} test..."
              echo "Test file: ${TESTS[$TEST]}"
              
              if [ ! -f "${TESTS[$TEST]}" ]; then
                echo "âŒ Error: File ${TESTS[$TEST]} not found!"
                find tests -name "*.js" -type f | head -20
                continue
              fi
              
              k6 run "${TESTS[$TEST]}" \
                --out json="k6-${TEST}-results.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
              
              if [ $? -eq 0 ]; then
                echo "âœ… ${TEST^} test completed successfully"
              else
                echo "âŒ ${TEST^} test failed"
              fi
            fi
          done

      # ----------------------------------------------------
      # Report: GRAPH + METRICS PER TEST (ENHANCED)
      # ----------------------------------------------------
      - name: Create Performance Report
        run: |
          echo "## ðŸ§ª K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
          echo "*Selected test type: ${{ github.event.inputs.test_type }}*" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          render_test () {
            NAME=$1
            TITLE=$2
            MAX_VUS=$3
            LINE=$4
            OUTPUT_FILE="k6-${NAME}-output.txt"

            if [ -f "$OUTPUT_FILE" ]; then
              echo "### ðŸš¦ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              STATUS="COMPLETED"
              if grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
                STATUS="THRESHOLD_VIOLATIONS"
              fi
              if grep -qi "ERRO\|ERROR\|Error:" "$OUTPUT_FILE"; then
                if ! grep -q "thresholds on metrics.*have been crossed" "$OUTPUT_FILE"; then
                  STATUS="ERROR"
                fi
              fi
              if ! grep -q "iterations.*:" "$OUTPUT_FILE" && ! grep -q "http_reqs.*:" "$OUTPUT_FILE"; then
                STATUS="FAILED_NO_OUTPUT"
              fi
              
              case "$STATUS" in
                "COMPLETED") echo "âœ… **Status: COMPLETED SUCCESSFULLY**" >> $GITHUB_STEP_SUMMARY ;;
                "THRESHOLD_VIOLATIONS") echo "âš ï¸ **Status: COMPLETED WITH THRESHOLD VIOLATIONS**" >> $GITHUB_STEP_SUMMARY ;;
                "ERROR") echo "âŒ **Status: FAILED WITH ERRORS**" >> $GITHUB_STEP_SUMMARY ;;
                "FAILED_NO_OUTPUT") echo "âŒ **Status: FAILED - NO METRICS GENERATED**" >> $GITHUB_STEP_SUMMARY ;;
                *) echo "âœ… **Status: COMPLETED**" >> $GITHUB_STEP_SUMMARY ;;
              esac
              echo "" >> $GITHUB_STEP_SUMMARY

              echo "#### ðŸ“ˆ Load Pattern" >> $GITHUB_STEP_SUMMARY
              echo '```mermaid' >> $GITHUB_STEP_SUMMARY
              echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
              echo "    title \"${TITLE} Test Load Pattern\"" >> $GITHUB_STEP_SUMMARY
              echo '    x-axis "Time (minutes)"' >> $GITHUB_STEP_SUMMARY
              echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
              echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              echo "#### ðŸ§‘â€ðŸ’» Plain English Explanation" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**What this test means for the business:**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              FAILED_RATE=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' 2>/dev/null || echo "0")
              P95_RESPONSE=$(grep "http_req_duration.*p(95)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              ITERATIONS=$(grep "iterations.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
              HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0")
              
              if [ "$FAILED_RATE" != "0" ] && [ "$FAILED_RATE" != "N/A" ]; then
                FAILED_PERCENT=$(echo "$FAILED_RATE * 100" | bc -l 2>/dev/null | xargs printf "%.1f%%" 2>/dev/null || echo "$FAILED_RATE")
                echo "ðŸ”´ **Failed Requests:** ${FAILED_PERCENT} of requests had errors" >> $GITHUB_STEP_SUMMARY
              else
                echo "ðŸŸ¢ **Failed Requests:** Very low error rate" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ "$P95_RESPONSE" != "N/A" ]; then echo "âš¡ **Response Speed (95% of requests):** ${P95_RESPONSE}ms" >> $GITHUB_STEP_SUMMARY; fi
              if [ "$ITERATIONS" != "0" ]; then echo "ðŸ“Š **Test Volume:** ${ITERATIONS} user sessions simulated" >> $GITHUB_STEP_SUMMARY; fi

              echo "#### ðŸ“Š Performance Metrics (For Developers & DevOps)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract metrics for table
              AVG_RESPONSE=$(grep "http_req_duration.*avg=" "$OUTPUT_FILE" | tail -1 | sed 's/.*avg=//' | awk '{print $1}' 2>/dev/null || echo "N/A")
              VUS_MAX=$(grep "vus.*max=" "$OUTPUT_FILE" | tail -1 | sed 's/.*max=//' | awk '{print $1}' 2>/dev/null || echo "N/A")

              echo "##### âš¡ Response Time Distribution" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Average | $AVG_RESPONSE ms |" >> $GITHUB_STEP_SUMMARY
              echo "| P95 | $P95_RESPONSE ms |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              echo "#### ðŸ“„ Raw Test Output" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>View complete output</summary>" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -50 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
            fi
          }

          if [ "${RUN_SMOKE}" = "true" ]; then render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"; fi
          if [ "${RUN_LOAD}" = "true" ]; then render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"; fi
          if [ "${RUN_SPIKE}" = "true" ]; then render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"; fi

          echo "### ðŸ“ Executive Summary" >> $GITHUB_STEP_SUMMARY
          echo "Tests Executed: ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
