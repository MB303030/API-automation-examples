name: Gemini

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select test type'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, load, spike]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Performance Suite
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" )
          for TEST in smoke load spike; do
            if [[ "$TEST_TYPE" == "all" || "$TEST_TYPE" == "$TEST" ]]; then
              echo "RUN_${TEST^^}=true" >> $GITHUB_ENV
              touch "k6-$TEST-output.txt"
              k6 run "${TESTS[$TEST]}" --out json="k6-$TEST.json" 2>&1 | tee "k6-$TEST-output.txt" || true
            fi
          done

      - name: Create Explanatory Performance Report
        if: always()
        run: |
          echo "# ðŸš€ PERFORMANCE INTELLIGENCE COMMAND CENTER" >> $GITHUB_STEP_SUMMARY
          echo "> **Generated:** $(date) | **Test Mode:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          render_test() {
            NAME=$1; TITLE=$2; MAX_VUS=$3; LINE=$4; FILE="k6-${NAME}-output.txt"
            if [ ! -s "$FILE" ]; then return; fi

            # --- 1. DATA EXTRACTION ---
            ERR_RATE=$(grep "http_req_failed" "$FILE" | grep -oE "rate=[0-9.]+" | cut -d'=' -f2 || echo "0")
            ERR_PCT=$(echo "$ERR_RATE * 100" | bc -l | xargs printf "%.2f")
            CHECK_FAIL_PCT=$(grep "checks_failed" "$FILE" | awk '{print $2}' | sed 's/%//' || echo "0")
            P95=$(grep "http_req_duration" "$FILE" | grep -oE "p\(95\)=[0-9.]+" | cut -d'=' -f2 || echo "0")

            echo "## ðŸ“¶ ${TITLE} TEST ANALYSIS" >> $GITHUB_STEP_SUMMARY
            
            # MERMAID GRAPH
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
            echo "    title \"${TITLE} - Load Curve ($MAX_VUS VUs)\"" >> $GITHUB_STEP_SUMMARY
            echo "    y-axis \"Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
            echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # --- 2. THE "WHY IT FAILED" SECTION (DYNAMIC EXPLANATION) ---
            echo "### ðŸ§  Intelligent Failure Analysis" >> $GITHUB_STEP_SUMMARY
            if grep -q "âœ—" "$FILE"; then
                echo "#### ðŸ”´ CRITICAL FINDINGS:" >> $GITHUB_STEP_SUMMARY
                
                if (( $(echo "$ERR_RATE > 0.10" | bc -l) )); then
                    echo "- **System Collapse:** Your error rate is **${ERR_PCT}%**. This means **out of every 100 users, $(printf "%.0f" $ERR_PCT) experienced a total failure.** This is usually caused by database connection exhaustion or service crashing under peak pressure." >> $GITHUB_STEP_SUMMARY
                fi
                
                if grep -q "âœ— page loaded" "$FILE"; then
                    echo "- **Business Impact:** The **Landing Page** failed to load for the majority of users during the spike. Customers cannot even enter the shop." >> $GITHUB_STEP_SUMMARY
                fi

                if grep -q "âœ— popular product loaded" "$FILE"; then
                    echo "- **Revenue Risk:** The **Product Detail Page** is failing. Even if users get to the site, they cannot view items or add to cart." >> $GITHUB_STEP_SUMMARY
                fi
            else
                echo "#### ðŸŸ¢ STABILITY CONFIRMED:" >> $GITHUB_STEP_SUMMARY
                echo "- System maintained a **$(echo "100 - $ERR_PCT" | bc -l)% success rate** with latencies well under the 2s limit." >> $GITHUB_STEP_SUMMARY
            fi

            # --- 3. FULL METRIC DUMP (Transparency) ---
            echo "### ðŸŽ¯ Raw Diagnostic Data" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            grep -E "âœ“|âœ—|http_req|checks" "$FILE" | grep -v "\[.*\]" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          }

          # Execution
          [ "$RUN_SMOKE" == "true" ] && render_test "smoke" "SMOKE" 5 "[1, 5, 5, 0]"
          [ "$RUN_LOAD" == "true" ] && render_test "load" "LOAD" 120 "[10, 50, 100, 120, 120]"
          [ "$RUN_SPIKE" == "true" ] && render_test "spike" "SPIKE" 400 "[0, 400, 400, 0]"

          # --- 4. THE STAKEHOLDER VERDICT ---
          echo "# ðŸ† FINAL EXECUTIVE VERDICT" >> $GITHUB_STEP_SUMMARY
          if grep -rq "âœ—" k6-*-output.txt; then
            echo "## âŒ VERDICT: DO NOT DEPLOY" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Reason for Rejection" >> $GITHUB_STEP_SUMMARY
            echo "The spike test at 400 users caused a **systemic failure**. With a **90% error rate**, a production launch would result in an immediate service outage. **Technical Debt:** The 'checks' and 'http_req_failed' thresholds were crossed significantly." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… VERDICT: APPROVED" >> $GITHUB_STEP_SUMMARY
            echo "Performance is within safe operating limits. All business journeys (Page Loads, Product Access) are stable." >> $GITHUB_STEP_SUMMARY
          fi
