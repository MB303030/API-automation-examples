name: Enhanced Nightly Tests

on:
  schedule:
    # Runs every minute for testing (remove this once confirmed working)
    - cron: '* * * * *'
    # Original nightly schedule (uncomment when ready)
    # - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      testType:
        description: 'Type of tests to run'
        required: false
        default: 'all'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npx playwright install --with-deps chromium
    
    - name: Run tests
      id: tests
      run: |
        # Run tests and capture exit code
        npx playwright test --reporter=html,json,junit || true
        TEST_EXIT_CODE=$?
        echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Count test results
        if [ -f test-results.json ]; then
          PASSED=$(jq '.stats.passed // 0' test-results.json)
          FAILED=$(jq '.stats.failed // 0' test-results.json)
          SKIPPED=$(jq '.stats.skipped // 0' test-results.json)
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        else
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
          echo "skipped=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          playwright-report/
          test-results.json
          test-results.xml
        retention-days: 7
    
    - name: Deploy HTML report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./playwright-report
        keep_files: false
        destination_dir: ./${{ github.run_id }}
    
    - name: Print test summary
      if: always()
      run: |
        echo "ğŸ“Š Test Results Summary:"
        echo "âœ… Passed: ${{ steps.tests.outputs.passed || 0 }}"
        echo "âŒ Failed: ${{ steps.tests.outputs.failed || 0 }}"
        echo "â­ï¸ Skipped: ${{ steps.tests.outputs.skipped || 0 }}"
        echo "ğŸ“Š Exit Code: ${{ steps.tests.outputs.exit_code || 0 }}"
        echo "ğŸ“„ HTML Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_id }}/"
        echo "ğŸ”— Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
