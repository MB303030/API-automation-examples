name: Enhanced Nightly Tests

on:
  schedule:
    # Runs at 07:00 UTC every day
    - cron: '0 7 * * *'
      # # Runs at the start of every hour (e.g., 1:00, 2:00)
    # - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      testType:
        description: 'Type of tests to run'
        required: false
        default: 'all'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Permission needed to deploy to GH Pages
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npx playwright install --with-deps chromium
    
    - name: Run tests
      id: tests
      run: |
        # Run tests and capture the exit code WITHOUT forcing 'true' immediately
        npx playwright test --reporter=html,json,junit > test_output.txt 2>&1 || TEST_EXIT_CODE=$?
        
        # Default to 0 if variable is empty (meaning tests passed)
        REAL_EXIT_CODE=${TEST_EXIT_CODE:-0}
        echo "exit_code=$REAL_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Count test results using jq
        if [ -f test-results.json ]; then
          echo "passed=$(jq '.stats.passed // 0' test-results.json)" >> $GITHUB_OUTPUT
          echo "failed=$(jq '.stats.failed // 0' test-results.json)" >> $GITHUB_OUTPUT
          echo "skipped=$(jq '.stats.skipped // 0' test-results.json)" >> $GITHUB_OUTPUT
        else
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
          echo "skipped=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          playwright-report/
          test-results.json
          test-results.xml
        retention-days: 7
    
    - name: Deploy HTML report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./playwright-report
        keep_files: false
        destination_dir: ${{ github.run_id }}
    
    - name: Print test summary
      if: always()
      run: |
        echo "ğŸ“Š Test Results Summary:"
        echo "âœ… Passed: ${{ steps.tests.outputs.passed }}"
        echo "âŒ Failed: ${{ steps.tests.outputs.failed }}"
        echo "â­ï¸ Skipped: ${{ steps.tests.outputs.skipped }}"
        echo "ğŸ“Š Exit Code: ${{ steps.tests.outputs.exit_code }}"
        echo "ğŸ“„ HTML Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_id }}/"
        
        # Fail the job if the tests failed so you get a red mark in GitHub UI
        if [ "${{ steps.tests.outputs.exit_code }}" -ne "0" ]; then
          exit 1
        fi
