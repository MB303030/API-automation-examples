name: Simple K6 Test

on: workflow_dispatch

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Run K6 and Save Output
      run: |
        echo "=== RUNNING K6 TEST ==="
        
        # Create directory for results
        mkdir -p k6-results
        
        # Run K6 and capture ALL output
        docker run --rm -i grafana/k6 run - < tests/performance/smoke/dummyjson-smoke.js 2>&1 | tee k6-results/full-output.txt
        
        echo "=== TEST COMPLETE ==="
        
    - name: Show Simple Report
      if: always()
      run: |
        echo "## ðŸ“Š K6 Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "k6-results/full-output.txt" ]; then
          # Extract just the summary section
          echo "### âœ… Test Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get key metrics from output
          echo "**Key Metrics:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Show last 20 lines (the summary)
          tail -20 k6-results/full-output.txt >> $GITHUB_STEP_SUMMARY
          
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No output found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-results
        path: k6-results/
        retention-days: 7
