name: K6 Performance Test with Charts

on: workflow_dispatch

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Run K6 Test
      run: |
        docker run --rm -i grafana/k6 run - < tests/performance/smoke/dummyjson-smoke.js 2>&1 | tee k6-output.txt
        
    - name: Create Report with Chart
      run: |
        echo "## ðŸ“Š K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add Mermaid Chart - FIXED SYNTAX
        echo "### ðŸ“ˆ Load Pattern" >> $GITHUB_STEP_SUMMARY
        echo '```mermaid' >> $GITHUB_STEP_SUMMARY
        echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
        echo '    title "Virtual Users Over Time"' >> $GITHUB_STEP_SUMMARY
        echo '    x-axis [0m, 1m, 2m, 3m, 5m, 6m, 7m]' >> $GITHUB_STEP_SUMMARY
        echo '    y-axis "Users" 0 --> 120' >> $GITHUB_STEP_SUMMARY
        echo '    line [0, 20, 50, 100, 100, 20, 0]' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add Phase Table
        echo "### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Duration | Users | Description |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|----------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Ramp-up | 0-1m | 0 â†’ 20 | Gradual increase |" >> $GITHUB_STEP_SUMMARY
        echo "| Ramp-up | 1-2m | 20 â†’ 50 | Medium load |" >> $GITHUB_STEP_SUMMARY
        echo "| Ramp-up | 2-3m | 50 â†’ 100 | High load |" >> $GITHUB_STEP_SUMMARY
        echo "| Peak Load | 3-5m | 100 | Sustained load |" >> $GITHUB_STEP_SUMMARY
        echo "| Cool-down | 5-6m | 100 â†’ 20 | Gradual decrease |" >> $GITHUB_STEP_SUMMARY
        echo "| Cool-down | 6-7m | 20 â†’ 0 | Back to normal |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add Results
        echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f "k6-output.txt" ]; then
          echo "âœ… Test completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 k6-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ No output found" >> $GITHUB_STEP_SUMMARY
        fi
