name: K6 Performance 

on: workflow_dispatch

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Run K6 Test
      run: |
        echo "ðŸš€ Starting K6 Performance Test..."
        docker run --rm -i grafana/k6 run - < tests/performance/smoke/dummyjson-smoke.js 2>&1 | tee k6-output.txt
        
    - name: Create Enhanced Report
      if: always()
      run: |
        echo "## ðŸ“Š K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "k6-output.txt" ]; then
          echo "### ðŸŽ¯ Test Summary" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics with better parsing
          # 1. Total iterations
          ITERATIONS=$(grep -A1 "iterations.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',')
          ITER_PER_SEC=$(grep -A1 "iterations.*:" k6-output.txt | tail -1 | awk '{print $3}' | tr -d ',' | sed 's/.*\///')
          
          # 2. HTTP metrics
          HTTP_REQS=$(grep -A1 "http_reqs.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',')
          HTTP_REQ_SEC=$(grep -A1 "http_reqs.*:" k6-output.txt | tail -1 | awk '{print $3}' | tr -d ',' | sed 's/.*\///')
          
          # 3. Response time
          AVG_TIME=$(grep "http_req_duration.*avg=" k6-output.txt | tail -1 | sed 's/.*avg=//' | awk '{print $1}' | sed 's/ms//')
          P95_TIME=$(grep "http_req_duration.*p(95)=" k6-output.txt | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' | sed 's/ms//')
          MIN_TIME=$(grep "http_req_duration.*min=" k6-output.txt | tail -1 | sed 's/.*min=//' | awk '{print $1}' | sed 's/ms//')
          MAX_TIME=$(grep "http_req_duration.*max=" k6-output.txt | tail -1 | sed 's/.*max=//' | awk '{print $1}' | sed 's/ms//')
          
          # 4. Success/Failure rates
          SUCCESS_RATE=$(grep "checks_succeeded" k6-output.txt | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "100.00%")
          FAILED_RATE=$(grep "http_req_failed.*:" k6-output.txt | tail -1 | awk '{print $2}' | tr -d ',' 2>/dev/null || echo "0.00%")
          
          # Display formatted metrics
          echo "#### ðŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Total requests
          echo "| Total Requests | $HTTP_REQS | âœ… |" >> $GITHUB_STEP_SUMMARY
          
          # Throughput
          echo "| Throughput | $HTTP_REQ_SEC requests/sec | âœ… |" >> $GITHUB_STEP_SUMMARY
          
          # Response times
          if [[ "${AVG_TIME%.*}" -lt 100 ]]; then
            echo "| Avg Response Time | ${AVG_TIME}ms | ðŸš€ Excellent |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${AVG_TIME%.*}" -lt 500 ]]; then
            echo "| Avg Response Time | ${AVG_TIME}ms | âš¡ Good |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Avg Response Time | ${AVG_TIME}ms | ðŸŒ Slow |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| P95 Response Time | ${P95_TIME}ms | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Min Response Time | ${MIN_TIME}ms | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Response Time | ${MAX_TIME}ms | - |" >> $GITHUB_STEP_SUMMARY
          
          # Success rate
          if [[ "$FAILED_RATE" == "0.00%" ]] || [[ "$FAILED_RATE" < "0.01" ]]; then
            echo "| Success Rate | $SUCCESS_RATE | âœ… Excellent |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Success Rate | $SUCCESS_RATE | âš ï¸ Needs attention |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| Failure Rate | $FAILED_RATE | - |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Configuration
          echo "#### âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Virtual Users:** 2" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** 30 seconds" >> $GITHUB_STEP_SUMMARY
          echo "- **Endpoints Tested:** 3 (Products, Single Product, Search)" >> $GITHUB_STEP_SUMMARY
          echo "- **Pause between iterations:** 1 second" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Threshold Results
          echo "#### âœ… Threshold Results" >> $GITHUB_STEP_SUMMARY
          grep -A10 "â–ˆ THRESHOLDS" k6-output.txt | grep -v "â–ˆ" | sed 's/^/    /' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "    No threshold details found" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Checks (Validation Tests)
          echo "#### ðŸ” Validation Checks" >> $GITHUB_STEP_SUMMARY
          grep -A10 "â–€ status is 200" k6-output.txt | head -10 | sed 's/^/    /' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "    Running validation checks..." >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Performance Analysis
          echo "#### ðŸ“Š Performance Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$FAILED_RATE" == "0.00%" ]]; then
            echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some tests failed:** $FAILED_RATE failure rate" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${AVG_TIME%.*}" -lt 100 ]]; then
            echo "ðŸš€ **Excellent performance:** Average response time is ${AVG_TIME}ms" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${P95_TIME%.*}" -lt 2000 ]]; then
            echo "âœ… **Consistent performance:** 95% of requests were under ${P95_TIME}ms" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Raw output section
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ðŸ“‹ View Full Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 k6-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "âŒ No test output found. Check if K6 ran correctly." >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload Detailed Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-performance-results
        path: k6-output.txt
        retention-days: 30
