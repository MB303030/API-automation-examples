# .github/workflows/single-file-test.yml
name: Single File Test

on: [workflow_dispatch]

jobs:
  single-file:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create combined test file
      run: |
        # Combine endpoints.js and env.js into one file
        cat > combined-test.js << 'EOF'
        import http from 'k6/http';
        import { check } from 'k6';
        
        // Copy the content of env.js here
        function getApiUrl(service, path) {
          const baseUrls = {
            dummyjson: 'https://dummyjson.com',
            pet: 'https://petstore.swagger.io/v2',
            postman: 'https://postman-echo.com'
          };
          
          const baseUrl = baseUrls[service] || 'https://dummyjson.com';
          return `${baseUrl}${path}`;
        }
        
        // Copy the functions from endpoints.js here
        function getProductsEndpoint(limit = 30, skip = 0) {
          return getApiUrl('dummyjson', `/products?limit=${limit}&skip=${skip}`);
        }
        
        function getProductByIdEndpoint(id) {
          return getApiUrl('dummyjson', `/products/${id}`);
        }
        
        function searchProductsEndpoint(term) {
          return getApiUrl('dummyjson', `/products/search?q=${encodeURIComponent(term)}`);
        }
        
        console.log('=== COMBINED TEST ===');
        
        // Test the functions
        const url = getProductsEndpoint(5, 0);
        console.log('Generated URL:', url);
        
        const res = http.get(url);
        check(res, {
          'status 200': (r) => r.status === 200
        });
        
        console.log('Response status:', res.status);
        
        export default function() {
          console.log('Iteration');
        }
        EOF
        
        echo "Created combined test file"
    
    - name: Run combined test
      uses: grafana/setup-k6-action@v1
      
    - name: Execute test
      run: |
        k6 run combined-test.js
