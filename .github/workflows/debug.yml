# .github/workflows/show-actual-files.yml
name: Show Actual Files

on: [workflow_dispatch]

jobs:
  show-files:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Show files with proper ES module check
      run: |
        echo "=== ENDPOINTS.JS ==="
        echo "Full content:"
        echo "----------------------------------------"
        cat utils/config/endpoints.js
        echo "----------------------------------------"
        echo ""
        
        echo "=== ENV.JS ==="
        echo "Full content:"
        echo "----------------------------------------"
        cat utils/config/env.js
        echo "----------------------------------------"
        echo ""
        
        echo "=== CHECKING IMPORTS ==="
        echo "endpoints.js imports:"
        grep -n "import" utils/config/endpoints.js || echo "No imports"
        echo ""
        echo "env.js imports:"
        grep -n "import" utils/config/env.js || echo "No imports"
        
    - name: Create a direct test
      run: |
        echo "=== CREATING DIRECT TEST ==="
        
        # Test reading the files first
        cat > read-test.js << 'EOF'
        import { readFileSync } from 'fs';
        
        console.log('Reading endpoints.js...');
        try {
          const content = readFileSync('utils/config/endpoints.js', 'utf8');
          console.log('✅ File read successfully');
          console.log('First 300 characters:');
          console.log(content.substring(0, 300));
          
          // Check key elements
          if (!content.includes('export')) {
            console.log('❌ WARNING: No export statements found');
          }
          if (content.includes("from 'k6'") || content.includes('from "k6"')) {
            console.log('❌ ERROR: File imports k6 (should not)');
          }
        } catch (e) {
          console.log('❌ Cannot read file:', e.message);
        }
        
        console.log('\nReading env.js...');
        try {
          const content = readFileSync('utils/config/env.js', 'utf8');
          console.log('✅ File read successfully');
          console.log('First 200 characters:');
          console.log(content.substring(0, 200));
        } catch (e) {
          console.log('❌ Cannot read file:', e.message);
        }
        EOF
        
        node read-test.js
    
    - name: Test k6 import directly
      uses: grafana/setup-k6-action@v1
      
    - name: Run minimal k6 test
      run: |
        echo "=== MINIMAL K6 TEST ==="
        
        cat > minimal-k6-test.js << 'EOF'
        console.log('=== MINIMAL TEST ===');
        
        // Just try to read and show the file content
        try {
          const content = open('utils/config/endpoints.js');
          console.log('✅ Can open file');
          console.log('File size:', content.length, 'chars');
          console.log('First 5 lines:');
          const lines = content.split('\n').slice(0, 5);
          lines.forEach((line, i) => console.log(`  ${i+1}: ${line}`));
        } catch (e) {
          console.log('❌ Cannot open file:', e.message);
        }
        
        console.log('\n=== TRYING TO IMPORT ===');
        try {
          const module = await import('utils/config/endpoints.js');
          console.log('✅ Import successful!');
          console.log('Exports:', Object.keys(module));
        } catch (e) {
          console.log('❌ Import failed');
          console.log('Error name:', e.name);
          console.log('Error message:', e.message);
          console.log('Error stack:', e.stack);
        }
        
        export default function() {
          console.log('Test iteration');
        }
        EOF
        
        k6 run minimal-k6-test.js
    
    - name: Fix the files if needed
      run: |
        echo "=== CREATING CORRECT FILES ==="
        
        # Read current endpoints.js to see what's wrong
        CURRENT_ENDPOINTS=$(cat utils/config/endpoints.js)
        
        if [ -z "$CURRENT_ENDPOINTS" ] || [ ${#CURRENT_ENDPOINTS} -lt 10 ]; then
          echo "Current endpoints.js seems empty or too small"
          echo "Creating correct version..."
          
          cat > utils/config/endpoints.js << 'EOF'
          import { getApiUrl } from './env.js';

          export function getProductsEndpoint(limit = 30, skip = 0) {
            return getApiUrl('dummyjson', `/products?limit=${limit}&skip=${skip}`);
          }

          export function getProductByIdEndpoint(id) {
            return getApiUrl('dummyjson', `/products/${id}`);
          }

          export function searchProductsEndpoint(term) {
            return getApiUrl('dummyjson', `/products/search?q=${encodeURIComponent(term)}`);
          }

          export function getAllCategoriesEndpoint() {
            return getApiUrl('dummyjson', '/products/categories');
          }
          EOF
          
          echo "Created new endpoints.js"
        fi
        
        # Check env.js
        CURRENT_ENV=$(cat utils/config/env.js)
        
        if echo "$CURRENT_ENV" | grep -q "from 'k6'" || echo "$CURRENT_ENV" | grep -q 'from "k6"'; then
          echo "env.js imports k6 - fixing..."
          
          cat > utils/config/env.js << 'EOF'
          export function getApiUrl(service, path) {
            const baseUrls = {
              dummyjson: 'https://dummyjson.com',
              pet: 'https://petstore.swagger.io/v2',
              postman: 'https://postman-echo.com'
            };
            
            const baseUrl = baseUrls[service] || 'https://dummyjson.com';
            return `${baseUrl}${path}`;
          }
          EOF
          
          echo "Created new env.js without k6 imports"
        fi
        
    - name: Test with fixed files
      run: |
        echo "=== TESTING WITH POTENTIALLY FIXED FILES ==="
        
        cat > test-fixed.js << 'EOF'
        console.log('Testing imports after fix...');
        
        try {
          const endpoints = await import('utils/config/endpoints.js');
          console.log('✅ SUCCESS! Import works');
          console.log('Exports:', Object.keys(endpoints));
          
          // Test a function
          const url = endpoints.getProductsEndpoint(5, 0);
          console.log('Generated URL:', url);
          
        } catch (e) {
          console.log('❌ Still failing:', e.message);
          console.log('Stack:', e.stack);
        }
        
        export default function() {}
        EOF
        
        k6 run test-fixed.js
