# .github/workflows/final-fix-all.yml
name: Final Fix - All Files

on: [workflow_dispatch]

jobs:
  final-fix:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create clean env.js
      run: |
        echo "=== Creating clean env.js ==="
        
        # Backup if exists
        if [ -f utils/config/env.js ]; then
          cp utils/config/env.js utils/config/env.js.backup-final
          echo "Backed up existing env.js"
        fi
        
        # Create clean env.js with proper escaping
        cat > utils/config/env.js << "EOF"
// utils/config/env.js - Clean configuration
const baseUrls = {
  dummyjson: 'https://dummyjson.com',
  petstore: 'https://petstore.swagger.io/v2',
  pet: 'https://petstore.swagger.io/v2',
  postman: 'https://postman-echo.com',
  echo: 'https://postman-echo.com',
  github: 'https://api.github.com',
  jsonplaceholder: 'https://jsonplaceholder.typicode.com',
  reqres: 'https://reqres.in/api',
  local: 'http://localhost:3000'
};

export function getApiUrl(service, path) {
  const baseUrl = baseUrls[service] || baseUrls.dummyjson;
  const normalizedPath = path.startsWith('/') ? path : "/" + path;
  return baseUrl + normalizedPath;
}

export function getBaseUrl(service) {
  return baseUrls[service] || baseUrls.dummyjson;
}
EOF
        
        echo "✅ Created clean env.js"
        
    - name: Update endpoints.js with correct service names
      run: |
        echo "=== Updating endpoints.js ==="
        
        # Backup
        cp utils/config/endpoints.js utils/config/endpoints.js.backup-final
        
        # Read current file and replace 'pet' with 'petstore' for consistency
        sed -i "s/getApiUrl('pet'/getApiUrl('petstore'/g" utils/config/endpoints.js
        sed -i "s/getApiUrl(\"pet\"/getApiUrl(\"petstore\"/g" utils/config/endpoints.js
        
        echo "✅ Updated service names in endpoints.js"
        
    - name: Verify files
      run: |
        echo "=== Verifying files ==="
        echo "env.js:"
        head -20 utils/config/env.js
        echo ""
        echo "endpoints.js (first 20 lines):"
        head -20 utils/config/endpoints.js
        
    - name: Setup k6
      uses: grafana/setup-k6-action@v1
      
    - name: Run simple import test
      run: |
        echo "=== Simple import test ==="
        
        cat > simple-test.js << 'EOF'
        console.log('Testing imports...');
        
        try {
          const endpoints = await import('utils/config/endpoints.js');
          console.log('✅ SUCCESS! Endpoints imported');
          console.log('Functions found:', Object.keys(endpoints).length);
          
          // Test a few functions
          const url1 = endpoints.getProductsEndpoint(5, 0);
          console.log('Products URL:', url1);
          
          const url2 = endpoints.findByStatusEndpoint('available');
          console.log('Pet store URL:', url2);
          
        } catch (e) {
          console.log('❌ FAILED:', e.message);
          console.log('Stack:', e.stack);
        }
        
        export default function() {
          console.log('Test complete');
        }
        EOF
        
        k6 run simple-test.js
    
    - name: Test original smoke test path
      run: |
        echo "=== Testing smoke test import path ==="
        
        # Create a test at smoke test location
        mkdir -p tests/smoke-test
        cat > tests/smoke-test/test-path.js << 'EOF'
        console.log('Testing from smoke test perspective...');
        
        const paths = [
          '../../../utils/config/endpoints.js',  // Original path
          '../../utils/config/endpoints.js',     // Alternative
          'utils/config/endpoints.js'            // Absolute from root
        ];
        
        for (const path of paths) {
          console.log(`\nTrying: ${path}`);
          try {
            const mod = await import(path);
            console.log(`✅ Works! Found ${Object.keys(mod).length} functions`);
            break;
          } catch (e) {
            console.log(`❌ Failed: ${e.message}`);
          }
        }
        
        export default function() {}
        EOF
        
        # Run from project root
        k6 run tests/smoke-test/test-path.js
    
    - name: Create final working smoke test
      run: |
        echo "=== Creating final working smoke test ==="
        
        cat > tests/smoke-dummyjson-final.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        
        // Use the CORRECT import path for smoke directory
        // From tests/smoke/ to utils/config/ is: ../../utils/config/
        import { 
          getProductsEndpoint,
          getProductByIdEndpoint,
          searchProductsEndpoint
        } from '../../utils/config/endpoints.js';
        
        // Hardcode simple options for now
        export const options = {
          vus: 2,
          duration: '10s'
        };
        
        export default function () {
          // Test 1: Get products
          const productsUrl = getProductsEndpoint(5, 0);
          const products = http.get(productsUrl);
          
          check(products, {
            'status 200': (r) => r.status === 200,
            'has products': (r) => {
              try {
                const body = JSON.parse(r.body);
                return body.products && body.products.length > 0;
              } catch {
                return false;
              }
            }
          });
          
          // Test 2: Get single product
          const productId = Math.floor(Math.random() * 10) + 1;
          const productUrl = getProductByIdEndpoint(productId);
          const product = http.get(productUrl);
          
          check(product, {
            'product status 200': (r) => r.status === 200
          });
          
          sleep(1);
        }
        EOF
        
        echo "✅ Created final smoke test at: tests/smoke-dummyjson-final.js"
        
    - name: Run final smoke test
      run: |
        echo "=== Running final smoke test ==="
        k6 run tests/smoke-dummyjson-final.js
