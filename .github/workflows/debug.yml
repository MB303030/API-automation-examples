# .github/workflows/simple-debug-test.yml
name: Simple Debug Test

on: [workflow_dispatch]

jobs:
  simple-debug:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create simple debug script
      run: |
        # Create a very simple debug script
        cat > debug-simple.js << 'EOF'
        console.log('=== SIMPLE DEBUG ===');
        
        // Function to test imports
        async function testImport(path) {
          console.log('\\nTrying: ' + path);
          try {
            const module = await import(path);
            console.log('✅ SUCCESS');
            console.log('Functions: ' + Object.keys(module).join(', '));
            return true;
          } catch (e) {
            console.log('❌ FAILED: ' + (e.message || 'Unknown error'));
            return false;
          }
        }
        
        // Function to test file access
        function testFile(path) {
          console.log('\\nTrying file: ' + path);
          try {
            const content = open(path);
            console.log('✅ File exists, size: ' + content.length + ' chars');
            return true;
          } catch (e) {
            console.log('❌ File error: ' + e.message);
            return false;
          }
        }
        
        // Run tests
        console.log('\\n=== TESTING IMPORTS ===');
        await testImport('../../../utils/config/endpoints.js');
        await testImport('../../utils/config/endpoints.js');
        await testImport('utils/config/endpoints.js');
        
        console.log('\\n=== TESTING FILES ===');
        testFile('test-data/trafficPatterns.json');
        testFile('utils/config/endpoints.js');
        testFile('utils/config/env.js');
        
        console.log('\\n=== DEBUG COMPLETE ===');
        
        export default function() {
          console.log('Test iteration');
        }
        EOF
        
        echo "Created debug-simple.js"
        
        # Move to experimental directory
        mkdir -p tests/experimental
        mv debug-simple.js tests/experimental/
        
    - name: Check current files quickly
      run: |
        echo "=== Quick file check ==="
        echo "endpoints.js exists: $(ls utils/config/endpoints.js 2>/dev/null && echo YES || echo NO)"
        echo "env.js exists: $(ls utils/config/env.js 2>/dev/null && echo YES || echo NO)"
        echo ""
        echo "=== Checking env.js for k6 imports ==="
        if [ -f utils/config/env.js ]; then
          if grep -q "from 'k6'" utils/config/env.js || grep -q 'from "k6"' utils/config/env.js; then
            echo "❌ env.js has k6 imports - fixing..."
            cat > utils/config/env-clean.js << 'EOF'
            // Clean env.js
            const baseUrls = {
              dummyjson: 'https://dummyjson.com',
              petstore: 'https://petstore.swagger.io/v2',
              postman: 'https://postman-echo.com'
            };
            
            export function getApiUrl(service, path) {
              const baseUrl = baseUrls[service] || baseUrls.dummyjson;
              const normalizedPath = path.startsWith('/') ? path : '/' + path;
              return baseUrl + normalizedPath;
            }
            EOF
            mv utils/config/env-clean.js utils/config/env.js
            echo "✅ Created clean env.js"
          else
            echo "✅ env.js looks clean"
          fi
        else
          echo "⚠️ env.js not found, creating it..."
          cat > utils/config/env.js << 'EOF'
          // Clean env.js
          const baseUrls = {
            dummyjson: 'https://dummyjson.com',
            petstore: 'https://petstore.swagger.io/v2',
            postman: 'https://postman-echo.com'
          };
          
          export function getApiUrl(service, path) {
            const baseUrl = baseUrls[service] || baseUrls.dummyjson;
            const normalizedPath = path.startsWith('/') ? path : '/' + path;
            return baseUrl + normalizedPath;
          }
          EOF
        fi
        
        echo ""
        echo "=== Checking endpoints.js ==="
        if [ -f utils/config/endpoints.js ]; then
          echo "First 5 lines of endpoints.js:"
          head -5 utils/config/endpoints.js
        fi
    
    - name: Setup k6
      uses: grafana/setup-k6-action@v1
    
    - name: Run the debug
      run: |
        echo "=== Running debug from tests/experimental/ ==="
        k6 run tests/experimental/debug-simple.js
