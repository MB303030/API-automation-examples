# .github/workflows/check-env-file.yml
name: Check env.js File

on: [workflow_dispatch]

jobs:
  check-env:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Show env.js content
      run: |
        echo "=== ENV.JS FULL CONTENT ==="
        cat utils/config/env.js
        echo ""
        echo "=== FILE SIZE ==="
        wc -c utils/config/env.js
        echo ""
        echo "=== CHECKING FOR K6 IMPORTS ==="
        if grep -q "from 'k6'" utils/config/env.js || grep -q 'from "k6"' utils/config/env.js; then
          echo "❌ env.js imports k6!"
          echo "This file should NOT import k6 modules"
        else
          echo "✅ No k6 imports found"
        fi
        
        echo ""
        echo "=== CHECKING FOR EXPORTS ==="
        if grep -q "export" utils/config/env.js; then
          echo "✅ Has export statements"
        else
          echo "❌ No export statements found"
        fi
    
    - name: Test env.js directly
      run: |
        echo "=== TESTING ENV.JS WITH K6 ==="
        
        cat > test-env.js << 'EOF'
        console.log('Testing env.js import...');
        
        try {
          const env = await import('utils/config/env.js');
          console.log('✅ env.js import successful!');
          console.log('Exports:', Object.keys(env));
        } catch (e) {
          console.log('❌ env.js import failed');
          console.log('Error:', e.message);
          console.log('Stack:', e.stack);
        }
        
        export default function() {}
        EOF
        
        # Setup k6
        curl -L https://github.com/grafana/k6/releases/download/v1.5.0/k6-v1.5.0-linux-amd64.tar.gz | tar xz
        ./k6-v1.5.0-linux-amd64/k6 run test-env.js
    
    - name: Fix env.js if needed
      run: |
        echo "=== FIXING ENV.JS ==="
        
        # Backup original
        cp utils/config/env.js utils/config/env.js.backup
        
        # Create CORRECT env.js
        cat > utils/config/env.js << 'EOF'
        // CORRECT env.js - NO k6 imports!
        export function getApiUrl(service, path) {
          const baseUrls = {
            dummyjson: 'https://dummyjson.com',
            pet: 'https://petstore.swagger.io/v2',
            postman: 'https://postman-echo.com'
          };
          
          const baseUrl = baseUrls[service] || 'https://dummyjson.com';
          return `${baseUrl}${path}`;
        }
        EOF
        
        echo "Created corrected env.js"
        
    - name: Test the fix
      run: |
        echo "=== TESTING FIXED ENV.JS ==="
        
        cat > test-fix.js << 'EOF'
        console.log('Testing fixed env.js...');
        
        try {
          const env = await import('utils/config/env.js');
          console.log('✅ env.js import works!');
          console.log('Exports:', Object.keys(env));
          
          // Now test endpoints.js
          console.log('\nTesting endpoints.js...');
          const endpoints = await import('utils/config/endpoints.js');
          console.log('✅ endpoints.js import works!');
          console.log('Exports:', Object.keys(endpoints));
          
          // Test a function
          const url = endpoints.getProductsEndpoint(5, 0);
          console.log('Generated URL:', url);
          
        } catch (e) {
          console.log('❌ Still failing:', e.message);
        }
        
        export default function() {}
        EOF
        
        ./k6-v1.5.0-linux-amd64/k6 run test-fix.js
