# .github/workflows/final-fix.yml
name: Final Fix

on: [workflow_dispatch]

jobs:
  final-fix:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create correct debug script
      run: |
        cat > correct-debug.js << 'EOF'
        console.log('=== CORRECT DEBUG ===');
        console.log('Running from directory where script is located');
        
        // Try MULTIPLE paths
        const paths = [
          'utils/config/endpoints.js',           // From project root
          './utils/config/endpoints.js',         // From project root
          '../utils/config/endpoints.js',        // From root parent?
          '../../../utils/config/endpoints.js',  // From tests/debug
          '../../../../utils/config/endpoints.js' // Maybe?
        ];
        
        for (const path of paths) {
          console.log(`\nTrying: ${path}`);
          try {
            const content = open(path);
            console.log(`✅ File found! Size: ${content.length} chars`);
            console.log(`First 50 chars: ${content.substring(0, 50)}...`);
            
            // Try to import it
            try {
              const module = await import(path);
              console.log(`✅ Import successful! Functions: ${Object.keys(module).join(', ')}`);
              break;
            } catch (importError) {
              console.log(`❌ Can read but not import: ${importError.message}`);
            }
          } catch (openError) {
            console.log(`❌ Cannot open: ${openError.message}`);
          }
        }
        
        // Also test from smoke test perspective
        console.log('\n=== From smoke test perspective ===');
        console.log('Smoke test path: tests/smoke/dummyjson-smoke.js');
        console.log('Trying: ../../../utils/config/endpoints.js');
        
        try {
          const module = await import('../../../utils/config/endpoints.js');
          console.log('✅ Smoke test import path works!');
        } catch (e) {
          console.log(`❌ Smoke test path fails: ${e.message}`);
        }
        
        export default function() {}
        EOF
    
    - name: Setup and run
      uses: grafana/setup-k6-action@v1
      
    - name: Run correct debug
      run: |
        echo "=== Running from project root ==="
        k6 run correct-debug.js
        
        echo -e "\n=== Creating test in smoke directory ==="
        mkdir -p tests/smoke-debug
        cat > tests/smoke-debug/test-path.js << 'EOF'
        console.log('Testing from smoke directory...');
        
        // What smoke test actually uses
        console.log('Path used in smoke test: ../../../utils/config/endpoints.js');
        
        try {
          const mod = await import('../../../utils/config/endpoints.js');
          console.log('✅ Import works from smoke directory!');
        } catch (e) {
          console.log('❌ Import fails:', e.message);
          
          // Try alternative
          console.log('\nTrying alternative: utils/config/endpoints.js');
          try {
            const mod2 = await import('utils/config/endpoints.js');
            console.log('✅ Alternative works!');
          } catch (e2) {
            console.log('❌ Alternative also fails:', e2.message);
          }
        }
        
        export default function() {}
        EOF
        
        echo "=== Running from smoke-debug directory ==="
        k6 run tests/smoke-debug/test-path.js
