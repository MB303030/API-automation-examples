name: gpt

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options: [single-region, multi-region]
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'smoke'
        type: choice
        options: [smoke, load, spike, stress]

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_TIMESTAMP: ${{ github.run_id }}

jobs:
# ============================================================
# SINGLE REGION PERFORMANCE TESTING (UNCHANGED)
# ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      # â¬…ï¸ YOUR ENTIRE SINGLE REGION JOB IS UNCHANGED
      # (intentionally omitted here for brevity â€” logic untouched)

# ============================================================
# MULTI-REGION PERFORMANCE TESTING (FIXED, NOT REDUCED)
# ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        region: [us-west, eu-west, apac-sg]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Determine test path
        run: |
          echo "TEST_TYPE=${{ github.event.inputs.test_type }}" >> $GITHUB_ENV
          echo "TEST_FILE=tests/performance/${{ github.event.inputs.test_type }}/dummyjson-${{ github.event.inputs.test_type }}.js" >> $GITHUB_ENV

      - name: Run test in ${{ matrix.region }}
        run: |
          k6 run "$TEST_FILE" \
            --tag region="${{ matrix.region }}" \
            --out json="results-${{ matrix.region }}.json" \
            2>&1 | tee "output-${{ matrix.region }}.txt"

      - name: Extract metrics from results
        run: |
          AVG=$(grep "http_req_duration.*avg" output-${{ matrix.region }}.txt | tail -1 | sed 's/.*avg=//; s/ .*//')
          P95=$(grep "http_req_duration.*p(95)" output-${{ matrix.region }}.txt | tail -1 | sed 's/.*p(95)=//; s/ .*//')
          ERR=$(grep "http_req_failed.*rate" output-${{ matrix.region }}.txt | tail -1 | sed 's/.*rate=//; s/ .*//')
          ERR_PCT=$(echo "scale=2; $ERR * 100" | bc)

          echo "AVG=$AVG" >> $GITHUB_ENV
          echo "P95=$P95" >> $GITHUB_ENV
          echo "ERR_PCT=$ERR_PCT" >> $GITHUB_ENV

      - name: Create region summary
        run: |
          cat > summary-${{ matrix.region }}.md << EOF
          ## Region: ${{ matrix.region }}
          | Metric | Value |
          |-------|-------|
          | Avg | ${AVG}ms |
          | P95 | ${P95}ms |
          | Error | ${ERR_PCT}% |
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: region-${{ matrix.region }}-results
          path: |
            output-${{ matrix.region }}.txt
            results-${{ matrix.region }}.json
            summary-${{ matrix.region }}.md

# ============================================================
# REGIONAL ANALYSIS & COMBINED REPORT (FIXED)
# ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y bc

      - uses: actions/download-artifact@v4
        with:
          path: regional-results
          merge-multiple: true

      - name: Generate Global Report
        run: |
          echo "# ðŸŒ Global Performance Report" > global-report.md
          for r in us-west eu-west apac-sg; do
            if [ -f "regional-results/summary-$r.md" ]; then
              cat "regional-results/summary-$r.md" >> global-report.md
            fi
          done
          cat global-report.md >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: global-performance-report
          path: global-report.md

# ============================================================
# WORKFLOW SUMMARY (FIXED DEPENDENCIES)
# ============================================================
  workflow-summary:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - single-region-test
      - regional-analysis
    steps:
      - name: Final Summary
        run: |
          echo "## âœ… Workflow completed" >> $GITHUB_STEP_SUMMARY
