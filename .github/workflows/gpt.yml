name: Performance (Regional + Graphs + Insights)

on:
  workflow_dispatch:
    inputs:
      test_type:
        required: true
        default: all
        type: choice
        options: [all, smoke, load, spike, stress]

jobs:
  regional-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        region:
          - id: us
            label: "US (Likely West)"
          - id: eu
            label: "EU (Likely Netherlands)"

    env:
      REGION_ID: ${{ matrix.region.id }}
      REGION_LABEL: ${{ matrix.region.label }}
      TEST_TYPE: ${{ github.event.inputs.test_type }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine tests to run
        run: |
          for T in SMOKE LOAD SPIKE STRESS; do
            echo "RUN_$T=false" >> $GITHUB_ENV
          done
          if [ "$TEST_TYPE" = "all" ]; then
            for T in SMOKE LOAD SPIKE STRESS; do
              echo "RUN_$T=true" >> $GITHUB_ENV
            done
          else
            echo "RUN_${TEST_TYPE^^}=true" >> $GITHUB_ENV
          fi

      - name: Run k6 tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
            ["stress"]="tests/performance/stress/dummyjson-stress.js"
          )

          for TEST in smoke load spike stress; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              k6 run "${TESTS[$TEST]}" \
                --env REGION="$REGION_LABEL" \
                --out json="k6-${TEST}-${REGION_ID}.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
            fi
          done

      - name: Generate graphs & analysis (UNCHANGED)
        run: |
          bash .github/scripts/generate-report.sh

      - name: Upload regional artifacts
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.region.id }}
          path: |
            k6-*.json
            k6-*-output.txt

  global-insights:
    needs: regional-tests
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt-get update && sudo apt-get install -y jq bc
      - uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Build global comparison
        run: |
          echo "# ðŸŒ Global Performance Comparison" > GLOBAL_REPORT.md
          echo "| Region | p95 | Error % |" >> GLOBAL_REPORT.md
          echo "|--------|-----|--------|" >> GLOBAL_REPORT.md

          for f in all-results/results-*/k6-*-*.json; do
            REGION=$(basename "$(dirname "$f")" | cut -d'-' -f2)
            P95=$(jq '.metrics.http_req_duration.values["p(95)"]' "$f")
            ERR=$(jq '.metrics.http_req_failed.values.rate * 100' "$f")
            echo "| $REGION | ${P95}ms | ${ERR}% |" >> GLOBAL_REPORT.md
          done

          cat GLOBAL_REPORT.md

      - uses: actions/upload-artifact@v4
        with:
          name: global-performance-report
          path: GLOBAL_REPORT.md
