name: GPT Regional API Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Which existing test to run in all regions?'
        required: true
        default: 'load'
        type: choice
        options:
          - smoke
          - load
          - spike
          - stress

jobs:
  test-regions:
    defaults:
      run:
        shell: bash   # âœ… FIX 1: force bash on all runners

    strategy:
      matrix:
        runner: [ubuntu-latest, windows-latest]
        include:
          - runner: ubuntu-latest
            region_label: "US (Likely West)"
            region_id: us-west
          - runner: windows-latest
            region_label: "EU (Likely Netherlands)"
            region_id: eu-nl

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run test from ${{ matrix.region_label }}
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          TEST_PATH="tests/performance/$TEST_TYPE/dummyjson-$TEST_TYPE.js"

          echo "ðŸ“ Running test: $TEST_PATH"
          echo "ðŸ“ Region: ${{ matrix.region_label }}"

          k6 run "$TEST_PATH" \
            --out json="results-${{ matrix.region_id }}.json" \
            --summary-export="summary-${{ matrix.region_id }}.json" \
            2>&1 | tee "output-${{ matrix.region_id }}.txt"

      - name: Upload results for this region
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.region_id }}-${{ github.event.inputs.test_type }}
          path: |
            results-${{ matrix.region_id }}.json
            summary-${{ matrix.region_id }}.json
            output-${{ matrix.region_id }}.txt

  combine-report:
    runs-on: ubuntu-latest
    needs: test-regions

    steps:
      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc   # âœ… FIX 3

      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Create combined regional report
        run: |
          echo "# ðŸŒ Regional Performance Comparison" > REGIONAL_REPORT.md
          echo "**Test:** ${{ github.event.inputs.test_type }}" >> REGIONAL_REPORT.md
          echo "" >> REGIONAL_REPORT.md
          echo "| Region | Avg Latency | p95 Latency | Error Rate | Max VUs |" >> REGIONAL_REPORT.md
          echo "|--------|-------------|-------------|------------|--------|" >> REGIONAL_REPORT.md

          for summary in all-results/results-*/summary-*.json; do
            REGION=$(basename "$summary" .json | cut -d'-' -f2-)

            AVG=$(jq -r '.metrics.http_req_duration.values.avg // "N/A"' "$summary")
            P95=$(jq -r '.metrics.http_req_duration.values."p(95)" // "N/A"' "$summary")
            ERR=$(jq -r '.metrics.http_req_failed.values.rate // 0' "$summary")
            MAX_VUS=$(jq -r '.metrics.vus.values.max // "N/A"' "$summary")

            ERR_PCT=$(echo "scale=2; $ERR * 100" | bc)

            echo "| $REGION | ${AVG}ms | ${P95}ms | ${ERR_PCT}% | $MAX_VUS |" >> REGIONAL_REPORT.md
          done

          cat REGIONAL_REPORT.md

      - name: Upload final combined report
        uses: actions/upload-artifact@v4
        with:
          name: regional-comparison-report
          path: |
            REGIONAL_REPORT.md
            all-results/
