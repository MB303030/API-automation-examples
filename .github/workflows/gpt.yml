name: GPT region Performance

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, load, spike, stress]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        region:
          - region_id: us-west
            region_label: "US (Likely West)"
          - region_id: eu-nl
            region_label: "EU (Likely Netherlands)"

    env:
      K6_REGION: ${{ matrix.region_label }}
      K6_REGION_ID: ${{ matrix.region.region_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # ----------------------------------------------------
      # Decide which tests to run (UNCHANGED)
      # ----------------------------------------------------
      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"

          for T in SMOKE LOAD SPIKE STRESS; do
            echo "RUN_$T=false" >> $GITHUB_ENV
          done

          if [ "$TEST_TYPE" = "all" ]; then
            for T in SMOKE LOAD SPIKE STRESS; do
              echo "RUN_$T=true" >> $GITHUB_ENV
            done
          else
            echo "RUN_${TEST_TYPE^^}=true" >> $GITHUB_ENV
          fi

      # ----------------------------------------------------
      # Run selected tests (REGIONAL)
      # ----------------------------------------------------
      - name: Run Selected Performance Tests (Regional)
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
            ["stress"]="tests/performance/stress/dummyjson-stress.js"
          )

          for TEST in smoke load spike stress; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              echo "ðŸŒ Region: $K6_REGION"
              echo "ðŸš€ Running ${TEST^} test"

              k6 run "${TESTS[$TEST]}" \
                --env REGION="$K6_REGION" \
                --out json="k6-${TEST}-${K6_REGION_ID}.json" \
                2>&1 | tee "k6-${TEST}-${K6_REGION_ID}-output.txt"
            fi
          done

      # ----------------------------------------------------
      # REGIONAL METRICS SUMMARY (NEW)
      # ----------------------------------------------------
      - name: Add Regional Metrics Summary
        run: |
          echo "## ðŸŒ Regional Results â€“ $K6_REGION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | p95 (ms) | Error Rate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------------|--------|" >> $GITHUB_STEP_SUMMARY

          for TEST in smoke load spike stress; do
            FILE="k6-${TEST}-${K6_REGION_ID}-output.txt"
            if [ -f "$FILE" ]; then
              P95=$(grep "p(95)=" "$FILE" | tail -1 | sed 's/.*p(95)=//; s/ms.*//')
              ERR=$(grep "http_req_failed" "$FILE" | grep rate | tail -1 | sed 's/.*rate=//; s/%.*//')
              if grep -q "âŒ" "$FILE"; then STATUS="âŒ FAIL"; else STATUS="âœ… PASS"; fi
              echo "| ${TEST^} | ${P95:-N/A} | ${ERR:-0}% | $STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

      # ----------------------------------------------------
      # UPLOAD REGIONAL ARTIFACTS
      # ----------------------------------------------------
      - name: Upload Regional Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-${{ matrix.region.region_id }}
          path: |
            k6-*-output.txt
            k6-*.json
