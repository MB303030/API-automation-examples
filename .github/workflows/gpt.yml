name: k6 GPT
on:
  workflow_dispatch:
  push:
    paths:
      - 'tests/performance/**'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  k6-performance:
    runs-on: ubuntu-latest

    env:
      SLA_P95_MS: 800
      SLA_ERROR_RATE: 1

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Setup k6
      # ------------------------------------------------------------
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # ------------------------------------------------------------
      # 3. Setup Node & Chart tooling
      # ------------------------------------------------------------
      - name: Setup chart tools
        run: |
          npm init -y
          npm install chart.js chartjs-node-canvas

      # ------------------------------------------------------------
      # 4. Run k6 test
      # ------------------------------------------------------------
      - name: Run k6 test
        run: |
          k6 run tests/performance/custom-stress.js \
            --out json=k6-results.json \
            --summary-export=k6-summary.json \
            2>&1 | tee k6-output.txt

      # ------------------------------------------------------------
      # 5. Convert JSON ‚Üí CSV
      # ------------------------------------------------------------
      - name: Convert JSON to CSV
        run: |
          node <<'EOF'
          const fs = require('fs');
          const s = JSON.parse(fs.readFileSync('k6-summary.json'));
          let csv = 'metric,p50,p90,p95,max\n';

          for (const [k, v] of Object.entries(s.metrics)) {
            if (!v.values) continue;
            csv += [
              k,
              v.values.med || '',
              v.values['p(90)'] || '',
              v.values['p(95)'] || '',
              v.values.max || ''
            ].join(',') + '\n';
          }

          fs.writeFileSync('k6-metrics.csv', csv);
          EOF

      # ------------------------------------------------------------
      # 6. Generate percentile charts
      # ------------------------------------------------------------
      - name: Generate charts
        run: |
          mkdir -p charts

          cat > generate-charts.cjs << 'EOF'
          const fs = require('fs');
          const { ChartJSNodeCanvas } = require('chartjs-node-canvas');

          (async () => {
            const s = JSON.parse(fs.readFileSync('k6-summary.json'));
            const m = s.metrics.http_req_duration.values;

            const canvas = new ChartJSNodeCanvas({ width: 900, height: 500 });

            const img = await canvas.renderToBuffer({
              type: 'bar',
              data: {
                labels: ['p90', 'p95'],
                datasets: [{
                  label: 'HTTP Req Duration (ms)',
                  data: [m['p(90)'], m['p(95)']],
                  backgroundColor: ['#36a2eb', '#ff6384']
                }]
              },
              options: {
                plugins: { title: { display: true, text: 'Latency Percentiles' } }
              }
            });

            fs.writeFileSync('charts/http-percentiles.png', img);
          })();
          EOF

          node generate-charts.cjs

      # ------------------------------------------------------------
      # 7. üß† Auto-Generated Performance Insights
      # ------------------------------------------------------------
      - name: Generate performance insights
        run: |
          node <<'EOF'
          const fs = require('fs');
          const s = JSON.parse(fs.readFileSync('k6-summary.json'));

          const p50 = s.metrics.http_req_duration.values.med;
          const p90 = s.metrics.http_req_duration.values['p(90)'];
          const p95 = s.metrics.http_req_duration.values['p(95)'];
          const max = s.metrics.http_req_duration.values.max;
          const errorRate = (s.metrics.http_req_failed.values.rate || 0) * 100;

          let insights = [];

          if (p95 > process.env.SLA_P95_MS) {
            insights.push(`üö® **High latency:** p95 (${p95} ms) exceeds SLA (${process.env.SLA_P95_MS} ms). Users may experience noticeable slowness.`);
          } else if (p95 > process.env.SLA_P95_MS * 0.8) {
            insights.push(`‚ö†Ô∏è **Latency risk:** p95 (${p95} ms) is close to SLA. Monitor before traffic increases.`);
          } else {
            insights.push(`‚úÖ **Latency healthy:** p95 (${p95} ms) is well within SLA.`);
          }

          if (errorRate > process.env.SLA_ERROR_RATE) {
            insights.push(`‚ùå **Error rate high:** ${errorRate.toFixed(2)}% errors detected. This may indicate backend instability.`);
          } else {
            insights.push(`‚úÖ **Error rate stable:** ${errorRate.toFixed(2)}% errors.`);
          }

          insights.push(`üìä **Latency distribution:** p50=${p50} ms, p90=${p90} ms, max=${max} ms.`);

          fs.writeFileSync('performance-insights.md', insights.join('\n\n'));
          console.log(insights.join('\n\n'));
          EOF

      # ------------------------------------------------------------
      # 8. SLA Enforcement (fail pipeline)
      # ------------------------------------------------------------
      - name: Enforce SLA
        run: |
          node <<'EOF'
          const s = JSON.parse(require('fs').readFileSync('k6-summary.json'));
          const p95 = s.metrics.http_req_duration.values['p(95)'];
          const err = (s.metrics.http_req_failed.values.rate || 0) * 100;

          if (p95 > process.env.SLA_P95_MS || err > process.env.SLA_ERROR_RATE) {
            process.exit(1);
          }
          EOF

      # ------------------------------------------------------------
      # 9. Upload artifacts
      # ------------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: |
            charts/
            k6-summary.json
            k6-results.json
            k6-metrics.csv
            performance-insights.md

      # ------------------------------------------------------------
      # 10. Publish to GitHub Pages
      # ------------------------------------------------------------
      - name: Build Pages report
        run: |
          mkdir public
          cp -r charts public/

          cat > public/index.html <<'EOF'
          <html>
          <head><title>k6 Performance Report</title></head>
          <body>
            <h1>üìà Performance Report</h1>
            <img src="charts/http-percentiles.png"/>

            <h2>üß† Insights</h2>
            <pre>
          EOF

          cat performance-insights.md >> public/index.html

          cat >> public/index.html <<'EOF'
            </pre>
          </body>
          </html>
          EOF

      - name: Deploy Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: k6-performance
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4
