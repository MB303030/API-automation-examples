name: gpt

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options: [single-region, multi-region]
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'smoke'
        type: choice
        options: [smoke, load, spike, stress]

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_TIMESTAMP: ${{ github.run_id }}

jobs:

# ============================================================
# MULTI REGION TESTS (UNCHANGED â€“ WORKING)
# ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        region: [us-west, eu-west, apac-sg]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - run: sudo apt-get update && sudo apt-get install -y bc

      - name: Run test
        run: |
          TEST_FILE="tests/performance/${{ github.event.inputs.test_type }}/dummyjson-${{ github.event.inputs.test_type }}.js"

          k6 run "$TEST_FILE" \
            --tag region="${{ matrix.region }}" \
            --out json="results-${{ matrix.region }}.json" \
            2>&1 | tee "output-${{ matrix.region }}.txt"

      - name: Extract metrics
        run: |
          AVG=$(grep "http_req_duration.*avg" output-${{ matrix.region }}.txt | tail -1 | sed 's/.*avg=//; s/ .*//')
          P95=$(grep "http_req_duration.*p(95)" output-${{ matrix.region }}.txt | tail -1 | sed 's/.*p(95)=//; s/ .*//')
          ERR=$(grep "http_req_failed.*rate" output-${{ matrix.region }}.txt | tail -1 | sed 's/.*rate=//; s/ .*//')
          ERR_PCT=$(echo "scale=2; $ERR * 100" | bc)

          cat > summary-${{ matrix.region }}.md << EOF
          REGION=${{ matrix.region }}
          AVG=${AVG}
          P95=${P95}
          ERR=${ERR_PCT}
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: region-${{ matrix.region }}-results
          path: |
            summary-${{ matrix.region }}.md
            output-${{ matrix.region }}.txt
            results-${{ matrix.region }}.json

# ============================================================
# ðŸ”¥ REGIONAL ANALYSIS + VISUAL UI SUMMARY (FIXED)
# ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Download regional artifacts
        uses: actions/download-artifact@v4
        with:
          path: regional-results
          merge-multiple: true

      - name: Generate Visual Summary
        run: |
          echo "# ðŸŒ Multi-Region Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REGIONS=()
          AVG=()
          P95=()
          ERR=()

          for r in us-west eu-west apac-sg; do
            FILE="regional-results/summary-$r.md"
            if [ -f "$FILE" ]; then
              source "$FILE"
              REGIONS+=("$r")
              AVG+=("$AVG")
              P95+=("$P95")
              ERR+=("$ERR")
            fi
          done

          # ===============================
          # TABLE
          # ===============================
          echo "## ðŸ“Š Regional Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Region | Avg (ms) | P95 (ms) | Error % | Verdict |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|----------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for i in "${!REGIONS[@]}"; do
            STATUS="âœ… Healthy"
            if (( $(echo "${ERR[$i]} > 5" | bc -l) )); then STATUS="ðŸ”´ Unstable"; fi
            echo "| ${REGIONS[$i]} | ${AVG[$i]} | ${P95[$i]} | ${ERR[$i]} | $STATUS |" >> $GITHUB_STEP_SUMMARY
          done

          # ===============================
          # GRAPH â€“ AVG RESPONSE
          # ===============================
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â±ï¸ Average Response Time" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo 'title "Average Response Time by Region"' >> $GITHUB_STEP_SUMMARY
          echo 'x-axis ["us-west","eu-west","apac-sg"]' >> $GITHUB_STEP_SUMMARY
          echo 'y-axis "ms" 0 --> 4000' >> $GITHUB_STEP_SUMMARY
          echo "bar [${AVG[0]},${AVG[1]},${AVG[2]}]" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # ===============================
          # GRAPH â€“ P95
          # ===============================
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš¡ P95 Latency" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo 'title "P95 Latency by Region"' >> $GITHUB_STEP_SUMMARY
          echo 'x-axis ["us-west","eu-west","apac-sg"]' >> $GITHUB_STEP_SUMMARY
          echo 'y-axis "ms" 0 --> 6000' >> $GITHUB_STEP_SUMMARY
          echo "line [${P95[0]},${P95[1]},${P95[2]}]" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # ===============================
          # GRAPH â€“ ERROR RATE
          # ===============================
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš¨ Error Rate" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo 'title "Error Rate by Region"' >> $GITHUB_STEP_SUMMARY
          echo 'x-axis ["us-west","eu-west","apac-sg"]' >> $GITHUB_STEP_SUMMARY
          echo 'y-axis "% errors" 0 --> 20' >> $GITHUB_STEP_SUMMARY
          echo "bar [${ERR[0]},${ERR[1]},${ERR[2]}]" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # ===============================
          # HUMAN INSIGHTS
          # ===============================
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§  Human-Readable Insights" >> $GITHUB_STEP_SUMMARY

          echo "- **Fastest region:** ${REGIONS[0]} (~${AVG[0]}ms avg)" >> $GITHUB_STEP_SUMMARY
          echo "- **Slowest region:** ${REGIONS[2]} (~${AVG[2]}ms avg)" >> $GITHUB_STEP_SUMMARY
          echo "- **Highest error rate:** ${REGIONS[2]} (${ERR[2]}%)" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "${ERR[2]} > 5" | bc -l) )); then
            echo "> ðŸ”´ **Risk detected:** One region shows instability under load." >> $GITHUB_STEP_SUMMARY
          else
            echo "> ðŸŸ¢ **Global system is stable across regions.**" >> $GITHUB_STEP_SUMMARY
          fi
