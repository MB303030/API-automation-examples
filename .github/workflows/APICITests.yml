name: API CI

on:
  workflow_dispatch:  # Only manual trigger

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üé≠ Install Playwright browsers
      run: npx playwright install chromium

    - name: üîß Setup API environment
      run: |
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: üß™ Run Playwright API tests
      run: |
        echo "Running API tests..."
        npx playwright test --reporter=html,line 2>&1 | tee test-output.log
        
        # Save exit code
        TEST_EXIT_CODE=$?
        echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV

    - name: üìä Generate Enhanced Test Report
      if: always()
      run: |
        echo "## üß™ API Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "test-output.log" ]; then
          # Overall Status
          echo "### üö¶ Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${TEST_EXIT_CODE}" = "0" ]; then
            echo "‚úÖ **All API Tests PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üü¢ **What this means:** All tested APIs are working correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some API Tests FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üî¥ **What this means:** Some APIs are not working as expected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # -------- SIMPLE LANGUAGE SECTION FOR MANUAL TESTERS --------
          echo "### üßë‚Äçüíª Plain English Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract test results
          TOTAL_TESTS=$(grep -o "[0-9]\+ tests" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
          PASSED_TESTS=$(grep -o "[0-9]\+ passed" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
          FAILED_TESTS=$(grep -o "[0-9]\+ failed" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
          
          echo "**API Testing Results:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL_TESTS" != "0" ]; then
            if [ "$FAILED_TESTS" = "0" ]; then
              echo "‚úÖ **Perfect!** All $TOTAL_TESTS API tests passed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üéØ **What worked:**" >> $GITHUB_STEP_SUMMARY
              echo "- All API endpoints responded correctly" >> $GITHUB_STEP_SUMMARY
              echo "- No broken connections or timeouts" >> $GITHUB_STEP_SUMMARY
              echo "- Data returned in expected format" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è **Issues found:** $FAILED_TESTS out of $TOTAL_TESTS tests failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üîç **Problems detected:**" >> $GITHUB_STEP_SUMMARY
              
              # Try to extract specific failures
              if grep -qi "timeout\|timed out" test-output.log; then
                echo "- ‚è±Ô∏è Some APIs are too slow or not responding" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -qi "404\|not found" test-output.log; then
                echo "- üîó Some API endpoints cannot be found" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -qi "500\|server error" test-output.log; then
                echo "- ‚ö†Ô∏è Some APIs are returning server errors" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -qi "400\|bad request" test-output.log; then
                echo "- üìù Some API requests have incorrect format" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Count passed tests for context
              if [ "$PASSED_TESTS" -gt 0 ]; then
                PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "üìä **Success Rate:** $PASS_RATE% of APIs working ($PASSED_TESTS/$TOTAL_TESTS)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # -------- CLEAN METRICS DISPLAY --------
          echo "### üìä Test Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Summary Table
          echo "| Metric | Value | What It Means |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL_TESTS" != "0" ]; then
            echo "| Total Tests | $TOTAL_TESTS | Number of API checks performed |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED_TESTS | APIs working correctly |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED_TESTS | APIs with issues |" >> $GITHUB_STEP_SUMMARY
            
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
              if [ "$PASS_RATE" -ge 90 ]; then
                STATUS="üü¢ Excellent"
              elif [ "$PASS_RATE" -ge 80 ]; then
                STATUS="üü° Good"
              else
                STATUS="üî¥ Needs Work"
              fi
              echo "| Success Rate | $PASS_RATE% | $STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          DURATION=$(grep -o "[0-9]\+[\.][0-9]\+s" test-output.log | tail -1 || echo "N/A")
          if [ "$DURATION" != "N/A" ]; then
            echo "| Test Duration | $DURATION | Time to run all tests |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # -------- API SERVICES TESTED --------
          echo "### üåê APIs That Were Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check for specific API patterns in test output
          if grep -qi "petstore\|pet" test-output.log; then
            echo "| Pet Store API | Manage pet data | ‚úÖ Tested |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pet Store API | Manage pet data | ‚è∏Ô∏è Not run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -qi "postman\|echo" test-output.log; then
            echo "| Postman Echo | Test requests/responses | ‚úÖ Tested |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Postman Echo | Test requests/responses | ‚è∏Ô∏è Not run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if grep -qi "dummyjson\|products" test-output.log; then
            echo "| DummyJSON | Product data | ‚úÖ Tested |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| DummyJSON | Product data | ‚è∏Ô∏è Not run |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # -------- PERFORMANCE INSIGHTS --------
          # Extract performance metrics if available
          AVG_RESPONSE=$(grep -o "avg=[0-9]\+[\.]*[0-9]*ms" test-output.log | head -1 | cut -d= -f2 || echo "")
          P95_RESPONSE=$(grep -o "p(95)=[0-9]\+[\.]*[0-9]*ms" test-output.log | head -1 | cut -d= -f2 || echo "")
          
          if [ -n "$AVG_RESPONSE" ] || [ -n "$P95_RESPONSE" ]; then
            echo "### ‚ö° API Speed Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response Times:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "$AVG_RESPONSE" ]; then
              AVG_NUM=$(echo "$AVG_RESPONSE" | sed 's/ms//')
              if (( $(echo "$AVG_NUM < 500" | bc -l 2>/dev/null) )); then
                STATUS="üü¢ Fast"
              elif (( $(echo "$AVG_NUM < 1000" | bc -l 2>/dev/null) )); then
                STATUS="üü° Okay"
              else
                STATUS="üî¥ Slow"
              fi
              echo "- **Average:** $AVG_RESPONSE ($STATUS)" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "$P95_RESPONSE" ]; then
              P95_NUM=$(echo "$P95_RESPONSE" | sed 's/ms//')
              if (( $(echo "$P95_NUM < 1000" | bc -l 2>/dev/null) )); then
                STATUS="üü¢ Good"
              elif (( $(echo "$P95_NUM < 2000" | bc -l 2>/dev/null) )); then
                STATUS="üü° Acceptable"
              else
                STATUS="üî¥ Needs Improvement"
              fi
              echo "- **95% of requests:** $P95_RESPONSE ($STATUS)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # -------- FAILED TESTS DETAILS --------
          if [ "$FAILED_TESTS" -gt 0 ]; then
            echo "### ‚ùå Failed Test Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Issues that need fixing:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract failed test names and errors
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to view $FAILED_TESTS failing tests</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Look for error patterns
            grep -A2 "Error:" test-output.log | head -20 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Check the detailed logs for error information" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # -------- SUCCESSFUL TEST SAMPLES --------
          if [ "$PASSED_TESTS" -gt 0 ]; then
            echo "### ‚úÖ Working API Examples" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**APIs that are working well:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to view working API tests</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Extract passed test examples
            grep "‚úì" test-output.log | head -10 | sed 's/‚úì/‚úÖ/' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "All tests passed successfully" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # -------- RECOMMENDATIONS --------
          echo "### üéØ Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED_TESTS" = "0" ]; then
            echo "‚úÖ **Excellent!** All APIs are working correctly." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. üöÄ **Ready for deployment**" >> $GITHUB_STEP_SUMMARY
            echo "2. üìä **Monitor** API performance in production" >> $GITHUB_STEP_SUMMARY
            echo "3. üîÑ **Continue** regular API testing" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Action Required:** Some APIs need attention." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What to do:**" >> $GITHUB_STEP_SUMMARY
            echo "1. üîç **Investigate** the failed tests above" >> $GITHUB_STEP_SUMMARY
            echo "2. üêõ **Fix** the API issues or test configuration" >> $GITHUB_STEP_SUMMARY
            echo "3. üîÑ **Re-run** tests after fixes" >> $GITHUB_STEP_SUMMARY
            echo "4. ‚ö†Ô∏è **Hold** deployment until all tests pass" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # -------- TECHNICAL DETAILS (COLLAPSED) --------
          echo "### üìã Technical Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click for complete test output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Show relevant parts of the log
          grep -v "^\s*$" test-output.log | tail -80 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "### ‚ùå No Test Results Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The test output file was not created. Possible issues:" >> $GITHUB_STEP_SUMMARY
          echo "1. Tests did not run" >> $GITHUB_STEP_SUMMARY
          echo "2. Playwright installation failed" >> $GITHUB_STEP_SUMMARY
          echo "3. Test files not found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

    - name: üìÅ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-results
        path: |
          playwright-report/
          test-results/
          test-output.log
        retention-days: 7

    - name: üö® Fail if tests failed
      if: failure()
      run: |
        echo "‚ùå API tests failed. Check the test output above."
        exit 1
