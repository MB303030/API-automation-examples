name: API CI Tests

on:
  workflow_dispatch:  # Only manual trigger

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üé≠ Install Playwright browsers
      run: npx playwright install chromium

    - name: üîß Setup API environment
      run: |
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: üß™ Run Playwright API tests
      run: |
        echo "Running API tests..."
        npx playwright test 2>&1 | tee test-output.log
        
        # Save exit code
        TEST_EXIT_CODE=$?
        echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV

    - name: üìä Generate Test Report
      if: always()
      run: |
        echo "## üìã API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "‚úÖ **Status: All tests PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Status: Some tests FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Files Executed:**" >> $GITHUB_STEP_SUMMARY
        
        # List test files
        if ls tests/*.spec.js 1> /dev/null 2>&1; then
          for file in tests/*.spec.js; do
            echo "- $(basename $file)" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        if ls tests/*/*.spec.js 1> /dev/null 2>&1; then
          for file in tests/*/*.spec.js; do
            echo "- $(basename $(dirname $file))/$(basename $file)" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**APIs Tested:**" >> $GITHUB_STEP_SUMMARY
        echo "- Pet Store API (Swagger)" >> $GITHUB_STEP_SUMMARY
        echo "- Postman Echo API" >> $GITHUB_STEP_SUMMARY
        echo "- DummyJSON Products API" >> $GITHUB_STEP_SUMMARY
        
        # Show test output summary
        if [ -f "test-output.log" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>View Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 test-output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi

    - name: üìÅ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-test-results
        path: |
          playwright-report/
          test-results/
          test-output.log
        retention-days: 7

    - name: üö® Fail if tests failed
      if: failure()
      run: |
        echo "‚ùå API tests failed. Check the test output above."
        exit 1
