name: API CI Tests

on:
  workflow_dispatch:  # Only manual trigger, no automatic runs

jobs:
  # Job 1: Functional API tests with Playwright
  playwright-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright
      run: npx playwright install chromium

    - name: ðŸ”§ Setup API environment variables
      run: |
        echo "API_KEY=test-key-${{ github.run_id }}" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://postman-echo.com"  # Fixed URL
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: ðŸ§ª Run Playwright API tests
      run: npx playwright test

    - name: ðŸ“Š Generate Playwright HTML Report
      if: always()
      uses: mikepenz/action-playwright-report@v1
      with:
        path: playwright-report

    - name: ðŸ“¤ Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-api-report
        path: playwright-report/
        retention-days: 7

    - name: ðŸ“‹ Test Summary
      if: always()
      run: |
        echo "## ðŸ“Š API Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Execution:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if tests passed
        if [ -f "test-results.json" ]; then
          echo "âœ… **Status: Tests Completed**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status: No test results found**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts Available:**" >> $GITHUB_STEP_SUMMARY
        echo "- Playwright HTML Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Coverage:**" >> $GITHUB_STEP_SUMMARY
        echo "- Pet Store API" >> $GITHUB_STEP_SUMMARY
        echo "- Postman Echo API" >> $GITHUB_STEP_SUMMARY
        echo "- DummyJSON API" >> $GITHUB_STEP_SUMMARY

  # Job 2: Lightweight performance check (NO DOCKER)
  quick-performance-check:
    runs-on: ubuntu-latest
    needs: playwright-tests  # Run after functional tests
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup k6 (Native - NO DOCKER)
      uses: grafana/setup-k6-action@v1

    - name: ðŸ§ª Run quick smoke test
      run: |
        echo "// Quick Smoke Test" > quick-test.js
        echo "import http from 'k6/http';" >> quick-test.js
        echo "import { check } from 'k6';" >> quick-test.js
        echo "export const options = { vus: 1, duration: '10s' };" >> quick-test.js
        echo "export default function() {" >> quick-test.js
        echo "  const res = http.get('https://dummyjson.com/products/1');" >> quick-test.js
        echo "  check(res, { 'status is 200': (r) => r.status === 200 });" >> quick-test.js
        echo "}" >> quick-test.js
        
        echo "Running quick API health check..."
        k6 run quick-test.js --summary-export=quick-test-results.json

    - name: ðŸ“Š Performance Metrics
      if: always()
      run: |
        echo "## âš¡ Quick Performance Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "quick-test-results.json" ]; then
          echo "âœ… **Status: Performance check completed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract simple metrics
          REQUESTS=$(jq -r '.metrics.http_reqs.value' quick-test-results.json 2>/dev/null || echo "N/A")
          AVG_TIME=$(jq -r '.metrics.http_req_duration.avg' quick-test-results.json 2>/dev/null || echo "N/A")
          SUCCESS_RATE=$(jq -r '.metrics.http_req_failed.rate' quick-test-results.json 2>/dev/null || echo "N/A")
          
          echo "**Quick Metrics:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total Requests: $REQUESTS" >> $GITHUB_STEP_SUMMARY
          echo "- Average Response Time: ${AVG_TIME}ms" >> $GITHUB_STEP_SUMMARY
          echo "- Error Rate: ${SUCCESS_RATE}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status: No performance results available**" >> $GITHUB_STEP_SUMMARY
        fi
