name: API CI

on:
  workflow_dispatch:  # Only manual trigger

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üé≠ Install Playwright browsers
      run: npx playwright install chromium

    - name: üîß Setup API environment
      run: |
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: üß™ Run Playwright API tests
      run: |
        echo "Running API tests..."
        npx playwright test --reporter=html,line 2>&1 | tee test-output.log
        
        # Save exit code
        TEST_EXIT_CODE=$?
        echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV

    - name: üìä Generate Clean Test Report
      if: always()
      run: |
        echo "## üß™ API Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "*Generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall Status
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "‚úÖ **All API Tests PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **Some API Tests FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Test metrics
        TOTAL_TESTS=$(grep -o "[0-9]\+ tests" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
        PASSED_TESTS=$(grep -o "[0-9]\+ passed" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
        FAILED_TESTS=$(grep -o "[0-9]\+ failed" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
        PASS_RATE=$((PASSED_TESTS * 100 / (TOTAL_TESTS==0?1:TOTAL_TESTS)))

        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| Failed | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
        echo "| Success Rate | $PASS_RATE% |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Plain English Summary
        if [ "$FAILED_TESTS" -eq 0 ]; then
          echo "üéØ **Summary:** All APIs are working correctly. Ready for deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **Summary:** $FAILED_TESTS out of $TOTAL_TESTS APIs failed. Investigate before deployment." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Tested APIs table
        echo "### üåê Tested APIs" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Pet Store | $(grep -qi petstore test-output.log && echo "‚úÖ Tested" || echo "‚è∏Ô∏è Not run") |" >> $GITHUB_STEP_SUMMARY
        echo "| Postman Echo | $(grep -qi postman test-output.log && echo "‚úÖ Tested" || echo "‚è∏Ô∏è Not run") |" >> $GITHUB_STEP_SUMMARY
        echo "| DummyJSON | $(grep -qi dummyjson test-output.log && echo "‚úÖ Tested" || echo "‚è∏Ô∏è Not run") |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Optional performance metrics
        AVG_RESPONSE=$(grep -o "avg=[0-9]\+[\.]*[0-9]*ms" test-output.log | head -1 | cut -d= -f2 || echo "")
        if [ -n "$AVG_RESPONSE" ]; then
          echo "### ‚ö° API Speed" >> $GITHUB_STEP_SUMMARY
          echo "- Average response: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Failed Test Details (collapsible)
        if [ "$FAILED_TESTS" -gt 0 ]; then
          echo "### ‚ùå Failed Test Details" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to view</summary>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A2 "Error:" test-output.log | head -20 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "See detailed logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Technical logs (collapsible)
        echo "### üìã Technical Details" >> $GITHUB_STEP_SUMMARY
        echo "<details><summary>Click for complete logs</summary>" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        tail -80 test-output.log >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "</details>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üìÅ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-results
        path: |
          playwright-report/
          test-results/
          test-output.log
        retention-days: 7

    - name: üö® Fail if tests failed
      if: failure()
      run: |
        echo "‚ùå API tests failed. Check the test output above."
        exit 1
