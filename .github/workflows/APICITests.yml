name: API CI

on:
  workflow_dispatch:  # Only manual trigger

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üé≠ Install Playwright browsers
      run: npx playwright install chromium

    - name: üîß Setup API environment
      run: |
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: üß™ Run Playwright API tests
      run: |
        echo "Running API tests..."
        npx playwright test --reporter=html,line 2>&1 | tee test-output.log
        
        # Save exit code
        TEST_EXIT_CODE=$?
        echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV

    - name: üìä Generate Enhanced Test Report
      if: always()
      run: |
        echo "## üìã API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üïê Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**üåê Environment:** GitHub Actions | Ubuntu Latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall Status
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "### ‚úÖ ALL TESTS PASSED" >> $GITHUB_STEP_SUMMARY
          echo '<div align="center">' >> $GITHUB_STEP_SUMMARY
          echo '<img src="https://img.shields.io/badge/Status-PASSING-brightgreen" alt="PASSING">' >> $GITHUB_STEP_SUMMARY
          echo '<img src="https://img.shields.io/badge/Tests-100%25-success" alt="100%">' >> $GITHUB_STEP_SUMMARY
          echo '</div>' >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå TESTS FAILED" >> $GITHUB_STEP_SUMMARY
          echo '<div align="center">' >> $GITHUB_STEP_SUMMARY
          echo '<img src="https://img.shields.io/badge/Status-FAILING-red" alt="FAILING">' >> $GITHUB_STEP_SUMMARY
          echo '<img src="https://img.shields.io/badge/Check_Logs-Required-orange" alt="Check Logs">' >> $GITHUB_STEP_SUMMARY
          echo '</div>' >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Extract and format metrics from test output
        if [ -f "test-output.log" ]; then
          echo "### üìà Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics using grep
          TOTAL_TESTS=$(grep -o "[0-9]\+ tests" test-output.log | head -1 | grep -o "[0-9]\+" || echo "N/A")
          PASSED_TESTS=$(grep -o "[0-9]\+ passed" test-output.log | head -1 | grep -o "[0-9]\+" || echo "N/A")
          FAILED_TESTS=$(grep -o "[0-9]\+ failed" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
          SKIPPED_TESTS=$(grep -o "[0-9]\+ skipped" test-output.log | head -1 | grep -o "[0-9]\+" || echo "0")
          DURATION=$(grep -o "[0-9]\+[\.][0-9]\+s" test-output.log | tail -1 || echo "N/A")
          
          echo "#### üìä Test Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Total Tests:    ${TOTAL_TESTS:-N/A}" >> $GITHUB_STEP_SUMMARY
          echo "Passed:         ${PASSED_TESTS:-N/A}" >> $GITHUB_STEP_SUMMARY
          echo "Failed:         ${FAILED_TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "Skipped:        ${SKIPPED_TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "Duration:       ${DURATION:-N/A}" >> $GITHUB_STEP_SUMMARY
          
          # Calculate pass percentage
          if [ "$TOTAL_TESTS" != "N/A" ] && [ "$TOTAL_TESTS" -gt 0 ]; then
            PASS_PERCENT=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            echo "Pass Rate:      ${PASS_PERCENT}%" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # API Endpoints Tested
          echo "#### üåê APIs Tested" >> $GITHUB_STEP_SUMMARY
          echo '| API Service | Base URL | Status |' >> $GITHUB_STEP_SUMMARY
          echo '|-------------|----------|--------|' >> $GITHUB_STEP_SUMMARY
          echo '| Pet Store | https://petstore.swagger.io/v2 | ‚úÖ |' >> $GITHUB_STEP_SUMMARY
          echo '| Postman Echo | https://postman-echo.com | ‚úÖ |' >> $GITHUB_STEP_SUMMARY
          echo '| DummyJSON | https://dummyjson.com | ‚úÖ |' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Response Time Metrics (if available in output)
          AVG_RESPONSE=$(grep -o "avg=[0-9]\+[\.]*[0-9]*ms" test-output.log | head -1 | cut -d= -f2 || echo "")
          P95_RESPONSE=$(grep -o "p(95)=[0-9]\+[\.]*[0-9]*ms" test-output.log | head -1 | cut -d= -f2 || echo "")
          P99_RESPONSE=$(grep -o "p(99)=[0-9]\+[\.]*[0-9]*ms" test-output.log | head -1 | cut -d= -f2 || echo "")
          
          if [ -n "$AVG_RESPONSE" ] || [ -n "$P95_RESPONSE" ]; then
            echo "#### ‚ö° Response Time Analysis" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            if [ -n "$AVG_RESPONSE" ]; then echo "Average:    $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY; fi
            if [ -n "$P95_RESPONSE" ]; then echo "95th %ile:  $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY; fi
            if [ -n "$P99_RESPONSE" ]; then echo "99th %ile:  $P99_RESPONSE" >> $GITHUB_STEP_SUMMARY; fi
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Success Rate
          SUCCESS_RATE=$(grep -o "rate=[0-9]\+[\.]*[0-9]*%" test-output.log | head -1 | cut -d= -f2 || echo "")
          if [ -n "$SUCCESS_RATE" ]; then
            echo "#### üéØ Success Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test Cases (extract individual test results)
          echo "#### ‚úÖ Individual Test Results" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view detailed test results</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Extract test lines with ‚úì or ‚úó
          grep -E "(‚úì|‚úó) .*" test-output.log | head -30 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No individual test results found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Raw Output
          echo "#### üìÑ Full Test Output" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view complete test output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 test-output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Next Steps
        echo "### üöÄ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${TEST_EXIT_CODE}" = "0" ]; then
          echo "1. ‚úÖ All API tests passed successfully" >> $GITHUB_STEP_SUMMARY
          echo "2. üìÅ Download the HTML report from artifacts for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. üöÄ Ready for deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. ‚ùå Review failed tests in the output above" >> $GITHUB_STEP_SUMMARY
          echo "2. üîç Check the Playwright HTML report for detailed failure information" >> $GITHUB_STEP_SUMMARY
          echo "3. üêõ Fix the failing test cases" >> $GITHUB_STEP_SUMMARY
          echo "4. üîÑ Re-run tests after fixes" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY

    - name: üìÅ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-results
        path: |
          playwright-report/
          test-results/
          test-output.log
        retention-days: 7

    - name: üö® Fail if tests failed
      if: failure()
      run: |
        echo "‚ùå API tests failed. Check the test output above."
        exit 1
