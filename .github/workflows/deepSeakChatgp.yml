name: deepSeakChatgpt result

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    # ----------------------------------------------------
    # Setup k6 NATIVELY (NO DOCKER)
    # ----------------------------------------------------
    - name: Setup k6
      uses: grafana/setup-k6-action@v1

    # ----------------------------------------------------
    # Decide which tests to run
    # ----------------------------------------------------
    - name: Determine which tests to run
      run: |
        TEST_TYPE="${{ github.event.inputs.test_type }}"

        if [ "$TEST_TYPE" = "smoke" ]; then
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "load" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=false" >> $GITHUB_ENV
        elif [ "$TEST_TYPE" = "spike" ]; then
          echo "RUN_SMOKE=false" >> $GITHUB_ENV
          echo "RUN_LOAD=false" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        else
          echo "RUN_SMOKE=true" >> $GITHUB_ENV
          echo "RUN_LOAD=true" >> $GITHUB_ENV
          echo "RUN_SPIKE=true" >> $GITHUB_ENV
        fi

    # ----------------------------------------------------
    # Run selected tests with NATIVE k6 (NO DOCKER)
    # ----------------------------------------------------
    - name: Run Selected Performance Tests
      run: |
        declare -A TESTS=(
          ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
          ["load"]="tests/performance/load/dummyjson-load.js"
          ["spike"]="tests/performance/spike/dummyjson-spike.js"
        )

        for TEST in smoke load spike; do
          RUN_VAR="RUN_${TEST^^}"
          if [ "${!RUN_VAR}" = "true" ]; then
            echo "ðŸš€ Running ${TEST^} test..."
            echo "Test file: ${TESTS[$TEST]}"
            
            if [ ! -f "${TESTS[$TEST]}" ]; then
              echo "âŒ Error: File ${TESTS[$TEST]} not found!"
              find tests -name "*.js" -type f | head -20
              continue
            fi
            
            # Run k6 with JSON output
            k6 run "${TESTS[$TEST]}" \
              --out json="k6-${TEST}-results.json" \
              2>&1 | tee "k6-${TEST}-output.txt"
            
            if [ $? -eq 0 ]; then
              echo "âœ… ${TEST^} test completed successfully"
            else
              echo "âŒ ${TEST^} test failed"
            fi
          fi
        done

    # ----------------------------------------------------
    # Generate GitHub Step Summary with Graphs & Metrics
    # ----------------------------------------------------
    - name: Create Performance Report
      run: |
        echo "## ðŸ§ª K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
        echo "*Generated at: $(date)*" >> $GITHUB_STEP_SUMMARY
        echo "*Selected test type: ${{ github.event.inputs.test_type }}*" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        render_test () {
          NAME=$1
          TITLE=$2
          MAX_VUS=$3
          LINE=$4
          OUTPUT_FILE="k6-${NAME}-output.txt"

          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "### ðŸš¦ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Test not run or output file missing" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            return
          fi

          echo "### ðŸš¦ ${TITLE} Test" >> $GITHUB_STEP_SUMMARY

          # -------- STATUS --------
          if tail -5 "$OUTPUT_FILE" | grep -q "thresholds on metrics.*have been crossed"; then
            echo "âš ï¸ **Status: THRESHOLD VIOLATIONS DETECTED**" >> $GITHUB_STEP_SUMMARY
          elif tail -5 "$OUTPUT_FILE" | grep -q "execution: local"; then
            echo "âœ… **Status: COMPLETED SUCCESSFULLY**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â“ **Status: UNKNOWN**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # -------- GRAPH --------
          echo "#### ðŸ“ˆ Load Pattern" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
          echo "    title \"${TITLE} Test Load Pattern\"" >> $GITHUB_STEP_SUMMARY
          echo '    x-axis "Time (minutes)"' >> $GITHUB_STEP_SUMMARY
          echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
          echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # -------- KEY METRICS --------
          echo "#### ðŸ“Š Key Performance Indicators" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ITERATIONS=$(grep "iterations.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "N/A")
          HTTP_REQS=$(grep "http_reqs.*:" "$OUTPUT_FILE" | tail -1 | awk '{print $2}' | tr -d ',' || echo "N/A")
          AVG_RESPONSE=$(grep "http_req_duration.*avg=" "$OUTPUT_FILE" | tail -1 | sed 's/.*avg=//' | awk '{print $1}' || echo "N/A")
          P95_RESPONSE=$(grep "http_req_duration.*p\\(95\\)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(95)=//' | awk '{print $1}' || echo "N/A")
          P99_RESPONSE=$(grep "http_req_duration.*p\\(99\\)=" "$OUTPUT_FILE" | tail -1 | sed 's/.*p(99)=//' | awk '{print $1}' || echo "N/A")
          FAILED_RATE=$(grep "http_req_failed.*rate=" "$OUTPUT_FILE" | tail -1 | sed 's/.*rate=//' | awk '{print $1}' || echo "N/A")
          SUCCESS_RATE=$(grep "checks_succeeded" "$OUTPUT_FILE" | awk '{print $2}' | tr -d ',' || echo "N/A")

          echo "Total Iterations: $ITERATIONS" >> $GITHUB_STEP_SUMMARY
          echo "Total Requests: $HTTP_REQS" >> $GITHUB_STEP_SUMMARY
          echo "Avg Response Time: $AVG_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "p95 Response Time: $P95_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "p99 Response Time: $P99_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "Failure Rate: $FAILED_RATE" >> $GITHUB_STEP_SUMMARY
          echo "Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # -------- RAW OUTPUT --------
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view full ${TITLE} Test output</summary>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -80 "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
        }

        [ "${RUN_SMOKE}" = "true" ] && render_test "smoke" "Smoke" 5 "[1,3,5,0]"
        [ "${RUN_LOAD}" = "true" ] && render_test "load" "Load" 120 "[10,30,80,120,60,20]"
        [ "${RUN_SPIKE}" = "true" ] && render_test "spike" "Spike" 400 "[5,50,200,400,200,50,10]"

        # -------- FINAL SUMMARY --------
        echo "### ðŸ“ Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Tests run: **${{ github.event.inputs.test_type }}**" >> $GITHUB_STEP_SUMMARY
        echo "- Review threshold violations" >> $GITHUB_STEP_SUMMARY
        echo "- Check latency metrics (avg/p95/p99)" >> $GITHUB_STEP_SUMMARY
        echo "- Verify success rates meet requirements" >> $GITHUB_STEP_SUMMARY
