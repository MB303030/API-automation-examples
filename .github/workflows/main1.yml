name: API CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  functional-tests:
    runs-on: ubuntu-latest
    name: Functional Tests
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright
      run: npx playwright install chromium

    - name: ðŸ”§ Setup API environment variables
      run: |
        echo "API_KEY=test-key-${{ github.run_id }}" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://template.postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: ðŸ§ª Run Playwright API tests
      run: npx playwright test

    - name: ðŸ“¤ Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  performance-tests:
    runs-on: ubuntu-latest
    name: Performance Tests
    # CHANGED: Always run for now
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Docker and K6 Setup Check
      id: setup
      run: |
        echo "ðŸ” Checking Docker installation..."
        docker --version
        echo "âœ… Docker is available"
        
        echo "ðŸ” Checking if K6 tests exist..."
        if [ ! -f "tests/performance/smoke/dummyjson-smoke.js" ]; then
          echo "âŒ K6 test file not found"
          echo "k6_test_found=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… K6 test file found"
          echo "k6_test_found=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸš€ Run K6 Smoke Test
      if: steps.setup.outputs.k6_test_found == 'true'
      run: |
        echo "ðŸš€ Running K6 smoke test..."
        docker run --rm -i grafana/k6 run - < tests/performance/smoke/dummyjson-smoke.js
        
    - name: ðŸ“Š Generate K6 Report
      if: always()
      run: |
        echo "## ðŸ“ˆ K6 Performance Tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.setup.outputs.k6_test_found }}" = "true" ]; then
          echo "âœ… K6 test file exists" >> $GITHUB_STEP_SUMMARY
          echo "Test: \`tests/performance/smoke/dummyjson-smoke.js\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run output appears above in the job logs." >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No K6 test file found" >> $GITHUB_STEP_SUMMARY
          echo "Create: \`tests/performance/smoke/dummyjson-smoke.js\`" >> $GITHUB_STEP_SUMMARY
        fi
