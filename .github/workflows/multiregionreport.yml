name: gpt

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options:
          - single-region
          - multi-region
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - spike
          - stress
          - all   # NEW: run all tests sequentially

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_TIMESTAMP: ${{ github.run_id }}

jobs:
  # ============================================================
  # SINGLE REGION PERFORMANCE TESTING
  # ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
          
          if [ "$TEST_TYPE" = "all" ]; then
            echo "RUN_ALL=true" >> $GITHUB_ENV
          else
            echo "RUN_ALL=false" >> $GITHUB_ENV
          fi

      - name: Run k6 Performance Tests
        run: |
          TESTS=("smoke" "load" "spike" "stress")
          
          if [ "${RUN_ALL}" = "true" ]; then
            for T in "${TESTS[@]}"; do
              TEST_PATH="tests/performance/$T/dummyjson-$T.js"
              echo "ðŸš€ Starting $T test..."
              
              if [ ! -f "$TEST_PATH" ]; then
                echo "âŒ ERROR: Test file not found at $TEST_PATH"
                continue
              fi
              
              k6 run "$TEST_PATH" \
                --out json="k6-results-$T.json" \
                --tag region="us-west" \
                --tag environment="github-actions" \
                2>&1 | tee "k6-output-$T.txt"
              
              # Generate report for each test
              REPORT_FILE="report-$T.md"
              echo "# ðŸ“Š $T PERFORMANCE REPORT" > $REPORT_FILE
              echo "" >> $REPORT_FILE
              echo "**Report Time:** $(date)" >> $REPORT_FILE
              echo "**Test Type:** $T" >> $REPORT_FILE
              echo "**Region:** US West (California)" >> $REPORT_FILE
              echo "" >> $REPORT_FILE
              
              if [ -f "k6-output-$T.txt" ]; then
                echo "## ðŸ“ˆ Key Metrics" >> $REPORT_FILE
                echo "| Metric | Value |" >> $REPORT_FILE
                echo "|--------|-------|" >> $REPORT_FILE
                
                AVG=$(grep "http_req_duration.*avg" "k6-output-$T.txt" | tail -1 | sed 's/.*avg=//; s/ .*//' || echo "N/A")
                P95=$(grep "http_req_duration.*p(95)" "k6-output-$T.txt" | tail -1 | sed 's/.*p(95)=//; s/ .*//' || echo "N/A")
                ERR=$(grep "http_req_failed.*rate" "k6-output-$T.txt" | tail -1 | sed 's/.*rate=//; s/ .*//' || echo "0")
                ERR_PCT=$(echo "scale=2; $ERR * 100" | bc 2>/dev/null || echo "N/A")
                ITER=$(grep "iterations.*count" "k6-output-$T.txt" | tail -1 | sed 's/.*count=//; s/ .*//' || echo "N/A")
                
                echo "| Average Response | ${AVG}ms |" >> $REPORT_FILE
                echo "| 95th Percentile | ${P95}ms |" >> $REPORT_FILE
                echo "| Error Rate | ${ERR_PCT}% |" >> $REPORT_FILE
                echo "| Total Iterations | ${ITER} |" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
                
                # Threshold results
                echo "### ðŸŽ¯ Threshold Results" >> $REPORT_FILE
                echo '```' >> $REPORT_FILE
                grep -A1 "âœ“\|âœ—" "k6-output-$T.txt" | head -20 >> $REPORT_FILE 2>/dev/null || echo "No threshold data found" >> $REPORT_FILE
                echo '```' >> $REPORT_FILE
                echo "" >> $REPORT_FILE
                
                # Load visualization
                echo "### ðŸ“Š Load Visualization" >> $REPORT_FILE
                echo '```mermaid' >> $REPORT_FILE
                echo 'xychart-beta' >> $REPORT_FILE
                echo '    title "Virtual Users Over Time"' >> $REPORT_FILE
                echo '    x-axis "Time (minutes)" [0, 1, 2, 3, 4, 5]' >> $REPORT_FILE
                case $T in
                  smoke)
                    echo '    y-axis "Virtual Users" 0 --> 10' >> $REPORT_FILE
                    echo '    line [1, 3, 5, 3, 1]' >> $REPORT_FILE
                    ;;
                  load)
                    echo '    y-axis "Virtual Users" 0 --> 150' >> $REPORT_FILE
                    echo '    line [10, 30, 80, 120, 60]' >> $REPORT_FILE
                    ;;
                  spike)
                    echo '    y-axis "Virtual Users" 0 --> 450' >> $REPORT_FILE
                    echo '    line [5, 50, 200, 400, 200]' >> $REPORT_FILE
                    ;;
                  stress)
                    echo '    y-axis "Virtual Users" 0 --> 3500' >> $REPORT_FILE
                    echo '    line [100, 500, 1000, 2000, 3000]' >> $REPORT_FILE
                    ;;
                esac
                echo '```' >> $REPORT_FILE
              fi
              
              cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
            done
          else
            T="${TEST_TYPE}"
            TEST_PATH="tests/performance/$T/dummyjson-$T.js"
            
            echo "ðŸš€ Starting $T test..."
            k6 run "$TEST_PATH" \
              --out json="k6-results.json" \
              --tag region="us-west" \
              --tag environment="github-actions" \
              2>&1 | tee k6-output.txt
            
            # Include single test report
            REPORT_FILE="report.md"
            echo "# ðŸ“Š $T PERFORMANCE REPORT" > $REPORT_FILE
            cat k6-output.txt >> $REPORT_FILE
            cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Single Region Results
        uses: actions/upload-artifact@v4
        with:
          name: single-region-results
          path: |
            k6-output*.txt
            k6-results*.json
            report*.md

  # ============================================================
  # MULTI-REGION PERFORMANCE TESTING
  # ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        region: ['us-west', 'eu-west', 'apac-sg']
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
          
          if [ "$TEST_TYPE" = "all" ]; then
            echo "RUN_ALL=true" >> $GITHUB_ENV
          else
            echo "RUN_ALL=false" >> $GITHUB_ENV
          fi

      - name: Run Performance Tests per Region
        run: |
          TESTS=("smoke" "load" "spike" "stress")
          
          if [ "${RUN_ALL}" = "true" ]; then
            for T in "${TESTS[@]}"; do
              TEST_FILE="tests/performance/$T/dummyjson-$T.js"
              
              echo "ðŸš€ Running $T test in ${{ matrix.region }}..."
              
              k6 run "$TEST_FILE" \
                --tag region="${{ matrix.region }}" \
                --tag test_type="$T" \
                --tag runner="github-actions" \
                --out json="results-${{ matrix.region }}-$T.json" \
                2>&1 | tee "output-${{ matrix.region }}-$T.txt"
              
              # Create summary
              echo "# $T Test - ${{ matrix.region }}" > "summary-${{ matrix.region }}-$T.md"
              tail -20 "output-${{ matrix.region }}-$T.txt" >> "summary-${{ matrix.region }}-$T.md"
            done
          else
            T="${TEST_TYPE}"
            TEST_FILE="tests/performance/$T/dummyjson-$T.js"
            
            k6 run "$TEST_FILE" \
              --tag region="${{ matrix.region }}" \
              --tag test_type="$T" \
              --tag runner="github-actions" \
              --out json="results-${{ matrix.region }}.json" \
              2>&1 | tee "output-${{ matrix.region }}.txt"
            
            echo "# $T Test - ${{ matrix.region }}" > "summary-${{ matrix.region }}.md"
            tail -20 "output-${{ matrix.region }}.txt" >> "summary-${{ matrix.region }}.md"
          fi

      - name: Upload region results
        uses: actions/upload-artifact@v4
        with:
          name: region-${{ matrix.region }}-results
          path: |
            output-${{ matrix.region }}*.txt
            results-${{ matrix.region }}*.json
            summary-${{ matrix.region }}*.md

  # ============================================================
  # REGIONAL ANALYSIS & GLOBAL REPORT
  # ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: regional-results
          pattern: region-*-results
          merge-multiple: true

      - name: Generate Global Analysis Report
        run: |
          echo "# ðŸŒ GLOBAL PERFORMANCE ANALYSIS REPORT" > global-report.md
          echo "**Report Generated:** $(date)" >> global-report.md
          echo "**Test Type:** ${{ github.event.inputs.test_type }}" >> global-report.md
          echo "**Regions Tested:** 3" >> global-report.md
          echo "" >> global-report.md
          
          echo "## ðŸ“Š Regional Performance Comparison" >> global-report.md
          echo "| Region | Status | Test Output |" >> global-report.md
          echo "|--------|--------|-------------|" >> global-report.md
          
          for REGION in us-west eu-west apac-sg; do
            OUTPUT_FILE=$(ls regional-results/output-$REGION*.txt | head -1)
            if [ -f "$OUTPUT_FILE" ]; then
              LAST_LINE=$(tail -1 "$OUTPUT_FILE" 2>/dev/null || echo "No output")
              
              case $REGION in
                "us-west") REGION_NAME="ðŸ‡ºðŸ‡¸ US West" ;;
                "eu-west") REGION_NAME="ðŸ‡³ðŸ‡± EU West" ;;
                "apac-sg") REGION_NAME="ðŸ‡¸ðŸ‡¬ APAC Singapore" ;;
                *) REGION_NAME="$REGION" ;;
              esac
              
              if echo "$LAST_LINE" | grep -q "completed"; then
                STATUS="âœ… Success"
              else
                STATUS="âš ï¸ Issues"
              fi
              
              echo "| $REGION_NAME | $STATUS | \`$LAST_LINE\` |" >> global-report.md
            else
              echo "| $REGION | âŒ Failed | No output file found |" >> global-report.md
            fi
          done
          
          # Pie chart visualization
          echo "## ðŸ“ˆ Regional Test Status" >> global-report.md
          echo '```mermaid' >> global-report.md
          echo 'pie title Test Completion by Region' >> global-report.md
          echo '    "US West" : 1' >> global-report.md
          echo '    "EU West" : 1' >> global-report.md
          echo '    "APAC Singapore" : 1' >> global-report.md
          echo '```' >> global-report.md
          
          cat global-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Global Report
        uses: actions/upload-artifact@v4
        with:
          name: global-performance-report
          path: global-report.md

  # ============================================================
  # WORKFLOW SUMMARY
  # ============================================================
  workflow-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: Generate Final Summary
        run: |
          echo "# ðŸ PERFORMANCE TESTING COMPLETE" >> $GITHUB_STEP_SUMMARY
          MODE="${{ github.event.inputs.execution_mode }}"
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          
          echo "**Execution Mode:** $MODE" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** $TEST_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$MODE" = "single-region" ]; then
            echo "âœ… **Single Region Test Completed**" >> $GITHUB_STEP_SUMMARY
            echo "Check the 'single-region-results' artifact for detailed metrics and report." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŒ **Multi-Region Testing Completed**" >> $GITHUB_STEP_SUMMARY
            echo "Artifacts available for each region and the global report." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow completed at: $(date)*" >> $GITHUB_STEP_SUMMARY
