name: Multi regional report Performance 

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options:
          - single-region
          - multi-region
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike
          - stress

jobs:
  # ============================================================
  # SINGLE REGION PERFORMANCE TESTING (ORIGINAL WORKFLOW)
  # ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      # ----------------------------------------------------
      # Setup k6 NATIVELY (NO DOCKER)
      # ----------------------------------------------------
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # ----------------------------------------------------
      # Decide which tests to run
      # ----------------------------------------------------
      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"

          if [ "$TEST_TYPE" = "smoke" ]; then
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            echo "RUN_STRESS=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "load" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            echo "RUN_STRESS=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "spike" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
            echo "RUN_STRESS=false" >> $GITHUB_ENV
          elif [ "$TEST_TYPE" = "stress" ]; then
            echo "RUN_SMOKE=false" >> $GITHUB_ENV
            echo "RUN_LOAD=false" >> $GITHUB_ENV
            echo "RUN_SPIKE=false" >> $GITHUB_ENV
            echo "RUN_STRESS=true" >> $GITHUB_ENV
          else
            echo "RUN_SMOKE=true" >> $GITHUB_ENV
            echo "RUN_LOAD=true" >> $GITHUB_ENV
            echo "RUN_SPIKE=true" >> $GITHUB_ENV
            echo "RUN_STRESS=true" >> $GITHUB_ENV
          fi

      # ----------------------------------------------------
      # Run selected tests with NATIVE k6 (NO DOCKER)
      # ----------------------------------------------------
      - name: Run Selected Performance Tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
            ["stress"]="tests/performance/stress/dummyjson-stress.js"
          )

          for TEST in smoke load spike stress; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              echo "üöÄ Running ${TEST^} test..."
              echo "Test file: ${TESTS[$TEST]}"
              
              if [ ! -f "${TESTS[$TEST]}" ]; then
                echo "‚ùå Error: File ${TESTS[$TEST]} not found!"
                echo "Available files in tests/:"
                find tests -name "*.js" -type f | head -20
                continue
              fi
              
              k6 run "${TESTS[$TEST]}" \
                --out json="k6-${TEST}-results.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ ${TEST^} test completed successfully"
              else
                echo "‚ùå ${TEST^} test failed"
              fi
            fi
          done

      # ----------------------------------------------------
      # Report: GRAPH + REAL DATA + SMART ANALYSIS
      # ----------------------------------------------------
      - name: Create Single Region Performance Report
        run: |
          # Function to render each test WITH GRAPHS
          render_test() {
            NAME=$1
            TITLE=$2
            MAX_VUS=$3
            LINE=$4
            OUTPUT_FILE="k6-${NAME}-output.txt"
            
            if [ -f "$OUTPUT_FILE" ]; then
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## üöÄ ${TITLE} Test Analysis" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # üéØ GRAPH SECTION
              echo "### üìà Load Pattern Visualization" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**How we simulated real users:**" >> $GITHUB_STEP_SUMMARY
              echo '```mermaid' >> $GITHUB_STEP_SUMMARY
              echo 'xychart-beta' >> $GITHUB_STEP_SUMMARY
              echo "    title \"${TITLE} Test - Virtual Users Over Time\"" >> $GITHUB_STEP_SUMMARY
              
              # Different time scales based on test type
              if [ "$NAME" = "stress" ]; then
                echo '    x-axis "Time (minutes)" [0, 2, 4, 6, 8, 10]' >> $GITHUB_STEP_SUMMARY
              else
                echo '    x-axis "Time (minutes)" [0, 1, 2, 3, 4, 5, 6, 7]' >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "    y-axis \"Virtual Users\" 0 --> ${MAX_VUS}" >> $GITHUB_STEP_SUMMARY
              echo "    line ${LINE}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # üìä REAL TEST RESULTS SECTION
              echo "### üîç What Actually Happened During This Load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # 1. Get ALL threshold results
              THRESHOLD_COUNT=$(grep -c "‚úì\|‚úó" "$OUTPUT_FILE" 2>/dev/null || echo 0)
              
              if [ "$THRESHOLD_COUNT" -gt 0 ]; then
                echo "**üéØ Performance Targets (${THRESHOLD_COUNT} checked):**" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A1 "‚úì\|‚úó" "$OUTPUT_FILE" | head -20 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 2. CRITICAL METRICS TABLE
              echo "### üìä Critical Metrics Dashboard" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Result | Target | Status |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
              
              # User Experience Metric
              if grep -q "rate>0.85\|rate>0.7" "$OUTPUT_FILE"; then
                RATE_LINE=$(grep "rate>0.85\|rate>0.7" "$OUTPUT_FILE" | tail -1)
                ACTUAL_RATE=$(echo "$RATE_LINE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                if echo "$RATE_LINE" | grep -q "‚ùå"; then
                  echo "| üë• User Experience | ${ACTUAL_RATE}% | >85% | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| üë• User Experience | ${ACTUAL_RATE}% | >85% | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Error Rate Metric
              if grep -q "rate<0.10\|rate<0.3" "$OUTPUT_FILE"; then
                RATE_LINE=$(grep "rate<0.10\|rate<0.3" "$OUTPUT_FILE" | tail -1)
                ACTUAL_RATE=$(echo "$RATE_LINE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                if echo "$RATE_LINE" | grep -q "‚ùå"; then
                  echo "| üö® Error Rate | ${ACTUAL_RATE}% | <10% | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| üö® Error Rate | ${ACTUAL_RATE}% | <10% | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Response Time P95
              if grep -q "p(95)<2000\|p(95)<10000" "$OUTPUT_FILE"; then
                P95_LINE=$(grep "p(95)<2000\|p(95)<10000" "$OUTPUT_FILE" | tail -1)
                ACTUAL_P95=$(echo "$P95_LINE" | sed 's/.*p(95)=//; s/ms//' | tr -d ' ')
                if echo "$P95_LINE" | grep -q "‚ùå"; then
                  echo "| ‚ö° Response Time (P95) | ${ACTUAL_P95}ms | <2000ms | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| ‚ö° Response Time (P95) | ${ACTUAL_P95}ms | <2000ms | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Response Time P99
              if grep -q "p(99)<4000" "$OUTPUT_FILE"; then
                P99_LINE=$(grep "p(99)<4000" "$OUTPUT_FILE" | tail -1)
                ACTUAL_P99=$(echo "$P99_LINE" | sed 's/.*p(99)=//; s/ms//' | tr -d ' ')
                if echo "$P99_LINE" | grep -q "‚ùå"; then
                  echo "| üê¢ Response Time (P99) | ${ACTUAL_P99}ms | <4000ms | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| üê¢ Response Time (P99) | ${ACTUAL_P99}ms | <4000ms | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # Stress-specific: Failure Rate
              if [ "$NAME" = "stress" ]; then
                if grep -q "stress_failure_rate" "$OUTPUT_FILE"; then
                  FAIL_LINE=$(grep "'stress_failure_rate'" "$OUTPUT_FILE" | tail -1)
                  ACTUAL_FAIL=$(echo "$FAIL_LINE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                  if echo "$FAIL_LINE" | grep -q "‚ùå"; then
                    echo "| üí• Critical Failure Rate | ${ACTUAL_FAIL}% | <5% | üî¥ FAIL |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üí• Critical Failure Rate | ${ACTUAL_FAIL}% | <5% | ‚úÖ PASS |" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # 3. FUNCTIONAL CHECKS
              echo "### ‚úÖ Functional Checks During Load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Page Load Check
              if grep -q "page loaded" "$OUTPUT_FILE"; then
                PAGE_LINE=$(grep -A1 "page loaded" "$OUTPUT_FILE")
                echo "**üì± Page Load Success:**" >> $GITHUB_STEP_SUMMARY
                echo "$PAGE_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Product Load Check
              if grep -q "product loaded\|product has valid data" "$OUTPUT_FILE"; then
                PRODUCT_LINE=$(grep -A1 "product loaded\|product has valid data" "$OUTPUT_FILE")
                echo "**üõçÔ∏è Product Page Access:**" >> $GITHUB_STEP_SUMMARY
                echo "$PRODUCT_LINE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # 4. PLAIN ENGLISH ANALYSIS
              echo "### üß† Impact Analysis" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Stress-specific analysis
              if [ "$NAME" = "stress" ]; then
                if grep -q "‚ùå.*stress_failure_rate" "$OUTPUT_FILE"; then
                  RATE=$(grep "‚ùå.*stress_failure_rate" "$OUTPUT_FILE" | sed 's/.*rate=//; s/%//' | tr -d ' ')
                  echo "üí• **STRESS TEST FINDING - SYSTEM FAILURE:**" >> $GITHUB_STEP_SUMMARY
                  echo "- **The Problem:** ${RATE}% critical failures under extreme load" >> $GITHUB_STEP_SUMMARY
                  echo "- **What It Means:** System cannot handle ${MAX_VUS} concurrent users" >> $GITHUB_STEP_SUMMARY
                  echo "- **Business Impact:** Complete outage during traffic surges" >> $GITHUB_STEP_SUMMARY
                  echo "- **Breaking Point:** System failed around $((MAX_VUS * 2/3)) users" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                elif grep -q "‚úÖ.*stress_failure_rate" "$OUTPUT_FILE"; then
                  echo "‚úÖ **STRESS TEST FINDING - RESILIENT SYSTEM:**" >> $GITHUB_STEP_SUMMARY
                  echo "- **The Good News:** System handles ${MAX_VUS} users without critical failures" >> $GITHUB_STEP_SUMMARY
                  echo "- **What It Means:** Safety margin exists beyond normal peak load" >> $GITHUB_STEP_SUMMARY
                  echo "- **Business Impact:** Can survive unexpected traffic spikes" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              # 5. ACTIONABLE RECOMMENDATIONS
              echo "### üéØ Recommended Actions" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "$NAME" = "stress" ]; then
                if grep -q "‚ùå.*stress_failure_rate" "$OUTPUT_FILE"; then
                  echo "üö® **CRITICAL INFRASTRUCTURE ISSUE**" >> $GITHUB_STEP_SUMMARY
                  echo "1. **INVESTIGATE** database connection limits and API timeouts" >> $GITHUB_STEP_SUMMARY
                  echo "2. **SCALE HORIZONTALLY** - add more instances before breaking point" >> $GITHUB_STEP_SUMMARY
                  echo "3. **IMPLEMENT** rate limiting and graceful degradation" >> $GITHUB_STEP_SUMMARY
                  echo "4. **MONITOR** production for similar patterns" >> $GITHUB_STEP_SUMMARY
                elif grep -q "‚úÖ.*stress_failure_rate" "$OUTPUT_FILE"; then
                  echo "üèÜ **EXCELLENT RESILIENCE**" >> $GITHUB_STEP_SUMMARY
                  echo "1. **CONFIRM** infrastructure can handle 3x normal load" >> $GITHUB_STEP_SUMMARY
                  echo "2. **DOCUMENT** breaking point for capacity planning" >> $GITHUB_STEP_SUMMARY
                  echo "3. **CELEBRATE** robust system architecture" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          echo "# üìä K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üìÖ Report Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**üéØ Test Type:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**üåç Test Mode:** Single Region (US)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Quick summary table at the top
          echo "## üìã Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status | Peak Load | Key Finding |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${RUN_SMOKE}" = "true" ] && [ -f "k6-smoke-output.txt" ]; then
            if grep -q "‚úì" "k6-smoke-output.txt"; then STATUS="‚úÖ PASS"; else STATUS="‚ùå FAIL"; fi
            echo "| Smoke | $STATUS | 5 users | Basic functionality check |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${RUN_LOAD}" = "true" ] && [ -f "k6-load-output.txt" ]; then
            if grep -q "‚úì" "k6-load-output.txt"; then STATUS="‚úÖ PASS"; else STATUS="‚ùå FAIL"; fi
            echo "| Load | $STATUS | 120 users | Sustained performance |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${RUN_SPIKE}" = "true" ] && [ -f "k6-spike-output.txt" ]; then
            if grep -q "‚ùå 'rate<0.10'" "k6-spike-output.txt"; then
              STATUS="üî¥ CRITICAL"
              RATE=$(grep "‚ùå 'rate<0.10'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              FINDING="${RATE}% error rate"
            elif grep -q "‚ùå 'rate>0.85'" "k6-spike-output.txt"; then
              STATUS="üü° WARNING"
              RATE=$(grep "‚ùå 'rate>0.85'" "k6-spike-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              FINDING="${RATE}% good UX"
            else
              STATUS="‚úÖ PASS"
              FINDING="All targets met"
            fi
            echo "| Spike | $STATUS | 400 users | $FINDING |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${RUN_STRESS}" = "true" ] && [ -f "k6-stress-output.txt" ]; then
            if grep -q "‚ùå.*stress_failure_rate" "k6-stress-output.txt"; then
              STATUS="üî• BREAKING"
              RATE=$(grep "‚ùå.*stress_failure_rate" "k6-stress-output.txt" | sed 's/.*rate=//; s/%//' | tr -d ' ')
              FINDING="Breaking point at ${RATE}% failures"
            elif grep -q "‚úÖ.*stress_failure_rate" "k6-stress-output.txt"; then
              STATUS="‚úÖ RESILIENT"
              FINDING="Handles extreme load"
            else
              STATUS="‚ö†Ô∏è INCONCLUSIVE"
              FINDING="No stress metric found"
            fi
            echo "| Stress | $STATUS | 3000 users | $FINDING |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Render detailed test reports
          if [ "${RUN_SMOKE}" = "true" ]; then
            render_test "smoke" "Smoke" 5 "[1, 3, 5, 0]"
          fi
          
          if [ "${RUN_LOAD}" = "true" ]; then
            render_test "load" "Load" 120 "[10, 30, 80, 120, 60, 20]"
          fi
          
          if [ "${RUN_SPIKE}" = "true" ]; then
            render_test "spike" "Spike" 400 "[5, 50, 200, 400, 200, 50, 10]"
          fi
          
          if [ "${RUN_STRESS}" = "true" ]; then
            render_test "stress" "Stress" 3000 "[100, 500, 1000, 2000, 3000, 100, 0]"
          fi
          
          # üèÜ FINAL DECISION WITH GRAPH CONTEXT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# üèÜ Deployment Decision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Use stress test results for final decision if available
          if [ -f "k6-stress-output.txt" ]; then
            echo "## üìà Based on Stress Test Results (3000 Users):" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Visual decision helper
            echo "### üìä Decision Matrix - Stress Test" >> $GITHUB_STEP_SUMMARY
            echo '```mermaid' >> $GITHUB_STEP_SUMMARY
            echo 'quadrantChart' >> $GITHUB_STEP_SUMMARY
            echo '    title "System Resilience Under Extreme Load"' >> $GITHUB_STEP_SUMMARY
            echo '    x-axis "Graceful Degradation" --> "Catastrophic Failure"' >> $GITHUB_STEP_SUMMARY
            echo '    y-axis "Low Impact" --> "High Impact"' >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå.*stress_failure_rate" "k6-stress-output.txt"; then
              echo '    quadrant-1 "Do Not Deploy"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-2 "Investigate Urgently"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-3 "Monitor"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-4 "Critical Fix Required"' >> $GITHUB_STEP_SUMMARY
              echo '    "Current System": [0.8, 0.9]' >> $GITHUB_STEP_SUMMARY
              echo "    Our stress test shows **critical failures** at 3x normal load - system breaks catastrophically" >> $GITHUB_STEP_SUMMARY
            elif grep -q "‚úÖ.*stress_failure_rate" "k6-stress-output.txt"; then
              echo '    quadrant-1 "Ready for High Traffic"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-2 "Proceed with Confidence"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-3 "Do Not Deploy"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-4 "Investigate"' >> $GITHUB_STEP_SUMMARY
              echo '    "Current System": [0.2, 0.3]' >> $GITHUB_STEP_SUMMARY
              echo "    Our stress test shows **excellent resilience** at 3x normal load" >> $GITHUB_STEP_SUMMARY
            else
              echo '    quadrant-1 "Proceed with Caution"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-2 "Do Not Deploy"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-3 "Monitor"' >> $GITHUB_STEP_SUMMARY
              echo '    quadrant-4 "Investigate"' >> $GITHUB_STEP_SUMMARY
              echo '    "Current System": [0.5, 0.6]' >> $GITHUB_STEP_SUMMARY
              echo "    Our stress test shows **mixed results** at extreme load" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Final verdict based on stress test
            echo "### ‚öñÔ∏è Final Verdict (Stress Test)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå.*stress_failure_rate" "k6-stress-output.txt"; then
              echo "üî¥ **DO NOT DEPLOY - SYSTEM BREAKS UNDER PRESSURE**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** System fails catastrophically at 3x normal load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'Under extreme conditions (3000+ users), the system breaks completely. We need architectural improvements before launch.'" >> $GITHUB_STEP_SUMMARY
              
            elif grep -q "‚úÖ.*stress_failure_rate" "k6-stress-output.txt"; then
              echo "üü¢ **READY FOR DEPLOYMENT - RESILIENT SYSTEM**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** System handles 3x normal load without critical failures" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'Even under extreme load (3000 users), the system remains stable. We have a good safety margin for unexpected traffic.'" >> $GITHUB_STEP_SUMMARY
              
            else
              echo "üü° **DEPLOY WITH MONITORING**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** Stress test results inconclusive" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'System handles normal load well but needs monitoring during extreme events.'" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ -f "k6-spike-output.txt" ]; then
            # Fallback to spike test for decision if no stress test
            echo "## üìà Based on Spike Test Results (400 Users):" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ‚öñÔ∏è Final Verdict (Spike Test)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "‚ùå 'rate<0.10' rate=90.49%" "k6-spike-output.txt"; then
              echo "üî¥ **DO NOT DEPLOY**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** 90% error rate at 400 user load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'The website crashes when 400+ users visit. We need to fix this before any launch.'" >> $GITHUB_STEP_SUMMARY
              
            elif grep -q "‚ùå 'rate>0.85' rate=34.19%" "k6-spike-output.txt"; then
              echo "üü° **DEPLOY WITH CAUTION**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** Poor user experience (34%) at 400 users" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'The website works but gets slow for many users during busy times. We should improve this soon.'" >> $GITHUB_STEP_SUMMARY
              
            else
              echo "üü¢ **READY FOR DEPLOYMENT**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Reason:** All performance targets met at 400 user load" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tell stakeholders:** 'Performance tests show the website handles busy periods well. We're ready to launch.'" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report includes: üìà Load graphs + üìä Real metrics + üß† Smart analysis*" >> $GITHUB_STEP_SUMMARY

      # ----------------------------------------------------
      # Upload Single Region Artifacts
      # ----------------------------------------------------
      - name: Upload Single Region Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: single-region-results
          path: |
            k6-*-output.txt
            k6-*-results.json
          retention-days: 30

  # ============================================================
  # MULTI-REGION PERFORMANCE TESTING
  # ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    defaults:
      run:
        shell: bash

    strategy:
      matrix:
        runner: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - runner: ubuntu-latest
            region_label: "US West (California)"
            region_id: us-west
            region_emoji: "üá∫üá∏"
            region_coords: "[-119.4179, 36.7783]"
          - runner: windows-latest
            region_label: "EU West (Netherlands)"
            region_id: eu-west
            region_emoji: "üá≥üá±"
            region_coords: "[5.2913, 52.1326]"
          - runner: macos-latest
            region_label: "Asia Pacific (Singapore)"
            region_id: apac-sg
            region_emoji: "üá∏üá¨"
            region_coords: "[103.8198, 1.3521]"

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine test path
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
          
          if [ "$TEST_TYPE" = "all" ]; then
            echo "SPECIFIC_TEST=load" >> $GITHUB_ENV  # Default to load test for multi-region
            echo "NOTE=Running load test as representative for multi-region comparison" >> $GITHUB_ENV
          else
            echo "SPECIFIC_TEST=$TEST_TYPE" >> $GITHUB_ENV
            echo "NOTE=Running $TEST_TYPE test across regions" >> $GITHUB_ENV
          fi

      - name: Run ${{ env.SPECIFIC_TEST }} test from ${{ matrix.region_label }}
        run: |
          TEST_PATH="tests/performance/${{ env.SPECIFIC_TEST }}/dummyjson-${{ env.SPECIFIC_TEST }}.js"
          
          echo "${{ matrix.region_emoji }} üìç Region: ${{ matrix.region_label }}"
          echo "üìÅ Test: ${{ env.SPECIFIC_TEST }}"
          echo "üìÑ Path: $TEST_PATH"
          echo "üïê Start Time: $(date)"
          
          if [ ! -f "$TEST_PATH" ]; then
            echo "‚ùå Error: Test file not found at $TEST_PATH"
            echo "Available tests:"
            find tests/performance -name "*.js" -type f
            exit 1
          fi
          
          echo "üöÄ Starting test in ${{ matrix.region_label }}..."
          
          # Run k6 with regional tagging
          k6 run "$TEST_PATH" \
            --tag region="${{ matrix.region_id }}" \
            --tag region_name="${{ matrix.region_label }}" \
            --tag runner="${{ matrix.runner }}" \
            --tag test_type="${{ env.SPECIFIC_TEST }}" \
            --out json="results-${{ matrix.region_id }}.json" \
            --summary-export="summary-${{ matrix.region_id }}.json" \
            2>&1 | tee "output-${{ matrix.region_id }}.txt"
          
          echo "‚úÖ Test completed in ${{ matrix.region_label }}"
          echo "üïê End Time: $(date)"

      - name: Extract key metrics for reporting
        run: |
          OUTPUT_FILE="output-${{ matrix.region_id }}.txt"
          echo "üìä Extracting metrics from test output..."
          
          # Extract key metrics using grep
          AVG_RESPONSE=$(grep -oP 'http_req_duration.*avg=\K[0-9.]+' "$OUTPUT_FILE" 2>/dev/null || echo "0")
          P95_RESPONSE=$(grep -oP 'http_req_duration.*p\(95\)=\K[0-9.]+' "$OUTPUT_FILE" 2>/dev/null || echo "0")
          ERROR_RATE=$(grep -oP 'http_req_failed.*rate=\K[0-9.]+' "$OUTPUT_FILE" 2>/dev/null || echo "0")
          VUS_MAX=$(grep -oP 'vus_max.*max=\K[0-9.]+' "$OUTPUT_FILE" 2>/dev/null || echo "0")
          ITERATIONS=$(grep -oP 'iterations.*count=\K[0-9.]+' "$OUTPUT_FILE" 2>/dev/null || echo "0")
          
          # Convert error rate to percentage
          ERROR_PCT=$(echo "scale=2; $ERROR_RATE * 100" | bc 2>/dev/null || echo "0.00")
          
          # Save metrics to environment file
          echo "REGION_ID=${{ matrix.region_id }}" >> $GITHUB_ENV
          echo "REGION_LABEL=${{ matrix.region_label }}" >> $GITHUB_ENV
          echo "REGION_EMOJI=${{ matrix.region_emoji }}" >> $GITHUB_ENV
          echo "AVG_RESPONSE=$AVG_RESPONSE" >> $GITHUB_ENV
          echo "P95_RESPONSE=$P95_RESPONSE" >> $GITHUB_ENV
          echo "ERROR_PCT=$ERROR_PCT" >> $GITHUB_ENV
          echo "VUS_MAX=$VUS_MAX" >> $GITHUB_ENV
          echo "ITERATIONS=$ITERATIONS" >> $GITHUB_ENV
          
          echo "‚úÖ Metrics extracted:"
          echo "  Avg Response: ${AVG_RESPONSE}ms"
          echo "  P95 Response: ${P95_RESPONSE}ms"
          echo "  Error Rate: ${ERROR_PCT}%"
          echo "  Max VUs: ${VUS_MAX}"
          echo "  Iterations: ${ITERATIONS}"

      - name: Create regional summary
        run: |
          # Create detailed markdown summary for this region
          cat > "summary-${{ env.REGION_ID }}.md" << EOF
          # ${{ env.REGION_EMOJI }} ${{ env.REGION_LABEL }} Performance Results
          
          **Test Type:** ${{ env.SPECIFIC_TEST }}
          **Region ID:** ${{ env.REGION_ID }}
          **Runner:** ${{ matrix.runner }}
          **Test Time:** $(date)
          
          ## üìä Key Performance Indicators
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | Average Response Time | ${{ env.AVG_RESPONSE }}ms | $(if (( $(echo "${{ env.AVG_RESPONSE }} < 1000" | bc -l 2>/dev/null || echo 1) )); then echo "‚úÖ Good"; elif (( $(echo "${{ env.AVG_RESPONSE }} < 2000" | bc -l 2>/dev/null || echo 1) )); then echo "‚ö†Ô∏è Acceptable"; else echo "üî¥ Poor"; fi) |
          | 95th Percentile (P95) | ${{ env.P95_RESPONSE }}ms | $(if (( $(echo "${{ env.P95_RESPONSE }} < 2000" | bc -l 2>/dev/null || echo 1) )); then echo "‚úÖ Good"; elif (( $(echo "${{ env.P95_RESPONSE }} < 4000" | bc -l 2>/dev/null || echo 1) )); then echo "‚ö†Ô∏è Acceptable"; else echo "üî¥ Poor"; fi) |
          | Error Rate | ${{ env.ERROR_PCT }}% | $(if (( $(echo "${{ env.ERROR_PCT }} < 1" | bc -l 2>/dev/null || echo 1) )); then echo "‚úÖ Excellent"; elif (( $(echo "${{ env.ERROR_PCT }} < 5" | bc -l 2>/dev/null || echo 1) )); then echo "‚ö†Ô∏è Acceptable"; else echo "üî¥ Critical"; fi) |
          | Max Virtual Users | ${{ env.VUS_MAX }} | $(if (( $(echo "${{ env.VUS_MAX }} > 0" | bc -l 2>/dev/null || echo 0) )); then echo "‚úÖ Load Applied"; else echo "‚ö†Ô∏è No Load"; fi) |
          | Total Iterations | ${{ env.ITERATIONS }} | $(if (( $(echo "${{ env.ITERATIONS }} > 0" | bc -l 2>/dev/null || echo 0) )); then echo "‚úÖ Completed"; else echo "‚ö†Ô∏è None"; fi) |
          
          ## üìà Load Pattern
          
          \`\`\`mermaid
          xychart-beta
              title "Virtual Users Over Time - ${{ env.REGION_LABEL }}"
              x-axis "Time (minutes)" [0, 1, 2, 3, 4, 5]
              y-axis "Virtual Users" 0 --> $(( ${{ env.VUS_MAX }} + 10 ))
              line [$(if [ "${{ env.SPECIFIC_TEST }}" = "load" ]; then echo "10, 30, 80, 120, 60, 20"; elif [ "${{ env.SPECIFIC_TEST }}" = "spike" ]; then echo "5, 50, 200, 400, 200, 50"; elif [ "${{ env.SPECIFIC_TEST }}" = "stress" ]; then echo "100, 500, 1000, 2000, 3000, 100"; else echo "1, 3, 5, 3, 1"; fi)]
          \`\`\`
          
          ## üéØ Performance Targets
          
          \`\`\`
          $(if [ -f "output-${{ env.REGION_ID }}.txt" ]; then grep -A1 "‚úì\|‚úó" "output-${{ env.REGION_ID }}.txt" | head -20; else echo "No threshold data available"; fi)
          \`\`\`
          
          ## üìç Geographical Context
          
          **Coordinates:** ${{ matrix.region_coords }}
          **Timezone:** $(date +%Z)
          **Distance from US West:** $(if [ "${{ env.REGION_ID }}" = "eu-west" ]; then echo "8,900 km"; elif [ "${{ env.REGION_ID }}" = "apac-sg" ]; then echo "13,500 km"; else echo "0 km (Reference)"; fi)
          
          ## üß† Regional Analysis
          
          $(if [ "${{ env.REGION_ID }}" = "us-west" ]; then
            echo "**Primary Region Analysis:**"
            echo "- This is our primary deployment region"
            echo "- Performance here sets the baseline for other regions"
            echo "- Expected to have the best performance"
          elif [ "${{ env.REGION_ID }}" = "eu-west" ]; then
            echo "**European Region Analysis:**"
            echo "- Cross-Atlantic latency adds ~100-150ms"
            echo "- CDN effectiveness is crucial here"
            echo "- GDPR compliance considerations"
          elif [ "${{ env.REGION_ID }}" = "apac-sg" ]; then
            echo "**Asia-Pacific Region Analysis:**"
            echo "- Highest latency from primary region"
            echo "- Critical for global customer base"
            echo "- May need regional deployment or CDN"
          fi)
          
          EOF
          
          echo "‚úÖ Regional summary created for ${{ env.REGION_LABEL }}"

      - name: Upload regional results
        uses: actions/upload-artifact@v4
        with:
          name: regional-results-${{ env.REGION_ID }}
          path: |
            results-${{ env.REGION_ID }}.json
            summary-${{ env.REGION_ID }}.json
            output-${{ env.REGION_ID }}.txt
            summary-${{ env.REGION_ID }}.md
          retention-days: 30

      - name: Display quick region summary
        run: |
          echo "========================================"
          echo "üåç REGION TEST COMPLETE"
          echo "========================================"
          echo "Region:    ${{ env.REGION_EMOJI }} ${{ env.REGION_LABEL }}"
          echo "Test:      ${{ env.SPECIFIC_TEST }}"
          echo "Avg Resp:  ${{ env.AVG_RESPONSE }}ms"
          echo "P95 Resp:  ${{ env.P95_RESPONSE }}ms"
          echo "Error:     ${{ env.ERROR_PCT }}%"
          echo "Max VUs:   ${{ env.VUS_MAX }}"
          echo "Iterations: ${{ env.ITERATIONS }}"
          echo "========================================"

  # ============================================================
  # GLOBAL REGIONAL ANALYSIS & REPORT
  # ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc curl python3 python3-pip
          pip3 install matplotlib numpy pandas

      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: regional-results-*
          merge-multiple: true

      - name: Create comprehensive global report
        run: |
          echo "# üåç GLOBAL PERFORMANCE ANALYSIS REPORT" > GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "**üìÖ Report Generated:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> GLOBAL_REPORT.md
          echo "**üéØ Test Type:** ${{ github.event.inputs.test_type }}" >> GLOBAL_REPORT.md
          echo "**üåê Execution Mode:** Multi-Region (3 Regions)" >> GLOBAL_REPORT.md
          echo "**‚ö° Report ID:** $(date +%s)-$(openssl rand -hex 4)" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # EXECUTIVE SUMMARY
          echo "## üìã EXECUTIVE SUMMARY" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "This report provides a comprehensive analysis of application performance across 3 global regions. Understanding regional performance variations is critical for delivering consistent user experiences worldwide." >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Initialize arrays for comparison
          REGION_NAMES=()
          REGION_IDS=()
          AVG_TIMES=()
          P95_TIMES=()
          ERROR_RATES=()
          VUS_MAXES=()
          ITERATIONS=()
          STATUSES=()
          
          echo "## üìä REGIONAL PERFORMANCE COMPARISON" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "| Region | Avg Response | P95 Response | Error Rate | Max VUs | Status | Grade |" >> GLOBAL_REPORT.md
          echo "|--------|--------------|--------------|------------|---------|--------|-------|" >> GLOBAL_REPORT.md
          
          # Process each region
          for REGION_ID in us-west eu-west apac-sg; do
            SUMMARY_FILE="all-results/summary-${REGION_ID}.json"
            OUTPUT_FILE="all-results/output-${REGION_ID}.txt"
            
            if [ -f "$SUMMARY_FILE" ]; then
              # Parse JSON metrics
              AVG=$(jq -r '.metrics.http_req_duration.values.avg // "0"' "$SUMMARY_FILE" 2>/dev/null || echo "0")
              P95=$(jq -r '.metrics.http_req_duration.values."p(95)" // "0"' "$SUMMARY_FILE" 2>/dev/null || echo "0")
              ERR=$(jq -r '.metrics.http_req_failed.values.rate // 0' "$SUMMARY_FILE" 2>/dev/null || echo "0")
              VUS_MAX=$(jq -r '.metrics.vus.values.max // "0"' "$SUMMARY_FILE" 2>/dev/null || echo "0")
              ITER_COUNT=$(jq -r '.metrics.iterations.values.count // "0"' "$SUMMARY_FILE" 2>/dev/null || echo "0")
              
              # Calculate error percentage
              ERR_PCT=$(echo "scale=2; $ERR * 100" | bc 2>/dev/null || echo "0.00")
              
              # Determine status and grade
              if (( $(echo "$ERR_PCT > 10" | bc -l 2>/dev/null || echo 0) )); then
                STATUS="üî¥ Critical"
                GRADE="F"
              elif (( $(echo "$ERR_PCT > 5" | bc -l 2>/dev/null || echo 0) )); then
                STATUS="üü† Unstable"
                GRADE="D"
              elif (( $(echo "$AVG > 3000" | bc -l 2>/dev/null || echo 0) )); then
                STATUS="üü° Slow"
                GRADE="C"
              elif (( $(echo "$AVG > 1500" | bc -l 2>/dev/null || echo 0) )); then
                STATUS="üü¢ Acceptable"
                GRADE="B"
              else
                STATUS="‚úÖ Excellent"
                GRADE="A"
              fi
              
              # Get region details
              case $REGION_ID in
                us-west)
                  REGION_LABEL="üá∫üá∏ US West"
                  REGION_NAME="US West (California)"
                  ;;
                eu-west)
                  REGION_LABEL="üá≥üá± EU West"
                  REGION_NAME="EU West (Netherlands)"
                  ;;
                apac-sg)
                  REGION_LABEL="üá∏üá¨ APAC Singapore"
                  REGION_NAME="APAC Singapore"
                  ;;
              esac
              
              echo "| $REGION_LABEL | ${AVG}ms | ${P95}ms | ${ERR_PCT}% | $VUS_MAX | $STATUS | **$GRADE** |" >> GLOBAL_REPORT.md
              
              # Store for charts
              REGION_NAMES+=("$REGION_NAME")
              REGION_IDS+=("$REGION_ID")
              AVG_TIMES+=("$AVG")
              P95_TIMES+=("$P95")
              ERROR_RATES+=("$ERR_PCT")
              VUS_MAXES+=("$VUS_MAX")
              ITERATIONS+=("$ITER_COUNT")
              STATUSES+=("$STATUS")
            else
              echo "| $REGION_ID | ‚ùå No Data | ‚ùå No Data | ‚ùå No Data | ‚ùå No Data | ‚ö´ Missing | F |" >> GLOBAL_REPORT.md
            fi
          done
          
          echo "" >> GLOBAL_REPORT.md
          
          # PERFORMANCE SCORECARD
          echo "## üèÜ PERFORMANCE SCORECARD" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Calculate overall score
          TOTAL_SCORE=0
          REGION_COUNT=${#REGION_NAMES[@]}
          
          for i in "${!REGION_NAMES[@]}"; do
            SCORE=0
            AVG=${AVG_TIMES[$i]}
            ERR=${ERROR_RATES[$i]}
            
            if (( $(echo "$ERR < 1" | bc -l 2>/dev/null || echo 0) )); then SCORE=$((SCORE + 40)); fi
            if (( $(echo "$AVG < 1000" | bc -l 2>/dev/null || echo 0) )); then SCORE=$((SCORE + 30)); fi
            if (( $(echo "$ERR < 5" | bc -l 2>/dev/null || echo 0) )); then SCORE=$((SCORE + 20)); fi
            if (( $(echo "$AVG < 2000" | bc -l 2>/dev/null || echo 0) )); then SCORE=$((SCORE + 10)); fi
            
            TOTAL_SCORE=$((TOTAL_SCORE + SCORE))
          done
          
          if [ $REGION_COUNT -gt 0 ]; then
            OVERALL_SCORE=$((TOTAL_SCORE / REGION_COUNT))
            
            echo "### üìà Overall Performance Score: **$OVERALL_SCORE/100**" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            if [ $OVERALL_SCORE -ge 90 ]; then
              echo "**üèÖ EXCELLENT** - Global performance meets all targets" >> GLOBAL_REPORT.md
            elif [ $OVERALL_SCORE -ge 70 ]; then
              echo "**üëç GOOD** - Acceptable performance with minor improvements needed" >> GLOBAL_REPORT.md
            elif [ $OVERALL_SCORE -ge 50 ]; then
              echo "**‚ö†Ô∏è FAIR** - Needs attention in some regions" >> GLOBAL_REPORT.md
            else
              echo "**üî¥ POOR** - Significant improvements required" >> GLOBAL_REPORT.md
            fi
          fi
          
          echo "" >> GLOBAL_REPORT.md
          
          # VISUAL CHARTS SECTION
          if [ ${#REGION_NAMES[@]} -gt 0 ]; then
            echo "## üìà VISUAL PERFORMANCE CHARTS" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Chart 1: Response Time Comparison
            echo "### ‚è±Ô∏è Average Response Time by Region" >> GLOBAL_REPORT.md
            echo '```mermaid' >> GLOBAL_REPORT.md
            echo 'xychart-beta' >> GLOBAL_REPORT.md
            echo '    title "Regional Response Time Comparison (Lower is Better)"' >> GLOBAL_REPORT.md
            
            # Build region labels for chart
            CHART_LABELS=""
            for name in "${REGION_NAMES[@]}"; do
              CHART_LABELS="$CHART_LABELS\"$name\", "
            done
            CHART_LABELS=${CHART_LABELS%, }
            
            echo "    x-axis $CHART_LABELS" >> GLOBAL_REPORT.md
            
            # Determine y-axis max
            MAX_VAL=0
            for val in "${AVG_TIMES[@]}"; do
              if (( $(echo "$val > $MAX_VAL" | bc -l 2>/dev/null || echo 0) )); then
                MAX_VAL=$val
              fi
            done
            Y_MAX=$(echo "$MAX_VAL * 1.2" | bc 2>/dev/null || echo "1000")
            
            echo "    y-axis \"Response Time (ms)\" 0 --> $Y_MAX" >> GLOBAL_REPORT.md
            
            # Build data array
            DATA_ARRAY=""
            for val in "${AVG_TIMES[@]}"; do
              DATA_ARRAY="$DATA_ARRAY$val, "
            done
            DATA_ARRAY=${DATA_ARRAY%, }
            
            echo "    bar [$DATA_ARRAY]" >> GLOBAL_REPORT.md
            echo '```' >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Chart 2: Error Rate Comparison
            echo "### üö® Error Rate Comparison" >> GLOBAL_REPORT.md
            echo '```mermaid' >> GLOBAL_REPORT.md
            echo 'xychart-beta' >> GLOBAL_REPORT.md
            echo '    title "Error Rate by Region (Lower is Better)"' >> GLOBAL_REPORT.md
            echo "    x-axis $CHART_LABELS" >> GLOBAL_REPORT.md
            echo '    y-axis "Error Rate (%)" 0 --> 20' >> GLOBAL_REPORT.md
            
            ERROR_DATA=""
            for val in "${ERROR_RATES[@]}"; do
              ERROR_DATA="$ERROR_DATA$val, "
            done
            ERROR_DATA=${ERROR_DATA%, }
            
            echo "    line [$ERROR_DATA]" >> GLOBAL_REPORT.md
            echo '```' >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Chart 3: Performance Heatmap
            echo "### üó∫Ô∏è Geographical Performance Heatmap" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "```mermaid" >> GLOBAL_REPORT.md
            echo "quadrantChart" >> GLOBAL_REPORT.md
            echo "    title \"Global Performance Distribution\"" >> GLOBAL_REPORT.md
            echo "    x-axis \"Fast & Reliable\" --> \"Slow & Unstable\"" >> GLOBAL_REPORT.md
            echo "    y-axis \"Low Latency\" --> \"High Latency\"" >> GLOBAL_REPORT.md
            echo "    quadrant-1 \"Excellent\"" >> GLOBAL_REPORT.md
            echo "    quadrant-2 \"Good\"" >> GLOBAL_REPORT.md
            echo "    quadrant-3 \"Needs Work\"" >> GLOBAL_REPORT.md
            echo "    quadrant-4 \"Critical\"" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Place regions on quadrant chart
            for i in "${!REGION_NAMES[@]}"; do
              AVG=${AVG_TIMES[$i]}
              ERR=${ERROR_RATES[$i]}
              
              # Calculate position (0-1 scale)
              X_POS=$(echo "scale=2; $ERR / 20" | bc 2>/dev/null || echo "0.5")
              Y_POS=$(echo "scale=2; $AVG / 5000" | bc 2>/dev/null || echo "0.5")
              
              # Ensure within bounds
              X_POS=$(echo "scale=2; if ($X_POS > 1) 1 else if ($X_POS < 0) 0 else $X_POS" | bc 2>/dev/null || echo "0.5")
              Y_POS=$(echo "scale=2; if ($Y_POS > 1) 1 else if ($Y_POS < 0) 0 else $Y_POS" | bc 2>/dev/null || echo "0.5")
              
              SHORT_NAME=$(echo "${REGION_NAMES[$i]}" | cut -d' ' -f1)
              echo "    \"$SHORT_NAME (${AVG}ms, ${ERR}%)\": [$X_POS, $Y_POS]" >> GLOBAL_REPORT.md
            done
            
            echo '```' >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
          fi
          
          # REGIONAL INSIGHTS
          echo "## üß† REGIONAL PERFORMANCE INSIGHTS" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          if [ ${#REGION_NAMES[@]} -ge 2 ]; then
            # Find best and worst regions
            BEST_INDEX=0
            WORST_INDEX=0
            BEST_SCORE=1000000
            WORST_SCORE=0
            
            for i in "${!AVG_TIMES[@]}"; do
              SCORE=$(echo "${AVG_TIMES[$i]} + (${ERROR_RATES[$i]} * 100)" | bc 2>/dev/null || echo "0")
              if (( $(echo "$SCORE < $BEST_SCORE" | bc -l 2>/dev/null || echo 0) )); then
                BEST_SCORE=$SCORE
                BEST_INDEX=$i
              fi
              if (( $(echo "$SCORE > $WORST_SCORE" | bc -l 2>/dev/null || echo 0) )); then
                WORST_SCORE=$SCORE
                WORST_INDEX=$i
              fi
            done
            
            echo "### üèÜ Performance Leader" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "**${REGION_NAMES[$BEST_INDEX]}** demonstrates the best performance with:" >> GLOBAL_REPORT.md
            echo "- Average response time: **${AVG_TIMES[$BEST_INDEX]}ms**" >> GLOBAL_REPORT.md
            echo "- Error rate: **${ERROR_RATES[$BEST_INDEX]}%**" >> GLOBAL_REPORT.md
            echo "- Status: ${STATUSES[$BEST_INDEX]}" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            echo "### ‚ö†Ô∏è Area Needing Attention" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "**${REGION_NAMES[$WORST_INDEX]}** shows the weakest performance:" >> GLOBAL_REPORT.md
            echo "- Average response time: **${AVG_TIMES[$WORST_INDEX]}ms**" >> GLOBAL_REPORT.md
            echo "- Error rate: **${ERROR_RATES[$WORST_INDEX]}%**" >> GLOBAL_REPORT.md
            echo "- Status: ${STATUSES[$WORST_INDEX]}" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            
            # Calculate performance gap
            GAP=$(echo "${AVG_TIMES[$WORST_INDEX]} - ${AVG_TIMES[$BEST_INDEX]}" | bc 2>/dev/null || echo "0")
            GAP_PERCENT=$(echo "scale=0; ($GAP / ${AVG_TIMES[$BEST_INDEX]}) * 100" | bc 2>/dev/null || echo "0")
            
            if (( $(echo "$GAP_PERCENT > 100" | bc -l 2>/dev/null || echo 0) )); then
              echo "> üö® **CRITICAL PERFORMANCE GAP:** The slowest region is **${GAP_PERCENT}% slower** than the fastest region. This indicates significant infrastructure or CDN issues requiring immediate attention." >> GLOBAL_REPORT.md
            elif (( $(echo "$GAP_PERCENT > 50" | bc -l 2>/dev/null || echo 0) )); then
              echo "> ‚ö†Ô∏è **NOTICEABLE PERFORMANCE GAP:** The slowest region is **${GAP_PERCENT}% slower** than the fastest region. Consider CDN optimization or regional deployments." >> GLOBAL_REPORT.md
            fi
            echo "" >> GLOBAL_REPORT.md
          fi
          
          # INFRASTRUCTURE RECOMMENDATIONS
          echo "## üéØ INFRASTRUCTURE RECOMMENDATIONS" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Check for critical issues
          CRITICAL_REGIONS=0
          for i in "${!ERROR_RATES[@]}"; do
            if (( $(echo "${ERROR_RATES[$i]} > 10" | bc -l 2>/dev/null || echo 0) )); then
              CRITICAL_REGIONS=$((CRITICAL_REGIONS + 1))
            fi
          done
          
          if [ $CRITICAL_REGIONS -gt 0 ]; then
            echo "### üî¥ Critical Actions Required" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "1. **Immediate CDN Deployment:** Implement regional CDN for high-error regions" >> GLOBAL_REPORT.md
            echo "2. **Database Read Replicas:** Deploy read replicas in problematic regions" >> GLOBAL_REPORT.md
            echo "3. **Geo-DNS Routing:** Implement DNS-based routing to healthy regions" >> GLOBAL_REPORT.md
            echo "4. **Regional Monitoring:** Set up alerts for region-specific degradation" >> GLOBAL_REPORT.md
            echo "5. **Performance Budgets:** Establish and enforce regional performance budgets" >> GLOBAL_REPORT.md
          else
            # Check for latency issues
            HIGH_LATENCY_REGIONS=0
            for i in "${!AVG_TIMES[@]}"; do
              if (( $(echo "${AVG_TIMES[$i]} > 2000" | bc -l 2>/dev/null || echo 0) )); then
                HIGH_LATENCY_REGIONS=$((HIGH_LATENCY_REGIONS + 1))
              fi
            done
            
            if [ $HIGH_LATENCY_REGIONS -gt 0 ]; then
              echo "### üü° Recommended Improvements" >> GLOBAL_REPORT.md
              echo "" >> GLOBAL_REPORT.md
              echo "1. **CDN Optimization:** Review and optimize CDN configuration" >> GLOBAL_REPORT.md
              echo "2. **Edge Computing:** Consider edge functions for high-latency regions" >> GLOBAL_REPORT.md
              echo "3. **Connection Pooling:** Optimize database connection pooling" >> GLOBAL_REPORT.md
              echo "4. **Caching Strategy:** Implement aggressive caching for static assets" >> GLOBAL_REPORT.md
            else
              echo "### üü¢ Optimization Opportunities" >> GLOBAL_REPORT.md
              echo "" >> GLOBAL_REPORT.md
              echo "1. **Performance Monitoring:** Continue monitoring regional performance" >> GLOBAL_REPORT.md
              echo "2. **A/B Testing:** Test new optimizations in lowest-performing region" >> GLOBAL_REPORT.md
              echo "3. **Capacity Planning:** Use regional data for infrastructure planning" >> GLOBAL_REPORT.md
              echo "4. **Documentation:** Document regional performance characteristics" >> GLOBAL_REPORT.md
            fi
          fi
          
          echo "" >> GLOBAL_REPORT.md
          
          # DEPLOYMENT DECISION
          echo "## ‚öñÔ∏è GLOBAL DEPLOYMENT DECISION" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          echo "Based on multi-region performance analysis:" >> GLOBAL_REPORT.md
          echo "" >> GLOBAL_REPORT.md
          
          # Determine deployment readiness
          READY_FOR_GLOBAL=1
          REASONS=""
          
          for i in "${!ERROR_RATES[@]}"; do
            if (( $(echo "${ERROR_RATES[$i]} > 10" | bc -l 2>/dev/null || echo 0) )); then
              READY_FOR_GLOBAL=0
              REASONS="$REASONS- High error rate (${ERROR_RATES[$i]}%) in ${REGION_NAMES[$i]}\n"
            fi
          done
          
          for i in "${!AVG_TIMES[@]}"; do
            if (( $(echo "${AVG_TIMES[$i]} > 5000" | bc -l 2>/dev/null || echo 0) )); then
              READY_FOR_GLOBAL=0
              REASONS="$REASONS- Extremely high latency (${AVG_TIMES[$i]}ms) in ${REGION_NAMES[$i]}\n"
            fi
          done
          
          if [ $READY_FOR_GLOBAL -eq 1 ]; then
            echo "### üü¢ **APPROVED FOR GLOBAL DEPLOYMENT**" >> GLOBAL_REPORT.md
            echo "" >> GLOBAL_REPORT.md
            echo "‚úÖ **All regions meet deployment criteria:**" >> GLOBAL_REPORT.md
            echo "- Error rates below 10% in all regions" >> GLOBAL_REPORT.md
            echo "- Acceptable response times across regions" >> GLOBAL_REPORT.md
            echo "- Consistent performance patterns" >> GLOBAL_REPORT.md
            echo "" >> G
