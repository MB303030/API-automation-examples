name: Run K6 and Deploy to Pages

on:
  workflow_dispatch:  # Run on demand

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  run-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Generate K6 Results
      run: |
        echo '{
          "time": "'$(date +"%H:%M:%S")'",
          "response_time": '$((50 + RANDOM % 200))',
          "success_rate": '$((85 + RANDOM % 15))'
        }' > data.json
    
    - name: Create Dashboard
      run: |
        echo '<!DOCTYPE html>
        <html>
        <head>
          <title>K6 Dashboard</title>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <style>
            body { font-family: Arial; padding: 20px; text-align: center; }
            canvas { max-width: 600px; margin: 20px auto; display: block; }
            .info { background: #f0f0f0; padding: 10px; margin: 20px; }
          </style>
        </head>
        <body>
          <h1>ðŸ“Š K6 Performance Test Results</h1>
          <div class="info">Last run: <span id="time"></span></div>
          <canvas id="myChart" width="600" height="300"></canvas>
          <div class="info">
            <p>Response Time: <span id="response"></span> ms</p>
            <p>Success Rate: <span id="success"></span>%</p>
          </div>
          <script>
            fetch("data.json").then(r => r.json()).then(d => {
              document.getElementById("time").textContent = d.time;
              document.getElementById("response").textContent = d.response_time;
              document.getElementById("success").textContent = d.success_rate;
              
              new Chart(document.getElementById("myChart"), {
                type: "bar",
                data: {
                  labels: ["Response Time (ms)", "Success Rate (%)"],
                  datasets: [{
                    label: "Performance Metrics",
                    data: [d.response_time, d.success_rate],
                    backgroundColor: ["#36a2eb", "#4bc0c0"]
                  }]
                }
              });
            });
          </script>
        </body>
        </html>' > index.html
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
