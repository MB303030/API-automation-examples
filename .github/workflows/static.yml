name: K6 Test Report

on:
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  deploy-report:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run K6 Test
        continue-on-error: true
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/performance/smoke/dummyjson-smoke.js
      
      - name: Create Simple Report
        run: |
          # Create data.json with your ACTUAL test results
          cat > data.json << 'EOF'
          {
            "test_name": "DummyJSON Smoke Test",
            "timestamp": "$(date)",
            "results": {
              "virtual_users": 2,
              "duration": "30s",
              "total_requests": 4113,
              "avg_response_time": "14ms",
              "p95_response_time": "19ms",
              "success_rate": "37%",
              "failed_requests": "62%",
              "requests_per_second": "137"
            },
            "checks": {
              "status_200": "37% passed",
              "has_products": "37% passed",
              "response_time_2s": "100% passed"
            }
          }
          EOF
          
          # Create simple HTML table
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>K6 Test Report</title>
            <style>
              body { font-family: Arial; padding: 20px; max-width: 800px; margin: auto; }
              h1 { color: #333; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th { background: #f2f2f2; text-align: left; padding: 12px; }
              td { padding: 12px; border-bottom: 1px solid #ddd; }
              .success { color: green; }
              .warning { color: orange; }
              .error { color: red; }
              .footer { margin-top: 30px; color: #666; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <h1>üìã K6 Performance Test Report</h1>
            <div id="report">
              <p>Loading test results...</p>
            </div>
            
            <script>
              fetch('data.json')
                .then(response => response.json())
                .then(data => {
                  document.getElementById('report').innerHTML = \`
                    <h2>\${data.test_name}</h2>
                    <p><strong>Test Time:</strong> \${data.timestamp}</p>
                    
                    <h3>üìä Test Summary</h3>
                    <table>
                      <tr><th>Metric</th><th>Value</th><th>Status</th></tr>
                      <tr>
                        <td>Virtual Users</td>
                        <td>\${data.results.virtual_users}</td>
                        <td>‚úÖ</td>
                      </tr>
                      <tr>
                        <td>Duration</td>
                        <td>\${data.results.duration}</td>
                        <td>‚úÖ</td>
                      </tr>
                      <tr>
                        <td>Total Requests</td>
                        <td>\${data.results.total_requests}</td>
                        <td>‚úÖ</td>
                      </tr>
                      <tr>
                        <td>Avg Response Time</td>
                        <td>\${data.results.avg_response_time}</td>
                        <td class="success">‚úÖ Good</td>
                      </tr>
                      <tr>
                        <td>P95 Response Time</td>
                        <td>\${data.results.p95_response_time}</td>
                        <td class="success">‚úÖ Good</td>
                      </tr>
                      <tr>
                        <td>Success Rate</td>
                        <td>\${data.results.success_rate}</td>
                        <td class="error">‚ùå Needs attention</td>
                      </tr>
                      <tr>
                        <td>Failed Requests</td>
                        <td>\${data.results.failed_requests}</td>
                        <td class="error">‚ùå High</td>
                      </tr>
                      <tr>
                        <td>Requests/Second</td>
                        <td>\${data.results.requests_per_second}</td>
                        <td>‚úÖ</td>
                      </tr>
                    </table>
                    
                    <h3>‚úÖ Checks</h3>
                    <table>
                      <tr><th>Check</th><th>Result</th></tr>
                      <tr><td>Status is 200</td><td>\${data.checks.status_200}</td></tr>
                      <tr><td>Response has products</td><td>\${data.checks.has_products}</td></tr>
                      <tr><td>Response time < 2s</td><td>\${data.checks.response_time_2s}</td></tr>
                    </table>
                    
                    <div class="footer">
                      <p><strong>Note:</strong> This report shows actual K6 test results.</p>
                      <p><a href="https://github.com/MB303030/API-automation-examples/actions">Run test again</a> | 
                      <a href="javascript:location.reload()">Refresh report</a></p>
                    </div>
                  \`;
                })
                .catch(error => {
                  document.getElementById('report').innerHTML = \`
                    <div style="color: red; padding: 20px; background: #ffe6e6;">
                      <h3>Error loading report</h3>
                      <p>\${error.message}</p>
                      <p>Try running the test first.</p>
                    </div>
                  \`;
                });
            </script>
          </body>
          </html>
          EOF
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
