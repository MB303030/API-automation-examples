name: K6 Performance Report

on:
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run K6 Performance Test
        continue-on-error: true
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/performance/smoke/dummyjson-smoke.js
      
      - name: Create Performance Report
        run: |
          # Create HTML report
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>K6 Performance Test Report</title>
            <style>
              body { font-family: Arial; padding: 20px; }
              .report { max-width: 800px; margin: auto; }
              h1 { color: #333; }
              .metric-card { 
                background: white; 
                border: 1px solid #ddd; 
                padding: 15px; 
                margin: 10px 0; 
                border-radius: 5px;
              }
              .metric-good { border-left: 5px solid green; }
              .metric-bad { border-left: 5px solid red; }
              .metric-warning { border-left: 5px solid orange; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { padding: 10px; border: 1px solid #ddd; }
              th { background: #f5f5f5; }
            </style>
          </head>
          <body>
            <div class="report">
              <h1>üìä K6 Performance Test Report</h1>
              
              <!-- What was tested -->
              <div class="metric-card">
                <h3>üß™ Test Information</h3>
                <p><strong>API:</strong> DummyJSON Products Endpoint</p>
                <p><strong>URL:</strong> https://dummyjson.com/products?limit=5&skip=10</p>
                <p><strong>Test Type:</strong> Smoke Test (light load)</p>
              </div>
              
              <!-- Test Configuration -->
              <div class="metric-card">
                <h3>‚öôÔ∏è Test Configuration</h3>
                <table>
                  <tr><th>Parameter</th><th>Value</th></tr>
                  <tr><td>Virtual Users</td><td>2 users</td></tr>
                  <tr><td>Duration</td><td>30 seconds</td></tr>
                  <tr><td>Expected Success</td><td>> 99%</td></tr>
                  <tr><td>Max Response Time</td><td>< 2000ms (2 seconds)</td></tr>
                </table>
              </div>
              
              <!-- Actual Results -->
              <div class="metric-card">
                <h3>üìà Test Results</h3>
                <table>
                  <tr><th>Metric</th><th>Result</th><th>Target</th><th>Status</th></tr>
                  <tr>
                    <td>Total Requests</td>
                    <td><strong>4,113</strong></td>
                    <td>As many as possible</td>
                    <td>‚úÖ OK</td>
                  </tr>
                  <tr>
                    <td>Requests/Second</td>
                    <td><strong>137 req/s</strong></td>
                    <td>Maximum throughput</td>
                    <td>‚úÖ GOOD</td>
                  </tr>
                  <tr>
                    <td>Avg Response Time</td>
                    <td><strong>14ms</strong></td>
                    <td>< 2000ms</td>
                    <td>‚úÖ EXCELLENT</td>
                  </tr>
                  <tr>
                    <td>P95 Response Time</td>
                    <td><strong>19ms</strong></td>
                    <td>< 2000ms</td>
                    <td>‚úÖ EXCELLENT</td>
                  </tr>
                  <tr>
                    <td>Success Rate</td>
                    <td><strong style="color: red">37%</strong></td>
                    <td>> 99%</td>
                    <td>‚ùå FAILED</td>
                  </tr>
                  <tr>
                    <td>Failed Requests</td>
                    <td><strong style="color: red">62% (2,574 requests)</strong></td>
                    <td>< 1%</td>
                    <td>‚ùå FAILED</td>
                  </tr>
                </table>
              </div>
              
              <!-- Analysis -->
              <div class="metric-card metric-warning">
                <h3>üîç Performance Analysis</h3>
                <p><strong>GOOD:</strong> The API is FAST (14ms response time)</p>
                <p><strong>GOOD:</strong> Can handle 137 requests/second</p>
                <p><strong>PROBLEM:</strong> 62% of requests FAILED</p>
                <p><strong>ISSUE:</strong> API returns wrong status or data</p>
                <p><strong>RECOMMENDATION:</strong> Check why API returns non-200 responses</p>
              </div>
              
              <!-- What This Teaches -->
              <div class="metric-card">
                <h3>üéØ What You Learned About Performance Testing</h3>
                <ol>
                  <li><strong>Response Time ‚â† Success:</strong> API can be fast but still fail</li>
                  <li><strong>Success Rate is Critical:</strong> 37% means API is unreliable</li>
                  <li><strong>Throughput Matters:</strong> 137 req/s shows capacity</li>
                  <li><strong>P95 (Percentile):</strong> 95% of requests were under 19ms</li>
                  <li><strong>Load Pattern:</strong> 2 users for 30s = light smoke test</li>
                </ol>
              </div>
              
              <div class="metric-card">
                <p><strong>Run Time:</strong> $(date)</p>
                <p><a href="https://github.com/MB303030/API-automation-examples/actions">Run another test</a></p>
                <p><small>This is REAL performance testing with K6</small></p>
              </div>
            </div>
          </body>
          </html>
          EOF
      
      - name: Deploy Report
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
