name: Simple API Tests performence report

on:
  workflow_dispatch:  # ONLY on manual trigger (on-demand)

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # Step 2: Docker validation
    - name: ğŸ³ Validate Docker installation
      run: |
        echo "ğŸ” Validating Docker..."
        docker --version
        echo "âœ… Docker is ready for K6 tests"

    # Step 3: Setup Node.js
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # Step 4: Install dependencies
    - name: ğŸ“¦ Install dependencies
      run: npm ci

    # Step 5: Install Playwright
    - name: ğŸ­ Install Playwright
      run: npx playwright install chromium

    # Step 6: Setup environment
    - name: ğŸ”§ Setup environment
      run: |
        echo "API_KEY=test-key" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://template.postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    # Step 7: Run Playwright tests
    - name: ğŸ§ª Run Playwright tests
      run: npx playwright test

    # Step 8: Run K6 test (if file exists)
    - name: ğŸš€ Run K6 performance test
      run: |
        echo "ğŸ” Checking for K6 test file..."
        if [ -f "tests/performance/smoke/dummyjson-smoke.js" ]; then
          echo "ğŸš€ Running K6 smoke test..."
          docker run --rm -i grafana/k6 run - < tests/performance/smoke/dummyjson-smoke.js
        else
          echo "âš ï¸ No K6 test found at: tests/performance/smoke/dummyjson-smoke.js"
        fi

    # Step 9: Upload Playwright report
    - name: ğŸ“¤ Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

    # Step 10: Simple summary
    - name: ğŸ“Š Create test summary
      if: always()
      run: |
        echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Docker Validation:" >> $GITHUB_STEP_SUMMARY
        echo "- Docker is installed and working" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ­ Playwright Tests:" >> $GITHUB_STEP_SUMMARY
        echo "- Functional API tests completed" >> $GITHUB_STEP_SUMMARY
        echo "- Download report artifact for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ K6 Performance Tests:" >> $GITHUB_STEP_SUMMARY
        echo "- K6 test file exists: tests/performance/smoke/dummyjson-smoke.js" >> $GITHUB_STEP_SUMMARY
        echo "- Check logs above for K6 output" >> $GITHUB_STEP_SUMMARY
