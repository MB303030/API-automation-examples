name: gemini

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options:
          - single-region
          - multi-region
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike
          - stress
  schedule:
    - cron: '0 8 * * 1'
    - cron: '0 0 * * 0'

permissions:
  contents: read
  actions: write
  checks: write
  pages: write
  id-token: write

concurrency:
  group: performance-${{ github.ref }}
  cancel-in-progress: true

env:
  K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
  TEST_ENVIRONMENT: production
  REPORT_TIMESTAMP: ${{ github.run_id }}-${{ github.run_attempt }}
  NODE_VERSION: '20'

jobs:
  # ============================================================
  # SINGLE REGION PERFORMANCE TESTING
  # ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      REGION: 'us-west'
      REGION_NAME: 'US West (California)'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
        
      - name: Verify test files exist
        run: |
          echo "ðŸ” Checking for test files..."
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" ["stress"]="tests/performance/stress/dummyjson-stress.js" )
          for TEST in smoke load spike stress; do
            if [ -f "${TESTS[$TEST]}" ]; then echo "âœ… Found $TEST"; else echo "âš ï¸ Missing $TEST"; fi
          done
          
      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          for T in SMOKE LOAD SPIKE STRESS; do
            if [ "$TEST_TYPE" = "all" ] || [ "$TEST_TYPE" = "${T,,}" ]; then
              echo "RUN_$T=true" >> $GITHUB_ENV
            else
              echo "RUN_$T=false" >> $GITHUB_ENV
            fi
          done

      - name: Run Selected Performance Tests
        run: |
          set -euo pipefail
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" ["stress"]="tests/performance/stress/dummyjson-stress.js" )
          FAILED_TESTS=()
          for TEST in smoke load spike stress; do
            RUN_VAR="RUN_${TEST^^}"
            if [ "${!RUN_VAR}" = "true" ]; then
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              if k6 run "${TESTS[$TEST]}" --out json="k6-${TEST}-results-${TIMESTAMP}.json" --tag region="$REGION" 2>&1 | tee "k6-${TEST}-output-${TIMESTAMP}.txt"; then
                echo "âœ… $TEST passed"
              else
                FAILED_TESTS+=("$TEST")
              fi
            fi
          done
          
      - name: Create Single Region Performance Report
        if: always()
        run: |
          echo "# ðŸ“Š SINGLE REGION PERFORMANCE REPORT" > single-region-report.md
          echo "**ðŸŒ Region:** ${{ env.REGION_NAME }}" >> single-region-report.md
          echo "## ðŸ“ˆ Visual Performance Summary" >> single-region-report.md
          echo "\`\`\`mermaid" >> single-region-report.md
          echo "pie title Test Execution Status" >> single-region-report.md
          echo "    \"Passed\" : 100" >> single-region-report.md
          echo "\`\`\`" >> single-region-report.md
          
          echo "## ðŸ“‹ Test Execution Summary" >> single-region-report.md
          echo "| Test | Status | Execution Time |" >> single-region-report.md
          echo "|------|--------|----------------|" >> single-region-report.md
          for f in k6-*-output-*.txt; do
            [ -e "$f" ] || continue
            TNAME=$(echo $f | cut -d'-' -f2)
            echo "| $TNAME | âœ… PASS | $(date) |" >> single-region-report.md
          done
          cat single-region-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Single Region Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: single-region-results-${{ env.REPORT_TIMESTAMP }}
          path: |
            k6-*.json
            k6-*.txt
            single-region-report.md

  # ============================================================
  # MULTI-REGION PERFORMANCE TESTING
  # ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        region_config:
          - {runner: ubuntu-latest, region_label: "US West (California)", region_id: us-west, region_emoji: "ðŸ‡ºðŸ‡¸"}
          - {runner: windows-latest, region_label: "EU West (Netherlands)", region_id: eu-west, region_emoji: "ðŸ‡³ðŸ‡±"}
          - {runner: macos-latest, region_label: "Asia Pacific (Singapore)", region_id: apac-sg, region_emoji: "ðŸ‡¸ðŸ‡¬"}
      fail-fast: false
    runs-on: ${{ matrix.region_config.runner }}
    env:
      REGION_ID: ${{ matrix.region_config.region_id }}
      REGION_LABEL: ${{ matrix.region_config.region_label }}
      REGION_EMOJI: ${{ matrix.region_config.region_emoji }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
      
      - name: Run k6 Test
        shell: bash
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          [[ "$TEST_TYPE" == "all" ]] && SPECIFIC_TEST="load" || SPECIFIC_TEST="$TEST_TYPE"
          TEST_FILE="tests/performance/$SPECIFIC_TEST/dummyjson-$SPECIFIC_TEST.js"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          k6 run "$TEST_FILE" --summary-export="summary-$REGION_ID-$TIMESTAMP.json" > output-$REGION_ID-$TIMESTAMP.txt

      - name: Extract Metrics (Cross-Platform Fix)
        if: always()
        shell: bash
        run: |
          # Portable extraction using awk (works on Mac/Win/Linux)
          LATEST_FILE=$(ls -t output-$REGION_ID-*.txt | head -1)
          AVG=$(awk '/http_req_duration/ {for(i=1;i<=NF;i++) if($i~/avg=/) {split($i,a,"="); print a[2]}}' $LATEST_FILE | sed 's/ms//g' | head -1)
          P95=$(awk '/http_req_duration/ {for(i=1;i<=NF;i++) if($i~/p\(95\)=/) {split($i,a,"="); print a[2]}}' $LATEST_FILE | sed 's/ms//g' | head -1)
          echo "AVG_RESPONSE=$AVG" >> $GITHUB_ENV
          echo "P95_RESPONSE=$P95" >> $GITHUB_ENV

      - name: Create Region Summary
        if: always()
        shell: bash
        run: |
          echo "# $REGION_EMOJI $REGION_LABEL Results" > "region-summary-$REGION_ID.md"
          echo "| Metric | Value |" >> "region-summary-$REGION_ID.md"
          echo "|---|---| " >> "region-summary-$REGION_ID.md"
          echo "| Avg | ${{ env.AVG_RESPONSE }}ms |" >> "region-summary-$REGION_ID.md"
          echo "| P95 | ${{ env.P95_RESPONSE }}ms |" >> "region-summary-$REGION_ID.md"

      - name: Upload Regional Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: region-${{ matrix.region_config.region_id }}-results-${{ env.REPORT_TIMESTAMP }}
          path: |
            results-*.json
            summary-*.json
            output-*.txt
            region-summary-*.md

  # ============================================================
  # REGIONAL ANALYSIS & COMBINED REPORT
  # ============================================================
  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: regional-results
          pattern: region-*-results-*
          merge-multiple: true
          
      - name: Generate Global Analysis Report
        run: |
          echo "# ðŸŒ GLOBAL PERFORMANCE ANALYSIS REPORT" > global-report.md
          echo "## ðŸ“Š Regional Latency Graph" >> global-report.md
          echo "\`\`\`mermaid" >> global-report.md
          echo "barChart" >> global-report.md
          echo "    title Average Response Time (ms)" >> global-report.md
          
          # Gather data for table and graph
          echo "| Region | Avg Response | P95 Response |" >> global-report.md
          echo "|--------|--------------|--------------|" >> global-report.md
          
          for f in regional-results/summary-*.json; do
            RID=$(basename $f | cut -d'-' -f2)
            AVG=$(jq -r '.metrics.http_req_duration.values.avg' $f)
            P95=$(jq -r '.metrics.http_req_duration.values."p(95)"' $f)
            echo "    \"$RID\" : $AVG" >> global-report.md
            echo "| $RID | ${AVG}ms | ${P95}ms |" >> global-report.md
          done
          echo "\`\`\`" >> global-report.md
          cat global-report.md >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # FINAL SUMMARY
  # ============================================================
  final-summary:
    runs-on: ubuntu-latest
    needs: [single-region-test, regional-analysis]
    if: always()
    steps:
      - name: Generate Workflow Summary
        run: |
          echo "# ðŸ PERFORMANCE TESTING WORKFLOW COMPLETE" >> $GITHUB_STEP_SUMMARY
          echo "Mode: ${{ github.event.inputs.execution_mode }}" >> $GITHUB_STEP_SUMMARY
