name: gemini

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options:
          - single-region
          - multi-region
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - spike
          - stress

permissions:
  contents: read
  actions: write
  checks: write
  pages: write
  id-token: write

env:
  K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
  TEST_ENVIRONMENT: production
  REPORT_TIMESTAMP: ${{ github.run_id }}-${{ github.run_attempt }}
  NODE_VERSION: '20'

jobs:
  # ============================================================
  # SINGLE REGION PERFORMANCE TESTING
  # ============================================================
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      REGION: 'us-west'
      REGION_NAME: 'US West (California)'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
        
      - name: Run Performance Tests
        run: |
          set -euo pipefail
          # Map test types to files
          declare -A TESTS=( ["smoke"]="tests/performance/smoke/dummyjson-smoke.js" ["load"]="tests/performance/load/dummyjson-load.js" ["spike"]="tests/performance/spike/dummyjson-spike.js" ["stress"]="tests/performance/stress/dummyjson-stress.js" )
          
          for TEST in smoke load spike stress; do
            if [[ "${{ github.event.inputs.test_type }}" == "all" || "${{ github.event.inputs.test_type }}" == "$TEST" ]]; then
              echo "ðŸš€ Running $TEST..."
              k6 run "${TESTS[$TEST]}" \
                --summary-export="summary-${TEST}.json" \
                --out json="raw-${TEST}.json" > "output-${TEST}.txt"
            fi
          done

      - name: Generate Professional Report
        if: always()
        run: |
          echo "# ðŸ“Š PROFESSIONAL PERFORMANCE REPORT" > report.md
          echo "### ðŸŒ Region: ${{ env.REGION_NAME }} | ðŸ·ï¸ Run: ${{ github.run_id }}" >> report.md
          
          echo "## ðŸ“ˆ Latency Trends (P95)" >> report.md
          echo "\`\`\`mermaid" >> report.md
          echo "graph LR" >> report.md
          
          # Dynamic table generation
          echo "## ðŸ“‹ Detailed Performance Metrics" >> report.md
          echo "| Test Type | Avg Latency | P95 Latency | Req/Sec | Fail Rate |" >> report.md
          echo "|-----------|-------------|-------------|---------|-----------|" >> report.md
          
          for f in summary-*.json; do
            T_NAME=$(echo $f | sed 's/summary-//;s/.json//')
            AVG=$(jq '.metrics.http_req_duration.values.avg' $f)
            P95=$(jq '.metrics.http_req_duration.values."p(95)"' $f)
            RPS=$(jq '.metrics.http_reqs.values.rate' $f)
            ERR=$(jq '.metrics.http_req_failed.values.rate' $f)
            
            echo "| ${T_NAME^^} | ${AVG%.*}ms | ${P95%.*}ms | ${RPS%.*} | ${ERR}% |" >> report.md
            # Add to graph
            echo "    Start --> ${T_NAME^^}(${P95%.*}ms)" >> report.md
          done
          echo "\`\`\`" >> report.md
          
          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: single-region-results-${{ env.REPORT_TIMESTAMP }}
          path: |
            summary-*.json
            output-*.txt
            report.md

  # ============================================================
  # MULTI-REGION PERFORMANCE TESTING
  # ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        region_config:
          - {runner: ubuntu-latest, id: us-west, label: "US West", emoji: "ðŸ‡ºðŸ‡¸"}
          - {runner: windows-latest, id: eu-west, label: "EU West", emoji: "ðŸ‡³ðŸ‡±"}
          - {runner: macos-latest, id: apac-sg, label: "APAC SG", emoji: "ðŸ‡¸ðŸ‡¬"}
      fail-fast: false
    runs-on: ${{ matrix.region_config.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
      
      - name: Run Cross-Platform Test
        shell: bash
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          [[ "$TEST_TYPE" == "all" ]] && EXEC="load" || EXEC="$TEST_TYPE"
          k6 run "tests/performance/$EXEC/dummyjson-$EXEC.js" --summary-export="summary-${{ matrix.region_config.id }}.json"

      - name: Upload Regional Data
        uses: actions/upload-artifact@v4
        with:
          name: raw-data-${{ matrix.region_config.id }}
          path: summary-*.json

  regional-analysis:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests
    steps:
      - name: Download Data
        uses: actions/download-artifact@v4
        with:
          path: data
          merge-multiple: true
      
      - name: Compare Global Regions
        run: |
          echo "# ðŸŒ GLOBAL COMPARISON REPORT" > global.md
          echo "\`\`\`mermaid" >> global.md
          echo "pie title Latency Distribution by Region" >> global.md
          
          echo "| Region | Avg Latency | P95 |" >> global.md
          echo "|--------|-------------|-----|" >> global.md
          
          for f in data/summary-*.json; do
            RID=$(basename $f | sed 's/summary-//;s/.json//')
            AVG=$(jq '.metrics.http_req_duration.values.avg' $f)
            P95=$(jq '.metrics.http_req_duration.values."p(95)"' $f)
            echo "    \"$RID\" : $AVG" >> global.md
            echo "| $RID | ${AVG%.*}ms | ${P95%.*}ms |" >> global.md
          done
          echo "\`\`\`" >> global.md
          cat global.md >> $GITHUB_STEP_SUMMARY
