name: k6 Performance with Graphs

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - 'tests/performance/**'  # Auto-run when test files change

jobs:
  run-test-and-create-graphs:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup k6
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
      
      # 3. [FIXED] Install charting libraries (local install, not global)
      - name: Setup chart tools
        run: |
          npm init -y  # Create package.json if doesn't exist
          npm install chart.js chartjs-node-canvas
      
      # 4. Run the custom k6 test with JSON output
      - name: Run k6 test with custom metrics
        run: |
          k6 run tests/performance/custom-stress.js \
            --out json=k6-results.json \
            --summary-export=k6-summary.json \
            2>&1 | tee k6-output.txt
          
          # Show quick summary
          echo "=== TEST COMPLETE ==="
          echo "Results saved to: k6-results.json"
          echo "Custom metrics recorded: browse_product_time, get_product_detail_time, critical_api_time"
      
      # 5. [FIXED] Generate actual graphs using chart.js (.cjs script)
      - name: Generate performance charts
        run: |
          mkdir -p charts
          
          # Create a CommonJS script (.cjs) to avoid ES module conflict
          cat > generate-charts.cjs << 'EOF'
          const fs = require('fs');
          const { ChartJSNodeCanvas } = require('chartjs-node-canvas');
          
          try {
            const data = JSON.parse(fs.readFileSync('./k6-results.json', 'utf8'));
            const metrics = data.metrics;
            
            async function createChart(config, filename) {
              const width = 800;
              const height = 500;
              const chartJSNodeCanvas = new ChartJSNodeCanvas({ width, height });
              const buffer = await chartJSNodeCanvas.renderToBuffer(config);
              fs.writeFileSync(`./charts/${filename}`, buffer);
            }
            
            // 1. Response Times Chart
            if (metrics.http_req_duration?.values) {
              const values = Object.values(metrics.http_req_duration.values).slice(0, 100);
              await createChart({
                type: 'line',
                data: {
                  labels: values.map((_, i) => i + 1),
                  datasets: [{
                    label: 'Response Time (ms)',
                    data: values,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                  }]
                },
                options: {
                  plugins: { title: { display: true, text: 'Response Times' } }
                }
              }, 'response-times.png');
              console.log('âœ… Generated response-times.png');
            }
            
            // 2. Virtual Users Chart
            if (metrics.vus?.values) {
              const values = Object.values(metrics.vus.values).slice(0, 100);
              await createChart({
                type: 'line',
                data: {
                  labels: values.map((_, i) => i + 1),
                  datasets: [{
                    label: 'Virtual Users',
                    data: values,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    fill: true
                  }]
                },
                options: {
                  plugins: { title: { display: true, text: 'Virtual Users' } }
                }
              }, 'virtual-users.png');
              console.log('âœ… Generated virtual-users.png');
            }
            
            // 3. Custom Metrics Chart
            const customMetricNames = ['browse_product_time', 'get_product_detail_time', 'critical_api_time'];
            const customDatasets = [];
            const colors = ['rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)'];
            
            customMetricNames.forEach((name, index) => {
              if (metrics[name]?.values) {
                const values = Object.values(metrics[name].values).slice(0, 50);
                customDatasets.push({
                  label: name,
                  data: values,
                  borderColor: colors[index],
                  backgroundColor: `${colors[index]}20`,
                  tension: 0.1
                });
              }
            });
            
            if (customDatasets.length > 0) {
              await createChart({
                type: 'line',
                data: {
                  labels: Array.from({length: 50}, (_, i) => i + 1),
                  datasets: customDatasets
                },
                options: {
                  plugins: { title: { display: true, text: 'Custom Metrics' } }
                }
              }, 'custom-metrics.png');
              console.log('âœ… Generated custom-metrics.png');
            }
            
            // 4. Error Rate Chart
            if (metrics.http_req_failed?.values) {
              const values = Object.values(metrics.http_req_failed.values).slice(0, 100);
              await createChart({
                type: 'line',
                data: {
                  labels: values.map((_, i) => i + 1),
                  datasets: [{
                    label: 'Error Rate %',
                    data: values.map(v => v * 100),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)'
                  }]
                },
                options: {
                  scales: { y: { beginAtZero: true } },
                  plugins: { title: { display: true, text: 'Error Rate' } }
                }
              }, 'error-rate.png');
              console.log('âœ… Generated error-rate.png');
            }
            
            console.log('ðŸ“Š All charts generated!');
            
          } catch (error) {
            console.error('Chart generation failed:', error.message);
            // Create a simple text file as fallback
            fs.writeFileSync('./charts/error.txt', `Chart error: ${error.message}`);
            process.exit(1);
          }
          EOF
          
          # Run the chart generation script
          echo "ðŸ“Š Generating charts with chart.js..."
          node generate-charts.cjs
          
          echo "âœ… Charts in ./charts/:"
          ls -la charts/
      
      # 6. [FIXED] Create test report - updated for GitHub compatibility
      - name: Create test report with graphs
        run: |
          echo "# ðŸ“ˆ k6 Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show test summary from k6 output
          if [ -f "k6-output.txt" ]; then
            echo "## ðŸ“‹ Test Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Status: $(grep -q 'âŒ' k6-output.txt && echo 'FAILED' || echo 'PASSED')" >> $GITHUB_STEP_SUMMARY
            grep -E "checks.*%|http_req_duration.*p\(95\)" k6-output.txt | head -5 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Chart information - GitHub can't embed images directly in summary
          echo "## ðŸ“Š Performance Charts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the **k6-performance-results** artifact to view all charts:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List generated charts
          if [ -f "charts/response-times.png" ]; then
            echo "âœ… **response-times.png** - HTTP response times" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "charts/virtual-users.png" ]; then
            echo "âœ… **virtual-users.png** - Virtual user count" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "charts/custom-metrics.png" ]; then
            echo "âœ… **custom-metrics.png** - Custom metrics (browse_product_time, etc.)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "charts/error-rate.png" ]; then
            echo "âœ… **error-rate.png** - Error rate percentage" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quick metrics from k6-summary.json:**" >> $GITHUB_STEP_SUMMARY
          if [ -f "k6-summary.json" ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            # Extract key metrics from summary
            grep -A5 '"http_req_duration"' k6-summary.json | head -10 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No detailed metrics found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Charts generated using Chart.js from k6 test data*" >> $GITHUB_STEP_SUMMARY
      
      # 7. [UPDATED] Save everything as artifacts with correct paths
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: |
            k6-results.json
            k6-summary.json
            k6-output.txt
            charts/
            generate-charts.cjs
          retention-days: 30
