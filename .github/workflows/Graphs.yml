name: k6 Performance with Graphs

on:
  workflow_dispatch:
  push:
    paths:
      - 'tests/performance/**'

jobs:
  run-test-and-create-graphs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Setup chart tools
        run: |
          npm init -y
          npm install chart.js chartjs-node-canvas

      - name: Run k6 test with custom metrics
        run: |
          k6 run tests/performance/custom-stress.js \
            --out json=k6-results.json \
            --summary-export=k6-summary.json \
            2>&1 | tee k6-output.txt

      - name: Generate performance charts
        run: |
          mkdir -p charts

          cat > generate-charts.cjs << 'EOF'
          const fs = require('fs');
          const { ChartJSNodeCanvas } = require('chartjs-node-canvas');

          (async () => {
            try {
              const data = JSON.parse(fs.readFileSync('./k6-results.json', 'utf8'));
              const metrics = data.metrics;

              async function createChart(config, filename) {
                const chartJSNodeCanvas = new ChartJSNodeCanvas({
                  width: 800,
                  height: 500
                });
                const buffer = await chartJSNodeCanvas.renderToBuffer(config);
                fs.writeFileSync(`./charts/${filename}`, buffer);
              }

              // Response time
              if (metrics.http_req_duration?.values) {
                const values = Object.values(metrics.http_req_duration.values).slice(0, 100);
                await createChart({
                  type: 'line',
                  data: {
                    labels: values.map((_, i) => i + 1),
                    datasets: [{
                      label: 'Response Time (ms)',
                      data: values,
                      borderColor: 'rgb(75, 192, 192)',
                      tension: 0.1
                    }]
                  }
                }, 'response-times.png');
              }

              // Virtual users
              if (metrics.vus?.values) {
                const values = Object.values(metrics.vus.values).slice(0, 100);
                await createChart({
                  type: 'line',
                  data: {
                    labels: values.map((_, i) => i + 1),
                    datasets: [{
                      label: 'Virtual Users',
                      data: values,
                      borderColor: 'rgb(255, 159, 64)'
                    }]
                  }
                }, 'virtual-users.png');
              }

              // Custom metrics
              const customMetrics = [
                'browse_product_time',
                'get_product_detail_time',
                'critical_api_time'
              ];

              const datasets = customMetrics
                .filter(m => metrics[m]?.values)
                .map((m, i) => ({
                  label: m,
                  data: Object.values(metrics[m].values).slice(0, 50),
                  borderColor: ['red', 'blue', 'orange'][i],
                  tension: 0.1
                }));

              if (datasets.length) {
                await createChart({
                  type: 'line',
                  data: {
                    labels: datasets[0].data.map((_, i) => i + 1),
                    datasets
                  }
                }, 'custom-metrics.png');
              }

              console.log('ðŸ“Š Charts generated successfully');
            } catch (err) {
              console.error('Chart generation failed:', err);
              process.exit(1);
            }
          })();
          EOF

          node generate-charts.cjs
          ls -la charts/

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: |
            k6-results.json
            k6-summary.json
            k6-output.txt
            charts/
            generate-charts.cjs
