name: k6 Performance with Graphs

on:
  workflow_dispatch:
  push:
    paths:
      - 'tests/performance/**'

jobs:
  run-test-and-create-graphs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Setup chart tools
        run: |
          npm init -y
          npm install chart.js chartjs-node-canvas

      - name: Run k6 test
        run: |
          k6 run tests/performance/custom-stress.js \
            --out json=k6-results.json \
            --summary-export=k6-summary.json \
            2>&1 | tee k6-output.txt

      - name: Generate performance charts (FIXED)
        run: |
          mkdir -p charts

          cat > generate-charts.cjs << 'EOF'
          const fs = require('fs');
          const { ChartJSNodeCanvas } = require('chartjs-node-canvas');

          (async () => {
            try {
              // ✅ USE SUMMARY FILE (valid JSON)
              const summary = JSON.parse(
                fs.readFileSync('./k6-summary.json', 'utf8')
              );

              const http = summary.metrics.http_req_duration.values;

              const canvas = new ChartJSNodeCanvas({
                width: 900,
                height: 500
              });

              // -------------------------------
              // p90 / p95 percentile chart
              // -------------------------------
              const image = await canvas.renderToBuffer({
                type: 'bar',
                data: {
                  labels: ['p90', 'p95'],
                  datasets: [{
                    label: 'HTTP Request Duration (ms)',
                    data: [http['p(90)'], http['p(95)']],
                    backgroundColor: ['#36a2eb', '#ff6384']
                  }]
                },
                options: {
                  plugins: {
                    title: {
                      display: true,
                      text: 'HTTP Latency Percentiles'
                    }
                  }
                }
              });

              fs.writeFileSync('charts/http-percentiles.png', image);

              console.log('✅ Percentile chart generated');
            } catch (err) {
              console.error('❌ Chart generation failed:', err.message);
              process.exit(1);
            }
          })();
          EOF

          node generate-charts.cjs
          ls -la charts/

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: |
            k6-results.json
            k6-summary.json
            k6-output.txt
            charts/
            generate-charts.cjs
