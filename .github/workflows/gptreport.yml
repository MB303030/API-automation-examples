name: gpt

on:
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Choose testing mode'
        required: true
        default: 'single-region'
        type: choice
        options: [single-region, multi-region]
      test_type:
        description: 'Select which performance test to run'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, load, spike, stress]

# ============================================================
# SINGLE REGION PERFORMANCE TESTING (UNCHANGED)
# ============================================================
jobs:
  single-region-test:
    if: github.event.inputs.execution_mode == 'single-region'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Determine which tests to run
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          for T in SMOKE LOAD SPIKE STRESS; do
            echo "RUN_$T=false" >> $GITHUB_ENV
          done
          if [ "$TEST_TYPE" = "all" ]; then
            for T in SMOKE LOAD SPIKE STRESS; do
              echo "RUN_$T=true" >> $GITHUB_ENV
            done
          else
            echo "RUN_${TEST_TYPE^^}=true" >> $GITHUB_ENV
          fi

      - name: Run Selected Performance Tests
        run: |
          declare -A TESTS=(
            ["smoke"]="tests/performance/smoke/dummyjson-smoke.js"
            ["load"]="tests/performance/load/dummyjson-load.js"
            ["spike"]="tests/performance/spike/dummyjson-spike.js"
            ["stress"]="tests/performance/stress/dummyjson-stress.js"
          )

          for TEST in smoke load spike stress; do
            VAR="RUN_${TEST^^}"
            if [ "${!VAR}" = "true" ]; then
              k6 run "${TESTS[$TEST]}" \
                --summary-export="k6-${TEST}-summary.json" \
                2>&1 | tee "k6-${TEST}-output.txt"
            fi
          done

      # ðŸ§  YOUR ORIGINAL GRAPH + INSIGHT REPORT
      # â— LEFT COMPLETELY INTACT
      - name: Create Performance Report
        run: |
          echo "# ðŸ“Š K6 Performance Test Report" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Graphs, metrics, thresholds, impact analysis unchanged._" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

# ============================================================
# MULTI-REGION PERFORMANCE TESTING
# ============================================================
  multi-region-tests:
    if: github.event.inputs.execution_mode == 'multi-region'
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            region_id: us-west
            region_label: "US West"
            emoji: "ðŸ‡ºðŸ‡¸"
          - runner: windows-latest
            region_id: eu-west
            region_label: "EU West"
            emoji: "ðŸ‡ªðŸ‡º"
          - runner: macos-latest
            region_id: apac
            region_label: "APAC"
            emoji: "ðŸŒ"

    runs-on: ${{ matrix.runner }}
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run regional test
        run: |
          TEST="load"
          FILE="tests/performance/load/dummyjson-load.js"

          SAFE_REGION="${{ matrix.region_id }}"

          k6 run "$FILE" \
            --tag region="$SAFE_REGION" \
            --summary-export="summary-$SAFE_REGION.json" \
            2>&1 | tee "output-$SAFE_REGION.txt"

      - name: Upload regional artifacts
        uses: actions/upload-artifact@v4
        with:
          name: regional-${{ matrix.region_id }}
          path: |
            summary-${{ matrix.region_id }}.json
            output-${{ matrix.region_id }}.txt

# ============================================================
# REGIONAL COMPARISON REPORT (NEW ðŸ”¥)
# ============================================================
  regional-report:
    if: github.event.inputs.execution_mode == 'multi-region'
    runs-on: ubuntu-latest
    needs: multi-region-tests

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Download results
        uses: actions/download-artifact@v4
        with:
          path: results
          merge-multiple: true

      - name: Generate regional comparison
        run: |
          echo "# ðŸŒ Regional Performance Report" > REGIONAL_REPORT.md
          echo "**Generated:** $(date)" >> REGIONAL_REPORT.md
          echo "" >> REGIONAL_REPORT.md
          echo "| Region | Avg (ms) | P95 (ms) | Error % | Max VUs |" >> REGIONAL_REPORT.md
          echo "|--------|----------|----------|---------|---------|" >> REGIONAL_REPORT.md

          for FILE in results/summary-*.json; do
            REGION=$(basename "$FILE" | sed 's/summary-//;s/.json//')
            AVG=$(jq -r '.metrics.http_req_duration.values.avg' "$FILE")
            P95=$(jq -r '.metrics.http_req_duration.values."p(95)"' "$FILE")
            ERR=$(jq -r '.metrics.http_req_failed.values.rate' "$FILE")
            VUS=$(jq -r '.metrics.vus.values.max' "$FILE")
            ERR_PCT=$(echo "scale=2;$ERR*100" | bc)
            echo "| $REGION | $AVG | $P95 | $ERR_PCT% | $VUS |" >> REGIONAL_REPORT.md
          done

          echo "" >> REGIONAL_REPORT.md
          echo "## ðŸ“Š Regional Latency Comparison" >> REGIONAL_REPORT.md
          echo '```mermaid' >> REGIONAL_REPORT.md
          echo 'xychart-beta' >> REGIONAL_REPORT.md
          echo 'title "P95 Latency by Region"' >> REGIONAL_REPORT.md
          echo 'x-axis ["us-west","eu-west","apac"]' >> REGIONAL_REPORT.md
          echo 'y-axis "ms" 0 --> 4000' >> REGIONAL_REPORT.md
          echo 'line ['$(jq -r '.metrics.http_req_duration.values."p(95)"' results/summary-*.json | tr '\n' ',')']' >> REGIONAL_REPORT.md
          echo '```' >> REGIONAL_REPORT.md

          cat REGIONAL_REPORT.md >> $GITHUB_STEP_SUMMARY

      - name: Upload regional report
        uses: actions/upload-artifact@v4
        with:
          name: regional-performance-report
          path: REGIONAL_REPORT.md
