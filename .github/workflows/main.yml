name: API CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright (CI minimal)
      run: npx playwright install chromium

    - name: ðŸ”§ Setup API environment variables
      run: |
        echo "API_KEY=ci-test-key-${{ github.run_id }}" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://template.postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: ðŸ§ª Run API tests with CI config
      id: run-tests
      run: |
        echo "Running API tests with CI configuration..."
        echo "Using config: playwright.ci.config.js"
        
        # Run tests and capture exit code
        set +e  # Don't exit on error
        npx playwright test --config=playwright.ci.config.js
        TEST_EXIT_CODE=$?
        set -e  # Restore exit on error
        
        echo "Playwright exit code: $TEST_EXIT_CODE"
        echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Simple test file count (optional)
        echo "Test files found:"
        find tests -name "*.spec.js" | wc -l

    - name: ðŸ“Š Generate simple test summary
      if: always()
      run: |
        echo "## ðŸ§ª API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Simple status based on exit code
        if [ "${{ steps.run-tests.outputs.exit_code }}" = "0" ]; then
          echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Available Reports" >> $GITHUB_STEP_SUMMARY
        echo "- **Playwright HTML Report**: Download 'ci-test-artifacts' artifact and open `index.html`" >> $GITHUB_STEP_SUMMARY
        echo "- **JUnit Results**: For CI integration" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“¤ Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ci-test-artifacts
        path: |
          playwright-report/
          test-results/
        retention-days: 30

    - name: ðŸš¨ Upload JUnit test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: junit-results
        path: test-results/junit.xml
        retention-days: 30
