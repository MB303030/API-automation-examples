name: Enhanced Nightly Tests

on:
  schedule:
    # Adjust timezone and time (this runs at 11 PM UTC, which is 6 PM EST)
    - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      testType:
        description: 'Type of tests to run'
        required: false
        default: 'all'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npx playwright install --with-deps chromium
    
    - name: Run tests
      id: tests
      run: |
        # Run tests and capture exit code
        npx playwright test --reporter=html,json,junit || true
        TEST_EXIT_CODE=$?
        echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Count test results
        if [ -f test-results.json ]; then
          PASSED=$(jq '.stats.passed // 0' test-results.json)
          FAILED=$(jq '.stats.failed // 0' test-results.json)
          SKIPPED=$(jq '.stats.skipped // 0' test-results.json)
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        fi
    
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          playwright-report/
          test-results.json
          test-results.xml
    
    - name: Deploy HTML report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./playwright-report
        keep_files: false
    
    - name: Send detailed email report
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        secure: true
        to: mbrakaz@gmail.com
        subject: "[${{ job.status }}] Nightly Tests: ${{ steps.tests.outputs.passed || 0 }} passed, ${{ steps.tests.outputs.failed || 0 }} failed"
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .success { color: green; }
              .failure { color: red; }
              .card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
            </style>
          </head>
          <body>
            <h2>üöÄ Nightly Test Report</h2>
            
            <div class="card">
              <h3>Summary</h3>
              <p><strong>Repository:</strong> ${{ github.repository }}</p>
              <p><strong>Status:</strong> <span class="${{ job.status == 'success' && 'success' || 'failure' }}">${{ job.status | upper }}</span></p>
              <p><strong>Test Results:</strong> ‚úÖ ${{ steps.tests.outputs.passed || 0 }} passed | ‚ùå ${{ steps.tests.outputs.failed || 0 }} failed | ‚è≠Ô∏è ${{ steps.tests.outputs.skipped || 0 }} skipped</p>
              <p><strong>Run ID:</strong> ${{ github.run_id }}</p>
              <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            </div>
            
            <div class="card">
              <h3>üìä Reports</h3>
              <ul>
                <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions Run</a></li>
                <li><a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/">HTML Test Report</a></li>
                <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">Download Artifacts</a></li>
              </ul>
            </div>
            
            <div class="card">
              <h3>üìÖ Schedule Info</h3>
              <p>This test runs daily at 11 PM UTC (6 PM EST)</p>
              <p>Next run: Approximately 24 hours from now</p>
            </div>
            
            <hr>
            <p><em>This is an automated report from GitHub Actions.</em></p>
          </body>
          </html>
