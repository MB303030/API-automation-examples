name: API CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Job 1: Functional API tests with Playwright
  playwright-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright
      run: npx playwright install chromium

    - name: ðŸ”§ Setup API environment variables
      run: |
        echo "API_KEY=test-key-${{ github.run_id }}" >> $GITHUB_ENV
        echo "API_PET_BASE=https://petstore.swagger.io/v2" >> $GITHUB_ENV
        echo "API_POSTMAN_BASE=https://template.postman-echo.com" >> $GITHUB_ENV
        echo "API_DUMMYJSON_BASE=https://dummyjson.com" >> $GITHUB_ENV

    - name: ðŸ§ª Run Playwright API tests
      run: npx playwright test

    - name: ðŸ“¤ Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-api-report
        path: playwright-report/
        retention-days: 7

  # Job 2: Docker setup check (for K6)
  docker-check:
    runs-on: ubuntu-latest
    needs: playwright-tests  # Run after functional tests pass
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Verify Docker installation
      run: |
        echo "Checking Docker availability..."
        which docker || echo "Docker not found in PATH"
        docker --version
        echo "Docker check complete"

  # Job 3: K6 Load tests (optional - runs on schedule or manual trigger)
  k6-load-tests:
    runs-on: ubuntu-latest
    needs: docker-check
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Run K6 load test
      uses: grafana/k6-action@v0.3.1
      with:
        filename: tests/load/dummyjson-load-test.js
        flags: --out json=test-results/k6-results.json
      
    - name: ðŸ“Š Generate K6 report
      if: always()
      run: |
        echo "## ðŸ“ˆ K6 Load Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "test-results/k6-results.json" ]; then
          echo "### Load test completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results saved to: test-results/k6-results.json" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ No K6 results found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“¤ Upload K6 results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-load-test-results
        path: test-results/k6-results.json
        retention-days: 30
